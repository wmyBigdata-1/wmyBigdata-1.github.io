<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Flink1.12内核源码解析, HTML,CSS,JavaScript,JQuery,java,linux">
    <meta name="description" content="本网址是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的嘘唏旅途中，走出自己的风景。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Flink1.12内核源码解析 | 情深骚明&amp;博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>
    <script src="http://echarts.baidu.com/dist/echarts.common.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">情深骚明&amp;博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">情深骚明&amp;博客</div>
        <div class="logo-desc">
            
            本网址是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的嘘唏旅途中，走出自己的风景。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Flink1.12内核源码解析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/flink/">
                                <span class="chip bg-color">flink</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/flink/" class="post-category">
                                flink
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2021-07-12
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="flink1-12-X内核源码解析"><a href="#flink1-12-X内核源码解析" class="headerlink" title="flink1.12.X内核源码解析"></a>flink1.12.X内核源码解析</h1><h2 id="1、内核源码介绍"><a href="#1、内核源码介绍" class="headerlink" title="1、内核源码介绍"></a>1、内核源码介绍</h2><h3 id="1-1-任务提交流程"><a href="#1-1-任务提交流程" class="headerlink" title="1.1 任务提交流程"></a>1.1 任务提交流程</h3><ul>
<li>命令行提交任务</li>
<li>20多个步骤、几十个类、数千行代码、关键源码加上注释</li>
<li>16个小节</li>
<li>PPT动图</li>
</ul>
<h3 id="1-2-组件通信"><a href="#1-2-组件通信" class="headerlink" title="1.2 组件通信"></a>1.2 组件通信</h3><ul>
<li>actor模型、Akka基本原理和实现</li>
<li>5大关键角色：代理转发、处理细节</li>
<li>PPT动图</li>
</ul>
<h3 id="1-3-任务调度"><a href="#1-3-任务调度" class="headerlink" title="1.3 任务调度"></a>1.3 任务调度</h3><ul>
<li>图：流图、作业图、执行图、物理执行图（Spark DAG）生成逻辑分析</li>
<li>调用位置、如何转换和生成（构造）</li>
<li>Task调度过程中：调度器、调度策略、调度模式</li>
<li>Task执行：Map算子为例</li>
</ul>
<h3 id="1-4-内存管理"><a href="#1-4-内存管理" class="headerlink" title="1.4 内存管理"></a>1.4 内存管理</h3><ul>
<li>Flink在1.10内存管理模型：Jobmanager、TaskManager、内存分配过程、数据结构、内存管理器和网络传输</li>
<li>反压</li>
</ul>
<h3 id="1-5-收获"><a href="#1-5-收获" class="headerlink" title="1.5 收获"></a>1.5 收获</h3><ul>
<li>数千行代码、几百次跳转</li>
<li>详细过程和总结性图</li>
</ul>
<h2 id="2、流程图"><a href="#2、流程图" class="headerlink" title="2、流程图"></a>2、流程图</h2><h3 id="2-1-Yarn-per-job模式提交流程"><a href="#2-1-Yarn-per-job模式提交流程" class="headerlink" title="2.1 Yarn-per-job模式提交流程"></a>2.1 Yarn-per-job模式提交流程</h3><p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210712070048745.png" alt="Yarn-per-job模式提交流程"></p>
<h3 id="2-2-Flink-通讯过程"><a href="#2-2-Flink-通讯过程" class="headerlink" title="2.2  Flink 通讯过程"></a>2.2  Flink 通讯过程</h3><p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210713100225257.png" alt="Flink组件通讯过程"></p>
<h3 id="2-3-Task-调度"><a href="#2-3-Task-调度" class="headerlink" title="2.3 Task 调度"></a>2.3 Task 调度</h3><p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210713100335332.png" alt="执行图"></p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210713100457196.png" alt="物理执行图"></p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210713100531260.png" alt="Task任务调度"></p>
<h3 id="2-4-内存模型"><a href="#2-4-内存模型" class="headerlink" title="2.4 内存模型"></a>2.4 内存模型</h3><p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210713100558694.png" alt="Flink内存模型"></p>
<h2 id="3、任务提交流程"><a href="#3、任务提交流程" class="headerlink" title="3、任务提交流程"></a>3、任务提交流程</h2><h3 id="3-1-Flink提交流程总结"><a href="#3-1-Flink提交流程总结" class="headerlink" title="3.1 Flink提交流程总结"></a>3.1 Flink提交流程总结</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">提交命令：flink</span> <span class="string">run -t yarn-pre-job -c XXX XXX.jar</span></span><br><span class="line"></span><br><span class="line"><span class="attr">CliFrontend</span></span><br><span class="line">	<span class="attr">参数解析：</span></span><br><span class="line">		<span class="meta">封装了CommandLine</span> <span class="string">---&gt; 三个，依次添加（Genric、Yarn、Default）</span></span><br><span class="line">		<span class="attr">配置的封装</span></span><br><span class="line">		<span class="meta">执行用户代码</span> <span class="string">---&gt; execute()</span></span><br><span class="line">		<span class="attr">Executor</span> <span class="string">---&gt; 从流图生成作业图</span></span><br><span class="line">		<span class="meta">集群描述器</span> <span class="string">---&gt; 上传jar包、配置、封装提交给yarn的命令</span></span><br><span class="line">		<span class="attr">yarnClient提交应用</span></span><br><span class="line"></span><br><span class="line"><span class="attr">YarnJobClusterEntryPoint：ApplicationMaster的入口类</span></span><br><span class="line">	<span class="attr">1、Dispatcher的创建和启动</span></span><br><span class="line">	<span class="meta">2、YarnResourceManager的创建、启动</span> <span class="string">---&gt; slotManager（管理资源、向ResourceManager申请资源）</span></span><br><span class="line">	<span class="meta">3、Dispatcher启动JobMaster</span> <span class="string">---&gt; 生成ExecutionGraph（slotPool，真正去发送请求）</span></span><br><span class="line">	<span class="meta">4、slotPool向slotManager申请资源，slotManager向yarn的Resource</span> <span class="string">Manager申请资源（启动新节点TaskManager）</span></span><br><span class="line">	</span><br><span class="line"><span class="attr">YarnTaskExecutorRunner：Yarn模式下的TaskManager的入口类</span></span><br><span class="line">	<span class="attr">1、启动TaskExecutor</span></span><br><span class="line">	<span class="attr">2、向ResourceManager注册slot</span></span><br><span class="line">	<span class="attr">3、ResourceManager分配slot</span></span><br><span class="line">	<span class="attr">4、TaskExecutor接收到分配的指令，提供offset给JobMaster（slotPool）</span></span><br><span class="line">	<span class="attr">5、JobMaster提交任务给TaskExecutor去执行</span></span><br></pre></td></tr></tbody></table></figure>



<h2 id="4、组件通信"><a href="#4、组件通信" class="headerlink" title="4、组件通信"></a>4、组件通信</h2><h2 id="5、任务调度"><a href="#5、任务调度" class="headerlink" title="5、任务调度"></a>5、任务调度</h2><h3 id="5-1-调度作业图"><a href="#5-1-调度作业图" class="headerlink" title="5.1 调度作业图"></a>5.1 调度作业图</h3><p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715090511666.png" alt="调度作业图"></p>
<h3 id="5-2-Graph-的概念"><a href="#5-2-Graph-的概念" class="headerlink" title="5.2 Graph 的概念"></a>5.2 Graph 的概念</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Flink</span> <span class="string">中的执行图可以分成四层：StreamGraph -&gt; JobGraph -&gt; ExecutionGraph -&gt; 物理执</span></span><br><span class="line"><span class="attr">行图。</span></span><br><span class="line"><span class="meta">StreamGraph：是根据用户通过</span> <span class="string">Stream API 编写的代码生成的最初的图。用来表示程序</span></span><br><span class="line"><span class="attr">的拓扑结构。</span></span><br><span class="line"><span class="meta">JobGraph：StreamGraph</span> <span class="string">经过优化后生成了 JobGraph，提交给 JobManager 的数据结构。</span></span><br><span class="line"><span class="meta">主要的优化为，将多个符合条件的节点</span> <span class="string">chain 在一起作为一个节点，这样可以减少数据在节</span></span><br><span class="line"><span class="attr">点之间流动所需要的序列化/反序列化/传输消耗。</span></span><br><span class="line"><span class="meta">ExecutionGraph：JobManager</span> <span class="string">根据 JobGraph 生成 ExecutionGraph。ExecutionGraph 是</span></span><br><span class="line"><span class="attr">JobGraph</span> <span class="string">的并行化版本，是调度层最核心的数据结构。物理执行图 ： JobManager根据Execution Graph对Job进行调度后，在各个TaskManager 上部署 Task 后形成的“图”，并不是一个具体的数据结构。</span></span><br></pre></td></tr></tbody></table></figure>

<p>例如 example 里的 SocketTextStreamWordCount 并发度为 2（Source 为 1 个并发度）的 四层执行图的演变过程如下图所示：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="comment">// 检查输入</span></span><br><span class="line"> <span class="keyword">final</span> ParameterTool params = ParameterTool.fromArgs(args);</span><br><span class="line"> ...</span><br><span class="line"> <span class="comment">// set up the execution environment</span></span><br><span class="line"> <span class="keyword">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"> <span class="comment">// get input data</span></span><br><span class="line"> DataStream&lt;String&gt; text =</span><br><span class="line"> env.socketTextStream(params.get(<span class="string">"hostname"</span>), params.getInt(<span class="string">"port"</span>), <span class="string">'\n'</span>, <span class="number">0</span>);</span><br><span class="line"> DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; counts =</span><br><span class="line"> <span class="comment">// split up the lines in pairs (2-tuples) containing: (word,1)</span></span><br><span class="line"> text.flatMap(<span class="keyword">new</span> Tokenizer())</span><br><span class="line"> <span class="comment">// group by the tuple field "0" and sum up tuple field "1"</span></span><br><span class="line"> .keyBy(<span class="number">0</span>)</span><br><span class="line"> .sum(<span class="number">1</span>);</span><br><span class="line"> counts.print();</span><br><span class="line"></span><br><span class="line"> <span class="comment">// execute program</span></span><br><span class="line"> env.execute(<span class="string">"WordCount from SocketTextStream Example"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715090748157.png" alt="流图和作业图"></p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715090820151.png" alt="执行图"></p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715090840014.png" alt="物理执行图"></p>
<h4 id="5-2-1-名词解释"><a href="#5-2-1-名词解释" class="headerlink" title="5.2.1 名词解释"></a>5.2.1 名词解释</h4><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">1）StreamGraph：根据用户通过</span> <span class="string">Stream API 编写的代码生成的最初的图。</span></span><br><span class="line">	<span class="meta">（1）StreamNode：用来代表</span> <span class="string">operator 的类，并具有所有相关的属性，如并发度、入边</span></span><br><span class="line"><span class="attr">和出边等。</span></span><br><span class="line">	<span class="meta">（2）StreamEdge：表示连接两个</span> <span class="string">StreamNode 的边。</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">2）JobGraph：StreamGraph</span> <span class="string">经过优化后生成了 JobGraph，提交给 JobManager 的数据</span></span><br><span class="line"><span class="attr">结构。</span></span><br><span class="line">	<span class="meta">（1）JobVertex：经过优化后符合条件的多个</span> <span class="string">StreamNode 可能会 chain 在一起生成一个</span></span><br><span class="line"><span class="meta">JobVertex，即一个</span> <span class="string">JobVertex 包含一个或多个 operator，JobVertex 的输入是 JobEdge，输出是IntermediateDataSet。</span></span><br><span class="line">	<span class="meta">（2）IntermediateDataSet：表示</span> <span class="string">JobVertex 的输出，即经过 operator 处理产生的数据集。producer 是 JobVertex，consumer 是 JobEdge。</span></span><br><span class="line">	<span class="meta">（3）JobEdge：代表了</span> <span class="string">job graph 中的一条数据传输通道。source 是 Intermediate DataSet，target 是 JobVertex。即数据通过 JobEdge 由 IntermediateDataSet 传递给目标 JobVertex。</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">3）ExecutionGraph：JobManager</span> <span class="string">根据 JobGraph 生成 ExecutionGraph。ExecutionGraph</span></span><br><span class="line"><span class="meta">是</span> <span class="string">JobGraph 的并行化版本，是调度层最核心的数据结构。</span></span><br><span class="line">	<span class="meta">（</span> <span class="string">1 ） ExecutionJobVertex ： 和 JobGraph 中 的 JobVertex 一 一 对 应 。 每 一 个ExecutionJobVertex 都有和并发度一样多的 ExecutionVertex。</span></span><br><span class="line">	<span class="meta">（2）ExecutionVertex：表示</span> <span class="string">ExecutionJobVertex 的其中一个并发子任务，输入是</span></span><br><span class="line"><span class="meta">ExecutionEdge，输出是</span> <span class="string">IntermediateResultPartition。</span></span><br><span class="line">	<span class="meta">（3）IntermediateResult：和</span> <span class="string">JobGraph 中的 IntermediateDataSet 一一对应。一个</span></span><br><span class="line"><span class="attr">IntermediateResult</span> <span class="string">包含多个 IntermediateResultPartition，其个数等于该 operator 的并发度。</span></span><br><span class="line">	<span class="meta">（4）IntermediateResultPartition：表示</span> <span class="string">ExecutionVertex 的一个输出分区，producer 是ExecutionVertex，consumer 是若干个 ExecutionEdge。</span></span><br><span class="line">	<span class="meta">（5）ExecutionEdge：表示</span> <span class="string">ExecutionVertex 的输入，source 是 Intermediate ResultPartition，target 是 ExecutionVertex。source 和 target 都只能是一个。</span></span><br><span class="line">	<span class="meta">（6）Execution：是执行一个</span> <span class="string">ExecutionVertex 的一次尝试。当发生故障或者数据需要重</span></span><br><span class="line"><span class="meta">算的情况下</span> <span class="string">ExecutionVertex 可能会有多个 ExecutionAttemptID。一个 Execution 通过</span></span><br><span class="line"><span class="attr">ExecutionAttemptID</span> <span class="string">来唯一标识。JM 和 TM 之间关于 task 的部署和 task status 的更新都是通过 ExecutionAttemptID 来确定消息接受者。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">从这些基本概念中，也可以看出以下⼀点：</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">由于每个 JobVertex 可能有多个 IntermediateDataSet，所以每个 Execution JobVertex可能有多个 IntermediateResult，因此，每个 ExecutionVertex 也可能会包含多个IntermediateResultPartition；</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">ExecutionEdge 这里主要的作⼀是把 ExecutionVertex 和 Intermediate ResultPartition连接起来，表示它们之间的连接关系。</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">4）物理执行图：JobManager</span> <span class="string">根据 ExecutionGraph 对 Job 进行调度后，在各个 TaskManager 上部署 Task 后形成的“图”，并不是一个具体的数据结构。</span></span><br><span class="line">	<span class="meta">（1）Task：Execution</span> <span class="string">被调度后在分配的 TaskManager 中启动对应的 Task。Task 包裹</span></span><br><span class="line"><span class="meta">了具有用户执行逻辑的</span> <span class="string">operator。</span></span><br><span class="line">	<span class="meta">（2）ResultPartition：代表由一个</span> <span class="string">Task 的生成的数据，和 ExecutionGraph 中的</span></span><br><span class="line"><span class="attr">IntermediateResultPartition</span> <span class="string">一一对应。</span></span><br><span class="line">	<span class="meta">（3）ResultSubpartition：是</span> <span class="string">ResultPartition 的一个子分区。每个 ResultPartition 包含多个</span></span><br><span class="line"><span class="meta">ResultSubpartition，其数目要由下游消费</span> <span class="string">Task 数和 DistributionPattern 来决定。</span></span><br><span class="line">	<span class="meta">（4）InputGate：代表</span> <span class="string">Task 的输入封装，和 JobGraph 中 JobEdge 一一对应。每个 InputGate消费了一个或多个的 ResultPartition。</span></span><br><span class="line">	<span class="meta">（5）InputChannel：每个</span> <span class="string">InputGate 会包含一个以上的 InputChannel，和 Execution Graph中的 ExecutionEdge 一一对应，也和 ResultSubpartition 一对一地相连，即一个 InputChannel接收一个 ResultSubpartition 的输出。</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-3-StreamGraph-在-Client-生成"><a href="#5-3-StreamGraph-在-Client-生成" class="headerlink" title="5.3  StreamGraph 在 Client 生成"></a>5.3  StreamGraph 在 Client 生成</h3><p>调用用户代码中的</p>
<p> StreamExecutionEnvironment.execute() </p>
<p>​    -&gt; execute(getJobName())</p>
<p>​     -&gt; execute(getStreamGraph(jobName)) </p>
<p>​    -&gt; getStreamGraph(jobName, true)</p>
<p>StreamExecutionEnvironment.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StreamGraph <span class="title">getStreamGraph</span><span class="params">(String jobName, <span class="keyword">boolean</span> clearTransformations)</span> </span>{</span><br><span class="line">    StreamGraph streamGraph = getStreamGraphGenerator().setJobName(jobName).generate();</span><br><span class="line">    <span class="keyword">if</span> (clearTransformations) {</span><br><span class="line">        <span class="keyword">this</span>.transformations.clear();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> streamGraph;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO 生成器</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> StreamGraph <span class="title">generate</span><span class="params">()</span> </span>{</span><br><span class="line">    streamGraph = <span class="keyword">new</span> StreamGraph(executionConfig, checkpointConfig, savepointRestoreSettings);</span><br><span class="line">    shouldExecuteInBatchMode = shouldExecuteInBatchMode(runtimeExecutionMode);</span><br><span class="line">    configureStreamGraph(streamGraph);</span><br><span class="line"></span><br><span class="line">    alreadyTransformed = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*TODO transformations是一个list，依次存放了 用户代码里的 算子*/</span></span><br><span class="line">    <span class="keyword">for</span> (Transformation&lt;?&gt; transformation: transformations) {</span><br><span class="line">        transform(transformation);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> StreamGraph builtStreamGraph = streamGraph;</span><br><span class="line"></span><br><span class="line">    alreadyTransformed.clear();</span><br><span class="line">    alreadyTransformed = <span class="keyword">null</span>;</span><br><span class="line">    streamGraph = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> builtStreamGraph;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">一个关键的参数是</span> <span class="string">List&lt;Transformation&lt;?&gt;&gt; transformations。Transformation 代表了从一个或多个 DataStream 生成新 DataStream 的操作。DataStream 的底层其实就是一个</span></span><br><span class="line"><span class="meta">Transformation，描述了这个</span> <span class="string">DataStream 是怎么来的。DataStream 上常见transformation 有 map、flatmap、filter 等。这些 transformation 会构造出一棵 StreamTransformation 树，通过这棵树转换成 StreamGraph。以 map 为例，分析List&lt;Transformation&lt;?&gt;&gt; transformations 的数据：</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>DataStream.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">SingleOutputStreamOperator&lt;R&gt; <span class="title">map</span><span class="params">(MapFunction&lt;T, R&gt; mapper)</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 通过 java reflection 抽出 mapper 的返回值类型</span></span><br><span class="line">    TypeInformation&lt;R&gt; outType = TypeExtractor.getMapReturnTypes(clean(mapper), getType(),</span><br><span class="line">                                                                 Utils.getCallLocationName(), <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map(mapper, outType);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">SingleOutputStreamOperator&lt;R&gt; <span class="title">map</span><span class="params">(MapFunction&lt;T, R&gt; mapper, TypeInformation&lt;R&gt; outputType)</span> </span>{</span><br><span class="line">    <span class="comment">// TODO 返回一个新的DataStream，StreamMap 为 StreamOperator 的实现类</span></span><br><span class="line">    <span class="keyword">return</span> transform(<span class="string">"Map"</span>, outputType, <span class="keyword">new</span> StreamMap&lt;&gt;(clean(mapper)));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">SingleOutputStreamOperator&lt;R&gt; <span class="title">transform</span><span class="params">(String operatorName,</span></span></span><br><span class="line"><span class="params"><span class="function">TypeInformation&lt;R&gt; outTypeInfo,OneInputStreamOperator&lt;T, R&gt; operator)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> doTransform(operatorName, outTypeInfo,</span><br><span class="line">                       SimpleOperatorFactory.of(operator));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> &lt;R&gt; <span class="function">SingleOutputStreamOperator&lt;R&gt; <span class="title">doTransform</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    String operatorName,</span></span></span><br><span class="line"><span class="params"><span class="function">    TypeInformation&lt;R&gt; outTypeInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    StreamOperatorFactory&lt;R&gt; operatorFactory)</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// read the output type of the input Transform to coax out errors about MissingTypeInfo</span></span><br><span class="line">    transformation.getOutputType();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 新的 transformation 会连接上当前 DataStream 中的 transformation，从而构建成一棵树</span></span><br><span class="line">    OneInputTransformation&lt;T, R&gt; resultTransform = <span class="keyword">new</span> OneInputTransformation&lt;&gt;(</span><br><span class="line">        <span class="keyword">this</span>.transformation,</span><br><span class="line">        operatorName,</span><br><span class="line">        operatorFactory,</span><br><span class="line">        outTypeInfo,</span><br><span class="line">        environment.getParallelism());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings({"unchecked", "rawtypes"})</span></span><br><span class="line">    SingleOutputStreamOperator&lt;R&gt; returnStream = <span class="keyword">new</span> SingleOutputStreamOperator(environment, resultTransform);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 所有的 transformation 都会存到 env 中，调用 execute 时遍历该 list 生成 StreamGraph</span></span><br><span class="line">    getExecutionEnvironment().addOperator(resultTransform);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> returnStream;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>从上方代码可以了解到，map 转换将用户自定义的函数 MapFunction 包装到 StreamMap 这个 Operator 中，再将 StreamMap 包装到 OneInputTransformation，最后该 transformation 存 到 env 中，当调用 env.execute 时，遍历其中的 transformation 集合构造出 StreamGraph。其分 层实现如下图所示：</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715094948852.png" alt="StreamGraph"></p>
<p>另外，并不是每一个 StreamTransformation 都会转换成 runtime 层中物理操作。有一 些只是逻辑概念，比如 union、split/select、partition 等。如下图所示的转换树，在运行时 会优化成下方的操作图。</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715095013971.png" alt="转换树"></p>
<p>union、split/select（1.12 已移除）、partition 中的信息会被写入到 Source –&gt; Map 的 边中。通过源码也可以发现 UnionTransformation , SplitTransformation（1.12 移除） ， SelectTransformation（1.12 移除）,PartitionTransformation 由于不包含具体的操作所以都没 有 StreamOperator 成员变量，而其他 StreamTransformation 的子类基本上都有。 接着分析 StreamGraph 生成的源码：</p>
<p>StreamExecutionEnvironment.java -&gt; generator() -&gt; transform()</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TODO 对每个 transformation 进行转换，转换成 StreamGraph 中的 StreamNode 和 StreamEdge</span></span><br><span class="line"><span class="comment">// TODO 返回值为该 transform 的 id 集合，通常大小为 1 个（除 FeedbackTransformation）</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;Integer&gt; <span class="title">transform</span><span class="params">(Transformation&lt;?&gt; transform)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (alreadyTransformed.containsKey(transform)) {</span><br><span class="line">        <span class="keyword">return</span> alreadyTransformed.get(transform);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    LOG.debug(<span class="string">"Transforming "</span> + transform);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (transform.getMaxParallelism() &lt;= <span class="number">0</span>) {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if the max parallelism hasn't been set, then first use the job wide max parallelism</span></span><br><span class="line">        <span class="comment">// from the ExecutionConfig.</span></span><br><span class="line">        <span class="keyword">int</span> globalMaxParallelismFromConfig = executionConfig.getMaxParallelism();</span><br><span class="line">        <span class="keyword">if</span> (globalMaxParallelismFromConfig &gt; <span class="number">0</span>) {</span><br><span class="line">            transform.setMaxParallelism(globalMaxParallelismFromConfig);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// call at least once to trigger exceptions about MissingTypeInfo</span></span><br><span class="line">    <span class="comment">// TODO 为了触发 MissingTypeInfo 的异常</span></span><br><span class="line">    transform.getOutputType();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings("unchecked")</span></span><br><span class="line">    <span class="keyword">final</span> TransformationTranslator&lt;?, Transformation&lt;?&gt;&gt; translator =</span><br><span class="line">        (TransformationTranslator&lt;?, Transformation&lt;?&gt;&gt;) translatorMap.get(transform.getClass());</span><br><span class="line"></span><br><span class="line">    Collection&lt;Integer&gt; transformedIds;</span><br><span class="line">    <span class="keyword">if</span> (translator != <span class="keyword">null</span>) {</span><br><span class="line">        transformedIds = translate(translator, transform);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        transformedIds = legacyTransform(transform);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// need this check because the iterate transformation adds itself before</span></span><br><span class="line">    <span class="comment">// transforming the feedback edges</span></span><br><span class="line">    <span class="keyword">if</span> (!alreadyTransformed.containsKey(transform)) {</span><br><span class="line">        alreadyTransformed.put(transform, transformedIds);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> transformedIds;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;Integer&gt; <span class="title">translate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> TransformationTranslator&lt;?, Transformation&lt;?&gt;&gt; translator,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> Transformation&lt;?&gt; transform)</span> </span>{</span><br><span class="line">    checkNotNull(translator);</span><br><span class="line">    checkNotNull(transform);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> List&lt;Collection&lt;Integer&gt;&gt; allInputIds = getParentInputIds(transform.getInputs());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the recursive call might have already transformed this</span></span><br><span class="line">    <span class="keyword">if</span> (alreadyTransformed.containsKey(transform)) {</span><br><span class="line">        <span class="keyword">return</span> alreadyTransformed.get(transform);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String slotSharingGroup = determineSlotSharingGroup(</span><br><span class="line">        transform.getSlotSharingGroup(),</span><br><span class="line">        allInputIds.stream()</span><br><span class="line">        .flatMap(Collection::stream)</span><br><span class="line">        .collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> TransformationTranslator.Context context = <span class="keyword">new</span> ContextImpl(</span><br><span class="line">        <span class="keyword">this</span>, streamGraph, slotSharingGroup, configuration);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shouldExecuteInBatchMode</span><br><span class="line">        ? translator.translateForBatch(transform, context)</span><br><span class="line">        : translator.translateForStreaming(transform, context);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>SimpleTransformationTranslator.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;Integer&gt; <span class="title">translateForStreaming</span><span class="params">(<span class="keyword">final</span> T transformation, <span class="keyword">final</span> Context context)</span> </span>{</span><br><span class="line">    checkNotNull(transformation);</span><br><span class="line">    checkNotNull(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TOOD 区分 map之类的转换算子（OneInput） 和 keyby值类的分区算子（partition）</span></span><br><span class="line">    <span class="keyword">final</span> Collection&lt;Integer&gt; transformedIds =</span><br><span class="line">        translateForStreamingInternal(transformation, context);</span><br><span class="line">    configure(transformation, context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> transformedIds;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>AbstractOneInputTransformationTranslator.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Collection&lt;Integer&gt; <span class="title">translateInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> Transformation&lt;OUT&gt; transformation,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> StreamOperatorFactory&lt;OUT&gt; operatorFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> TypeInformation&lt;IN&gt; inputType,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@Nullable</span> <span class="keyword">final</span> KeySelector&lt;IN, ?&gt; stateKeySelector,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@Nullable</span> <span class="keyword">final</span> TypeInformation&lt;?&gt; stateKeyType,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> Context context)</span> </span>{</span><br><span class="line">    checkNotNull(transformation);</span><br><span class="line">    checkNotNull(operatorFactory);</span><br><span class="line">    checkNotNull(inputType);</span><br><span class="line">    checkNotNull(context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> StreamGraph streamGraph = context.getStreamGraph();</span><br><span class="line">    <span class="keyword">final</span> String slotSharingGroup = context.getSlotSharingGroup();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> transformationId = transformation.getId();</span><br><span class="line">    <span class="keyword">final</span> ExecutionConfig executionConfig = streamGraph.getExecutionConfig();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*TODO 添加 StreamNode*/</span></span><br><span class="line">    streamGraph.addOperator(</span><br><span class="line">        transformationId,</span><br><span class="line">        slotSharingGroup,</span><br><span class="line">        transformation.getCoLocationGroupKey(),</span><br><span class="line">        operatorFactory,</span><br><span class="line">        inputType,</span><br><span class="line">        transformation.getOutputType(),</span><br><span class="line">        transformation.getName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stateKeySelector != <span class="keyword">null</span>) {</span><br><span class="line">        TypeSerializer&lt;?&gt; keySerializer = stateKeyType.createSerializer(executionConfig);</span><br><span class="line">        streamGraph.setOneInputStateKey(transformationId, stateKeySelector, keySerializer);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> parallelism = transformation.getParallelism() != ExecutionConfig.PARALLELISM_DEFAULT</span><br><span class="line">        ? transformation.getParallelism()</span><br><span class="line">        : executionConfig.getParallelism();</span><br><span class="line">    streamGraph.setParallelism(transformationId, parallelism);</span><br><span class="line">    streamGraph.setMaxParallelism(transformationId, transformation.getMaxParallelism());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> List&lt;Transformation&lt;?&gt;&gt; parentTransformations = transformation.getInputs();</span><br><span class="line">    checkState(</span><br><span class="line">        parentTransformations.size() == <span class="number">1</span>,</span><br><span class="line">        <span class="string">"Expected exactly one input transformation but found "</span> + parentTransformations.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*TODO 添加StreamEdge*/</span></span><br><span class="line">    <span class="keyword">for</span> (Integer inputId: context.getStreamNodeIds(parentTransformations.get(<span class="number">0</span>))) {</span><br><span class="line">        streamGraph.addEdge(inputId, transformationId, <span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Collections.singleton(transformationId);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>该函数首先会对该 transform 的上游 transform 进行递归转换，确保上游的都已经完成 了转化。然后通过 transform 构造出 StreamNode，最后与上游的 transform 进行连接，构造 出 StreamNode。 最后再来看下对逻辑转换（partition、union 等）的处理，如下是 transformPartition 函 数的源码：</p>
<p>PartitionTransformationTranslator.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Collection&lt;Integer&gt; <span class="title">translateForBatchInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> PartitionTransformation&lt;OUT&gt; transformation,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> Context context)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> translateInternal(transformation, context);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private Collection&lt;Integer&gt; translateInternal(</span><br><span class="line">      final PartitionTransformation&lt;OUT&gt; transformation,</span><br><span class="line">      final Context context) {</span><br><span class="line">   checkNotNull(transformation);</span><br><span class="line">   checkNotNull(context);</span><br><span class="line"></span><br><span class="line">   final StreamGraph streamGraph = context.getStreamGraph();</span><br><span class="line"></span><br><span class="line">   final List&lt;Transformation&lt;?&gt;&gt; parentTransformations = transformation.getInputs();</span><br><span class="line">   checkState(</span><br><span class="line">         parentTransformations.size() == 1,</span><br><span class="line">         "Expected exactly one input transformation but found " + parentTransformations.size());</span><br><span class="line">   final Transformation&lt;?&gt; input = parentTransformations.get(0);</span><br><span class="line"></span><br><span class="line">   List&lt;Integer&gt; resultIds = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">   for (Integer inputId: context.getStreamNodeIds(input)) {</span><br><span class="line">      /*TODO 生成一个新的虚拟id*/</span><br><span class="line">      final int virtualId = Transformation.getNewNodeId();</span><br><span class="line">      /*TODO 添加一个虚拟分区节点，不会生成StreamNode*/</span><br><span class="line">      streamGraph.addVirtualPartitionNode(</span><br><span class="line">            inputId,</span><br><span class="line">            virtualId,</span><br><span class="line">            transformation.getPartitioner(),</span><br><span class="line">            transformation.getShuffleMode());</span><br><span class="line">      resultIds.add(virtualId);</span><br><span class="line">   }</span><br><span class="line">   return resultIds;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>对 partition 的转换没有生成具体的 StreamNode 和 StreamEdge，而是添加一个虚节点。 当 partition 的下游 transform（如 map）添加 edge 时（调用 StreamGraph.addEdge），会把 partition 信息写入到 edge 中。接前面 map 的流程：</p>
<p> AbstractOneInputTransformationTranslator.java -&gt; translateInternal()</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*TODO 添加StreamEdge*/</span></span><br><span class="line"><span class="keyword">for</span> (Integer inputId: context.getStreamNodeIds(parentTransformations.get(<span class="number">0</span>))) {</span><br><span class="line">   streamGraph.addEdge(inputId, transformationId, <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEdge</span><span class="params">(Integer upStreamVertexID, Integer downStreamVertexID, <span class="keyword">int</span> typeNumber)</span> </span>{</span><br><span class="line">   addEdgeInternal(upStreamVertexID,</span><br><span class="line">         downStreamVertexID,</span><br><span class="line">         typeNumber,</span><br><span class="line">         <span class="keyword">null</span>,</span><br><span class="line">         <span class="keyword">new</span> ArrayList&lt;String&gt;(),</span><br><span class="line">         <span class="keyword">null</span>,</span><br><span class="line">         <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addEdgeInternal</span><span class="params">(Integer upStreamVertexID,</span></span></span><br><span class="line"><span class="params"><span class="function">                             Integer downStreamVertexID,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">int</span> typeNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">                             StreamPartitioner&lt;?&gt; partitioner,</span></span></span><br><span class="line"><span class="params"><span class="function">                             List&lt;String&gt; outputNames,</span></span></span><br><span class="line"><span class="params"><span class="function">                             OutputTag outputTag,</span></span></span><br><span class="line"><span class="params"><span class="function">                             ShuffleMode shuffleMode)</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*TODO 当上游是侧输出时，递归调用，并传入侧输出信息*/</span></span><br><span class="line">    <span class="keyword">if</span> (virtualSideOutputNodes.containsKey(upStreamVertexID)) {</span><br><span class="line">        <span class="keyword">int</span> virtualId = upStreamVertexID;</span><br><span class="line">        upStreamVertexID = virtualSideOutputNodes.get(virtualId).f0;</span><br><span class="line">        <span class="keyword">if</span> (outputTag == <span class="keyword">null</span>) {</span><br><span class="line">            outputTag = virtualSideOutputNodes.get(virtualId).f1;</span><br><span class="line">        }</span><br><span class="line">        addEdgeInternal(upStreamVertexID, downStreamVertexID, typeNumber, partitioner, <span class="keyword">null</span>, outputTag, shuffleMode);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (virtualPartitionNodes.containsKey(upStreamVertexID)) {</span><br><span class="line">        <span class="comment">/*TODO 当上游是partition时，递归调用，并传入partitioner信息*/</span></span><br><span class="line">        <span class="keyword">int</span> virtualId = upStreamVertexID;</span><br><span class="line">        upStreamVertexID = virtualPartitionNodes.get(virtualId).f0;</span><br><span class="line">        <span class="keyword">if</span> (partitioner == <span class="keyword">null</span>) {</span><br><span class="line">            partitioner = virtualPartitionNodes.get(virtualId).f1;</span><br><span class="line">        }</span><br><span class="line">        shuffleMode = virtualPartitionNodes.get(virtualId).f2;</span><br><span class="line">        addEdgeInternal(upStreamVertexID, downStreamVertexID, typeNumber, partitioner, outputNames, outputTag, shuffleMode);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">/*TODO 真正构建StreamEdge*/</span></span><br><span class="line">        StreamNode upstreamNode = getStreamNode(upStreamVertexID);</span><br><span class="line">        StreamNode downstreamNode = getStreamNode(downStreamVertexID);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If no partitioner was specified and the parallelism of upstream and downstream</span></span><br><span class="line">        <span class="comment">// operator matches use forward partitioning, use rebalance otherwise.</span></span><br><span class="line">        <span class="comment">/*TODO 未指定partitioner的话，会为其选择 forward 或 rebalance 分区*/</span></span><br><span class="line">        <span class="keyword">if</span> (partitioner == <span class="keyword">null</span> &amp;&amp; upstreamNode.getParallelism() == downstreamNode.getParallelism()) {</span><br><span class="line">            partitioner = <span class="keyword">new</span> ForwardPartitioner&lt;Object&gt;();</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (partitioner == <span class="keyword">null</span>) {</span><br><span class="line">            partitioner = <span class="keyword">new</span> RebalancePartitioner&lt;Object&gt;();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 健康检查，forward 分区必须要上下游的并发度一致</span></span><br><span class="line">        <span class="keyword">if</span> (partitioner <span class="keyword">instanceof</span> ForwardPartitioner) {</span><br><span class="line">            <span class="keyword">if</span> (upstreamNode.getParallelism() != downstreamNode.getParallelism()) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Forward partitioning does not allow "</span> +</span><br><span class="line">                                                        <span class="string">"change of parallelism. Upstream operation: "</span> + upstreamNode + <span class="string">" parallelism: "</span> + upstreamNode.getParallelism() +</span><br><span class="line">                                                        <span class="string">", downstream operation: "</span> + downstreamNode + <span class="string">" parallelism: "</span> + downstreamNode.getParallelism() +</span><br><span class="line">                                                        <span class="string">" You must use another partitioning strategy, such as broadcast, rebalance, shuffle or global."</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shuffleMode == <span class="keyword">null</span>) {</span><br><span class="line">            shuffleMode = ShuffleMode.UNDEFINED;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*TODO 创建 StreamEdge*/</span></span><br><span class="line">        StreamEdge edge = <span class="keyword">new</span> StreamEdge(upstreamNode, downstreamNode, typeNumber,</span><br><span class="line">                                         partitioner, outputTag, shuffleMode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*TODO 将该 StreamEdge 添加到上游的输出，下游的输入*/</span></span><br><span class="line">        getStreamNode(edge.getSourceId()).addOutEdge(edge);</span><br><span class="line">        getStreamNode(edge.getTargetId()).addInEdge(edge);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>实例分析： 看一个实例：如下程序，是一个从 Source 中按行切分成单词并过滤输出的简单流程</p>
<p>序，其中包含了逻辑转换：随机分区 shuffle。分析该程序是如何生成 StreamGraph 的。</p>
<p>DataStream text = env.socketTextStream(hostName, port);</p>
<p> text.flatMap(new LineSplitter()).shuffle().filter(new HelloFilter()).print();</p>
<p>首先会在 env 中生成一棵 transformation 树，用 List&gt;保存。其结构 图如下：</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715095802266.png" alt="transformation"></p>
<p>其中符号*为 input 指针，指向上游的 transformation，从而形成了一棵 transformation 树。然后，通过调用 StreamGraphGenerator.generate(env, transformations)来生成 StreamGraph。自底向上递归调用每一个 transformation，也就是说处理顺序是 </p>
<p>Source-&gt;FlatMap-&gt;Shuffle-&gt;Filter-&gt;Sink。</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715095841565.png" alt="transformation处理逻辑"></p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">1）首先处理的</span> <span class="string">Source，生成了 Source 的 StreamNode。</span></span><br><span class="line"><span class="meta">2）然后处理的</span> <span class="string">FlatMap，生成了 FlatMap 的 StreamNode，并生成 StreamEdge 连接上游</span></span><br><span class="line"><span class="attr">Source</span> <span class="string">和 FlatMap。由于上下游的并发度不一样（1:4），所以此处是 Rebalance 分区。</span></span><br><span class="line"><span class="meta">3）然后处理的</span> <span class="string">Shuffle，由于是逻辑转换，并不会生成实际的节点。将 partitioner 信息暂存</span></span><br><span class="line"><span class="meta">在</span> <span class="string">virtuaPartitionNodes 中。</span></span><br><span class="line"><span class="meta">4）在处理</span> <span class="string">Filter 时，生成了 Filter 的 StreamNode。发现上游是 shuffle，找到 shuffle 的上游FlatMap，创建 StreamEdge 与 Filter 相连。并把 ShufflePartitioner 的信息写到 StreamEdge中。</span></span><br><span class="line"><span class="meta">5）最后处理</span> <span class="string">Sink，创建 Sink 的 StreamNode，并生成 StreamEdge 与上游 Filter 相连。由于上下游并发度一样（4:4），所以此处选择 Forward 分区。</span></span><br><span class="line"><span class="meta">最后可以通过</span> <span class="string">UI 可视化 来观察得到的 StreamGraph。</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715095937015.png" alt="StreamGraph"></p>
<h3 id="5-4-JobGraph-在-Client-生成"><a href="#5-4-JobGraph-在-Client-生成" class="headerlink" title="5.4 JobGraph 在 Client 生成"></a>5.4 JobGraph 在 Client 生成</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">StreamGraph</span> <span class="string">转变成 JobGraph 也是在 Client 完成，主要作了三件事：</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">StreamNode 转成 JobVertex。</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">StreamEdge 转成 JobEdge。</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">JobEdge 和 JobVertex 之间创建 IntermediateDataSet 来连接。</span></span><br></pre></td></tr></tbody></table></figure>

<p>看 execute 里的逻辑（yarn-per-job 为例）：</p>
<p>AbstractJobClusterExecutor.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompletableFuture&lt;JobClient&gt; <span class="title">execute</span><span class="params">(<span class="meta">@Nonnull</span> <span class="keyword">final</span> Pipeline pipeline, <span class="meta">@Nonnull</span> <span class="keyword">final</span> Configuration configuration, <span class="meta">@Nonnull</span> <span class="keyword">final</span> ClassLoader userCodeClassloader)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">/*TODO 将 流图（StreamGraph） 转换成 作业图（JobGraph）*/</span></span><br><span class="line">    <span class="keyword">final</span> JobGraph jobGraph = PipelineExecutorUtils.getJobGraph(pipeline, configuration);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*TODO 集群描述器：创建、启动了 YarnClient， 包含了一些yarn、flink的配置和环境信息*/</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="keyword">final</span> ClusterDescriptor&lt;ClusterID&gt; clusterDescriptor = clusterClientFactory.createClusterDescriptor(configuration)) {</span><br><span class="line">        <span class="keyword">final</span> ExecutionConfigAccessor configAccessor = ExecutionConfigAccessor.fromConfiguration(configuration);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*TODO 集群特有资源配置：JobManager内存、TaskManager内存、每个Tm的slot数*/</span></span><br><span class="line">        <span class="keyword">final</span> ClusterSpecification clusterSpecification = clusterClientFactory.getClusterSpecification(configuration);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ClusterClientProvider&lt;ClusterID&gt; clusterClientProvider = clusterDescriptor</span><br><span class="line">            .deployJobCluster(clusterSpecification, jobGraph, configAccessor.getDetachedMode());</span><br><span class="line">        LOG.info(<span class="string">"Job has been submitted with JobID "</span> + jobGraph.getJobID());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.completedFuture(</span><br><span class="line">            <span class="keyword">new</span> ClusterClientJobClientAdapter&lt;&gt;(clusterClientProvider, jobGraph.getJobID(), userCodeClassloader));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>PipelineExecutorUtils.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobGraph <span class="title">getJobGraph</span><span class="params">(<span class="meta">@Nonnull</span> <span class="keyword">final</span> Pipeline pipeline, <span class="meta">@Nonnull</span> <span class="keyword">final</span> Configuration configuration)</span> <span class="keyword">throws</span> MalformedURLException </span>{</span><br><span class="line">   checkNotNull(pipeline);</span><br><span class="line">   checkNotNull(configuration);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> ExecutionConfigAccessor executionConfigAccessor = ExecutionConfigAccessor.fromConfiguration(configuration);</span><br><span class="line">   <span class="keyword">final</span> JobGraph jobGraph = FlinkPipelineTranslationUtil</span><br><span class="line">         .getJobGraph(pipeline, configuration, executionConfigAccessor.getParallelism());</span><br><span class="line"></span><br><span class="line">   configuration</span><br><span class="line">         .getOptional(PipelineOptionsInternal.PIPELINE_FIXED_JOB_ID)</span><br><span class="line">         .ifPresent(strJobID -&gt; jobGraph.setJobID(JobID.fromHexString(strJobID)));</span><br><span class="line"></span><br><span class="line">   jobGraph.addJars(executionConfigAccessor.getJars());</span><br><span class="line">   jobGraph.setClasspaths(executionConfigAccessor.getClasspaths());</span><br><span class="line">   jobGraph.setSavepointRestoreSettings(executionConfigAccessor.getSavepointRestoreSettings());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> jobGraph;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>FlinkPipelineTranslationUtil.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobGraph <span class="title">getJobGraphUnderUserClassLoader</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> ClassLoader userClassloader,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> Pipeline pipeline,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> Configuration configuration,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> <span class="keyword">int</span> defaultParallelism)</span> </span>{</span><br><span class="line">   <span class="keyword">final</span> ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      Thread.currentThread().setContextClassLoader(userClassloader);</span><br><span class="line">      <span class="keyword">return</span> FlinkPipelineTranslationUtil.getJobGraph(pipeline, configuration, defaultParallelism);</span><br><span class="line">   } <span class="keyword">finally</span> {</span><br><span class="line">      Thread.currentThread().setContextClassLoader(contextClassLoader);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobGraph <span class="title">getJobGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      Pipeline pipeline,</span></span></span><br><span class="line"><span class="params"><span class="function">      Configuration optimizerConfiguration,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">int</span> defaultParallelism)</span> </span>{</span><br><span class="line"></span><br><span class="line">   FlinkPipelineTranslator pipelineTranslator = getPipelineTranslator(pipeline);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> pipelineTranslator.translateToJobGraph(pipeline,</span><br><span class="line">         optimizerConfiguration,</span><br><span class="line">         defaultParallelism);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>StreamGraphTranslator.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobGraph <span class="title">translateToJobGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      Pipeline pipeline,</span></span></span><br><span class="line"><span class="params"><span class="function">      Configuration optimizerConfiguration,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">int</span> defaultParallelism)</span> </span>{</span><br><span class="line">   checkArgument(pipeline <span class="keyword">instanceof</span> StreamGraph,</span><br><span class="line">         <span class="string">"Given pipeline is not a DataStream StreamGraph."</span>);</span><br><span class="line"></span><br><span class="line">   StreamGraph streamGraph = (StreamGraph) pipeline;</span><br><span class="line">   <span class="keyword">return</span> streamGraph.getJobGraph(<span class="keyword">null</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>StreamGraph.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobGraph <span class="title">getJobGraph</span><span class="params">(<span class="meta">@Nullable</span> JobID jobID)</span> </span>{</span><br><span class="line">   <span class="keyword">return</span> StreamingJobGraphGenerator.createJobGraph(<span class="keyword">this</span>, jobID);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>StreamingJobGraphGenerator.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobGraph <span class="title">createJobGraph</span><span class="params">(StreamGraph streamGraph, <span class="meta">@Nullable</span> JobID jobID)</span> </span>{</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> StreamingJobGraphGenerator(streamGraph, jobID).createJobGraph();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>看一下核心类 StreamingJobGraphGenerator 的相关属性：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StreamGraph streamGraph;</span><br><span class="line"><span class="comment">// id -&gt; JobVertex</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, JobVertex&gt; jobVertices;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> JobGraph jobGraph;</span><br><span class="line"><span class="comment">// 已经构建的JobVertex的id集合</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;Integer&gt; builtVertices;</span><br><span class="line"><span class="comment">// 物理边集合（排除了chain内部的边）, 按创建顺序排序</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;StreamEdge&gt; physicalEdgesInOrder;</span><br><span class="line"><span class="comment">// 保存chain信息，部署时用来构建 OperatorChain，startNodeId -&gt; (currentNodeId -&gt; StreamConfig)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, Map&lt;Integer, StreamConfig&gt;&gt; chainedConfigs;</span><br><span class="line"><span class="comment">// 所有节点的配置信息，id -&gt; StreamConfig</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, StreamConfig&gt; vertexConfigs;</span><br><span class="line"><span class="comment">// 保存每个节点的名字，id -&gt; chainedName</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, String&gt; chainedNames;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, ResourceSpec&gt; chainedMinResources;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, ResourceSpec&gt; chainedPreferredResources;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, InputOutputFormatContainer&gt; chainedInputOutputFormats;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StreamGraphHasher defaultStreamGraphHasher;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;StreamGraphHasher&gt; legacyStreamGraphHashers;</span><br></pre></td></tr></tbody></table></figure>

<p>核心逻辑：根据 StreamGraph，生成 JobGraph：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> JobGraph <span class="title">createJobGraph</span><span class="params">()</span> </span>{</span><br><span class="line">   preValidate();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// make sure that all vertices start immediately</span></span><br><span class="line">   <span class="comment">/*TODO streaming 模式下，调度模式是所有节点（vertices）一起启动：Eager */</span></span><br><span class="line">   jobGraph.setScheduleMode(streamGraph.getScheduleMode());</span><br><span class="line">   jobGraph.enableApproximateLocalRecovery(streamGraph.getCheckpointConfig().isApproximateLocalRecoveryEnabled());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Generate deterministic hashes for the nodes in order to identify them across</span></span><br><span class="line">   <span class="comment">// submission iff they didn't change.</span></span><br><span class="line">   <span class="comment">// 广度优先遍历 StreamGraph 并且为每个SteamNode生成hash id，</span></span><br><span class="line">   <span class="comment">// 保证如果提交的拓扑没有改变，则每次生成的hash都是一样的</span></span><br><span class="line">   Map&lt;Integer, <span class="keyword">byte</span>[]&gt; hashes = defaultStreamGraphHasher.traverseStreamGraphAndGenerateHashes(streamGraph);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Generate legacy version hashes for backwards compatibility</span></span><br><span class="line">   List&lt;Map&lt;Integer, <span class="keyword">byte</span>[]&gt;&gt; legacyHashes = <span class="keyword">new</span> ArrayList&lt;&gt;(legacyStreamGraphHashers.size());</span><br><span class="line">   <span class="keyword">for</span> (StreamGraphHasher hasher : legacyStreamGraphHashers) {</span><br><span class="line">      legacyHashes.add(hasher.traverseStreamGraphAndGenerateHashes(streamGraph));</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* TODO 最重要的函数，生成 JobVertex，JobEdge等，并尽可能地将多个节点chain在一起*/</span></span><br><span class="line">   setChaining(hashes, legacyHashes);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*TODO 将每个JobVertex的入边集合也序列化到该JobVertex的StreamConfig中 (出边集合已经在setChaining的时候写入了)*/</span></span><br><span class="line">   setPhysicalEdges();</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*TODO 根据group name，为每个 JobVertex 指定所属的 SlotSharingGroup 以及针对 Iteration的头尾设置  CoLocationGroup*/</span></span><br><span class="line">   setSlotSharingAndCoLocation();</span><br><span class="line"></span><br><span class="line">   setManagedMemoryFraction(</span><br><span class="line">      Collections.unmodifiableMap(jobVertices),</span><br><span class="line">      Collections.unmodifiableMap(vertexConfigs),</span><br><span class="line">      Collections.unmodifiableMap(chainedConfigs),</span><br><span class="line">      id -&gt; streamGraph.getStreamNode(id).getManagedMemoryOperatorScopeUseCaseWeights(),</span><br><span class="line">      id -&gt; streamGraph.getStreamNode(id).getManagedMemorySlotScopeUseCases());</span><br><span class="line"></span><br><span class="line">   configureCheckpointing();</span><br><span class="line"></span><br><span class="line">   jobGraph.setSavepointRestoreSettings(streamGraph.getSavepointRestoreSettings());</span><br><span class="line"></span><br><span class="line">   JobGraphUtils.addUserArtifactEntries(streamGraph.getUserArtifacts(), jobGraph);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// set the ExecutionConfig last when it has been finalized</span></span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">/*TODO 将 StreamGraph 的 ExecutionConfig 序列化到 JobGraph 的配置中*/</span></span><br><span class="line">      jobGraph.setExecutionConfig(streamGraph.getExecutionConfig());</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalConfigurationException(<span class="string">"Could not serialize the ExecutionConfig."</span> +</span><br><span class="line">            <span class="string">"This indicates that non-serializable types (like custom serializers) were registered"</span>);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> jobGraph;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>StreamingJobGraphGenerator 的成员变量都是为了辅助生成最终的 JobGraph。 为所有节点生成一个唯一的 hash id，如果节点在多次提交中没有改变（包括并发度、上 下游等），那么这个 id 就不会改变，这主要用于故障恢复。 这里不能用 StreamNode.id 来代替，因为这是一个从 1 开始的静态计数变量，同样的 Job 可能会得到不一样的 id，如下代码示例的两个 job 是完全一样的，但是 source 的 id 却不一 样了。</p>
<figure class="highlight tex"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 范例 1：A.id=1 B.id=2</span><br><span class="line">DataStream&lt;String&gt; A = ...</span><br><span class="line">DataStream&lt;String&gt; B = ...</span><br><span class="line">A.union(B).print();</span><br><span class="line">// 范例 2：A.id=2 B.id=1</span><br><span class="line">DataStream&lt;String&gt; B = ...</span><br><span class="line">DataStream&lt;String&gt; A = ...</span><br><span class="line">A.union(B).print();</span><br></pre></td></tr></tbody></table></figure>

<p>看一下最关键的 chaining 处理：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setChaining</span><span class="params">(Map&lt;Integer, <span class="keyword">byte</span>[]&gt; hashes, List&lt;Map&lt;Integer, <span class="keyword">byte</span>[]&gt;&gt; legacyHashes)</span> </span>{</span><br><span class="line">   <span class="comment">// we separate out the sources that run as inputs to another operator (chained inputs)</span></span><br><span class="line">   <span class="comment">// from the sources that needs to run as the main (head) operator.</span></span><br><span class="line">   <span class="keyword">final</span> Map&lt;Integer, OperatorChainInfo&gt; chainEntryPoints = buildChainedInputsAndGetHeadInputs(hashes, legacyHashes);</span><br><span class="line">   <span class="keyword">final</span> Collection&lt;OperatorChainInfo&gt; initialEntryPoints = <span class="keyword">new</span> ArrayList&lt;&gt;(chainEntryPoints.values());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// iterate over a copy of the values, because this map gets concurrently modified</span></span><br><span class="line">   <span class="comment">/*TODO 从source开始建⽴ node chains*/</span></span><br><span class="line">   <span class="keyword">for</span> (OperatorChainInfo info : initialEntryPoints) {</span><br><span class="line">      <span class="comment">/*TODO 构建node chains，返回当前节点的物理出边；startNodeId != currentNodeId 时,说明currentNode是chain中的子节点*/</span></span><br><span class="line">      createChain(</span><br><span class="line">            info.getStartNodeId(),</span><br><span class="line">            <span class="number">1</span>,  <span class="comment">// operators start at position 1 because 0 is for chained source inputs</span></span><br><span class="line">            info,</span><br><span class="line">            chainEntryPoints);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;StreamEdge&gt; <span class="title">createChain</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> Integer currentNodeId,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> <span class="keyword">int</span> chainIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> OperatorChainInfo chainInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> Map&lt;Integer, OperatorChainInfo&gt; chainEntryPoints)</span> </span>{</span><br><span class="line"></span><br><span class="line">   Integer startNodeId = chainInfo.getStartNodeId();</span><br><span class="line">   <span class="keyword">if</span> (!builtVertices.contains(startNodeId)) {</span><br><span class="line">      <span class="comment">/*TODO 过渡用的出边集合, 用来生成最终的 JobEdge, 注意不包括 chain 内部的边*/</span></span><br><span class="line">      List&lt;StreamEdge&gt; transitiveOutEdges = <span class="keyword">new</span> ArrayList&lt;StreamEdge&gt;();</span><br><span class="line"></span><br><span class="line">      List&lt;StreamEdge&gt; chainableOutputs = <span class="keyword">new</span> ArrayList&lt;StreamEdge&gt;();</span><br><span class="line">      List&lt;StreamEdge&gt; nonChainableOutputs = <span class="keyword">new</span> ArrayList&lt;StreamEdge&gt;();</span><br><span class="line"></span><br><span class="line">      StreamNode currentNode = streamGraph.getStreamNode(currentNodeId);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*TODO 将当前节点的出边分成 chainable 和 nonChainable 两类*/</span></span><br><span class="line">      <span class="keyword">for</span> (StreamEdge outEdge : currentNode.getOutEdges()) {</span><br><span class="line">         <span class="keyword">if</span> (isChainable(outEdge, streamGraph)) {</span><br><span class="line">            chainableOutputs.add(outEdge);</span><br><span class="line">         } <span class="keyword">else</span> {</span><br><span class="line">            nonChainableOutputs.add(outEdge);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (StreamEdge chainable : chainableOutputs) {</span><br><span class="line">         transitiveOutEdges.addAll(</span><br><span class="line">               createChain(chainable.getTargetId(), chainIndex + <span class="number">1</span>, chainInfo, chainEntryPoints));</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*TODO 递归调用 createChain*/</span></span><br><span class="line">      <span class="keyword">for</span> (StreamEdge nonChainable : nonChainableOutputs) {</span><br><span class="line">         transitiveOutEdges.add(nonChainable);</span><br><span class="line">         createChain(</span><br><span class="line">               nonChainable.getTargetId(),</span><br><span class="line">               <span class="number">1</span>, <span class="comment">// operators start at position 1 because 0 is for chained source inputs</span></span><br><span class="line">               chainEntryPoints.computeIfAbsent(</span><br><span class="line">                  nonChainable.getTargetId(),</span><br><span class="line">                  (k) -&gt; chainInfo.newChain(nonChainable.getTargetId())),</span><br><span class="line">               chainEntryPoints);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*TODO 生成当前节点的显示名，如："Keyed Aggregation -&gt; Sink: Unnamed"*/</span></span><br><span class="line">      chainedNames.put(currentNodeId, createChainedName(currentNodeId, chainableOutputs, Optional.ofNullable(chainEntryPoints.get(currentNodeId))));</span><br><span class="line">      chainedMinResources.put(currentNodeId, createChainedMinResources(currentNodeId, chainableOutputs));</span><br><span class="line">      chainedPreferredResources.put(currentNodeId, createChainedPreferredResources(currentNodeId, chainableOutputs));</span><br><span class="line"></span><br><span class="line">      OperatorID currentOperatorId = chainInfo.addNodeToChain(currentNodeId, chainedNames.get(currentNodeId));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (currentNode.getInputFormat() != <span class="keyword">null</span>) {</span><br><span class="line">         getOrCreateFormatContainer(startNodeId).addInputFormat(currentOperatorId, currentNode.getInputFormat());</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (currentNode.getOutputFormat() != <span class="keyword">null</span>) {</span><br><span class="line">         getOrCreateFormatContainer(startNodeId).addOutputFormat(currentOperatorId, currentNode.getOutputFormat());</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*TODO 如果当前节点是起始节点, 则直接创建 JobVertex 并返回 StreamConfig, 否则先创建一个空的 StreamConfig */</span></span><br><span class="line">      StreamConfig config = currentNodeId.equals(startNodeId)</span><br><span class="line">            ? createJobVertex(startNodeId, chainInfo)</span><br><span class="line">            : <span class="keyword">new</span> StreamConfig(<span class="keyword">new</span> Configuration());</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*TODO 设置 JobVertex 的 StreamConfig, 基本上是序列化 StreamNode 中的配置到 StreamConfig中.*/</span></span><br><span class="line">      setVertexConfig(currentNodeId, config, chainableOutputs, nonChainableOutputs, chainInfo.getChainedSources());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (currentNodeId.equals(startNodeId)) {</span><br><span class="line">         <span class="comment">/*TODO 如果是chain的起始节点，标记成chain start（不是chain中的节点，也会被标记成 chain start）*/</span></span><br><span class="line">         config.setChainStart();</span><br><span class="line">         config.setChainIndex(chainIndex);</span><br><span class="line">         config.setOperatorName(streamGraph.getStreamNode(currentNodeId).getOperatorName());</span><br><span class="line"></span><br><span class="line">         <span class="comment">/*TODO 将当前节点(headOfChain)与所有出边相连*/</span></span><br><span class="line">         <span class="keyword">for</span> (StreamEdge edge : transitiveOutEdges) {</span><br><span class="line">            <span class="comment">/*TODO 通过StreamEdge构建出JobEdge，创建 IntermediateDataSet，用来将JobVertex和JobEdge相连*/</span></span><br><span class="line">            connect(startNodeId, edge);</span><br><span class="line">         }</span><br><span class="line"></span><br><span class="line">         <span class="comment">/*TODO 把物理出边写入配置, 部署时会用到*/</span></span><br><span class="line">         config.setOutEdgesInOrder(transitiveOutEdges);</span><br><span class="line">         <span class="comment">/*TODO 将chain中所有子节点的StreamConfig写入到 headOfChain 节点的 CHAINED_TASK_CONFIG 配置中*/</span></span><br><span class="line">         config.setTransitiveChainedTaskConfigs(chainedConfigs.get(startNodeId));</span><br><span class="line"></span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">         <span class="comment">/*TODO 如果是 chain 中的子节点*/</span></span><br><span class="line">         chainedConfigs.computeIfAbsent(startNodeId, k -&gt; <span class="keyword">new</span> HashMap&lt;Integer, StreamConfig&gt;());</span><br><span class="line"></span><br><span class="line">         config.setChainIndex(chainIndex);</span><br><span class="line">         StreamNode node = streamGraph.getStreamNode(currentNodeId);</span><br><span class="line">         config.setOperatorName(node.getOperatorName());</span><br><span class="line">         <span class="comment">/*TODO 将当前节点的StreamConfig添加到该chain的config集合中*/</span></span><br><span class="line">         chainedConfigs.get(startNodeId).put(currentNodeId, config);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      config.setOperatorID(currentOperatorId);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (chainableOutputs.isEmpty()) {</span><br><span class="line">         config.setChainEnd();</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">/*TODO 返回连往chain外部的出边集合*/</span></span><br><span class="line">      <span class="keyword">return</span> transitiveOutEdges;</span><br><span class="line"></span><br><span class="line">   } <span class="keyword">else</span> {</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">每个</span> <span class="string">JobVertex 都会对应一个可序列化的 StreamConfig, 用来发送给 JobManager 和</span></span><br><span class="line"><span class="meta">TaskManager。最后在</span> <span class="string">TaskManager 中起 Task 时,需要从这里面反序列化出所需要的配置信</span></span><br><span class="line"><span class="meta">息,</span> <span class="string">其中就包括了含有用户代码的 StreamOperator。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setChaining</span> <span class="string">会对 source 调用 createChain 方法，该方法会递归调用下游节点，从而构建</span></span><br><span class="line"><span class="meta">出</span> <span class="string">node chains。createChain 会分析当前节点的出边，根据 Operator Chains 中的 chainable 条件，将出边分成 chainalbe 和 noChainable 两类，并分别递归调用自身方法。之后会将</span></span><br><span class="line"></span><br><span class="line"><span class="attr">StreamNode</span> <span class="string">中的配置信息序列化到 StreamConfig 中。如果当前不是 chain 中的子节点，则会</span></span><br><span class="line"><span class="meta">构建</span> <span class="string">JobVertex 和 JobEdge 相连。如果是 chain 中的子节点，则会将 StreamConfig 添加到该chain 的 config 集合中。一个 node chains，除了 headOfChain node 会生成对应的 JobVertex，</span></span><br><span class="line"></span><br><span class="line"><span class="meta">其余的</span> <span class="string">nodes 都是以序列化的形式写入到 StreamConfig 中，并保存到 headOfChain 的</span></span><br><span class="line"><span class="attr">CHAINED_TASK_CONFIG</span> <span class="string">配置项中。直到部署时，才会取出并生成对应的 ChainOperators。</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-5-ExecutionGraph-在-JobManager-JobMaster生成"><a href="#5-5-ExecutionGraph-在-JobManager-JobMaster生成" class="headerlink" title="5.5  ExecutionGraph 在 JobManager  | JobMaster生成"></a>5.5  ExecutionGraph 在 JobManager  | JobMaster生成</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">client</span> <span class="string">生成 JobGraph 之后，就通过 submitJob 提交给 JobManager，JobManager 会根据</span></span><br><span class="line"><span class="attr">JobGraph</span> <span class="string">生成对应的 ExecutionGraph。</span></span><br><span class="line"><span class="attr">ExecutionGraph</span> <span class="string">是 Flink 作业调度时使用到的核⼀数据结构，它包含每一个并⼀的 task、每⼀个 intermediate stream 以及它们之间的关系。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">以</span> <span class="string">per-job 模式为例，分析 ExecutionGraph 的生成逻辑：</span></span><br><span class="line"></span><br><span class="line"><span class="meta">在</span> <span class="string">Dispacher 创建 JobManagerRunner 时，调用 createJobManagerRunner：</span></span><br><span class="line">=<span class="meta">&gt;</span> <span class="string">createJobManagerRunner()</span></span><br><span class="line">=<span class="meta">&gt;</span> <span class="string">new JobManagerRunnerImpl()</span></span><br><span class="line">=<span class="meta">&gt;</span> <span class="string">createJobMasterService()</span></span><br><span class="line">=<span class="meta">&gt;</span> <span class="string">new JobMaster()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">在创建</span> <span class="string">JobMaster 的时候，创建了 Scheduler 调度器</span></span><br><span class="line">=<span class="meta">&gt;</span> <span class="string">createScheduler()</span></span><br><span class="line">=<span class="meta">&gt;</span> <span class="string">createInstance()</span></span><br><span class="line">=<span class="meta">&gt;</span> <span class="string">new DefaultScheduler() #调度器</span></span><br><span class="line">=<span class="meta">&gt;</span> <span class="string">createAndRestoreExecutionGraph()</span></span><br><span class="line">=<span class="meta">&gt;</span> <span class="string">createExecutionGraph()</span></span><br><span class="line">=<span class="meta">&gt;</span> <span class="string">ExecutionGraphBuilder.buildGraph()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">下面是源码详细的跳转过程，可以直接略过，看后面</span> <span class="string">buildGraph（）方法的分析：</span></span><br></pre></td></tr></tbody></table></figure>

<p>Dispatcher.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runJob</span><span class="params">(JobGraph jobGraph, ExecutionType executionType)</span> </span>{</span><br><span class="line">   Preconditions.checkState(!runningJobs.containsKey(jobGraph.getJobID()));</span><br><span class="line">   <span class="keyword">long</span> initializationTimestamp = System.currentTimeMillis();</span><br><span class="line">   CompletableFuture&lt;JobManagerRunner&gt; jobManagerRunnerFuture = createJobManagerRunner(jobGraph, initializationTimestamp);</span><br><span class="line"></span><br><span class="line">   DispatcherJob dispatcherJob = DispatcherJob.createFor(</span><br><span class="line">         jobManagerRunnerFuture,</span><br><span class="line">         jobGraph.getJobID(),</span><br><span class="line">         jobGraph.getName(),</span><br><span class="line">         initializationTimestamp);</span><br><span class="line">   runningJobs.put(jobGraph.getJobID(), dispatcherJob);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> JobID jobId = jobGraph.getJobID();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> CompletableFuture&lt;CleanupJobState&gt; cleanupJobStateFuture = dispatcherJob.getResultFuture().handleAsync(</span><br><span class="line">      (dispatcherJobResult, throwable) -&gt; {</span><br><span class="line">         Preconditions.checkState(runningJobs.get(jobId) == dispatcherJob, <span class="string">"The job entry in runningJobs must be bound to the lifetime of the DispatcherJob."</span>);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (dispatcherJobResult != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> handleDispatcherJobResult(jobId, dispatcherJobResult, executionType);</span><br><span class="line">         } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> dispatcherJobFailed(jobId, throwable);</span><br><span class="line">         }</span><br><span class="line">      }, getMainThreadExecutor());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> CompletableFuture&lt;Void&gt; jobTerminationFuture = cleanupJobStateFuture</span><br><span class="line">      .thenApply(cleanupJobState -&gt; removeJob(jobId, cleanupJobState))</span><br><span class="line">      .thenCompose(Function.identity());</span><br><span class="line"></span><br><span class="line">   FutureUtils.assertNoException(jobTerminationFuture);</span><br><span class="line">   registerDispatcherJobTerminationFuture(jobId, jobTerminationFuture);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CompletableFuture&lt;JobManagerRunner&gt; <span class="title">createJobManagerRunner</span><span class="params">(JobGraph jobGraph, <span class="keyword">long</span> initializationTimestamp)</span> </span>{</span><br><span class="line">   <span class="keyword">final</span> RpcService rpcService = getRpcService();</span><br><span class="line">   <span class="keyword">return</span> CompletableFuture.supplyAsync(</span><br><span class="line">      () -&gt; {</span><br><span class="line">         <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">/*TODO 创建JobMaster */</span></span><br><span class="line">            JobManagerRunner runner = jobManagerRunnerFactory.createJobManagerRunner(</span><br><span class="line">               jobGraph,</span><br><span class="line">               configuration,</span><br><span class="line">               rpcService,</span><br><span class="line">               highAvailabilityServices,</span><br><span class="line">               heartbeatServices,</span><br><span class="line">               jobManagerSharedServices,</span><br><span class="line">               <span class="keyword">new</span> DefaultJobManagerJobMetricGroupFactory(jobManagerMetricGroup),</span><br><span class="line">               fatalErrorHandler,</span><br><span class="line">               initializationTimestamp);</span><br><span class="line">            <span class="comment">/*TODO 启动JobMaster*/</span></span><br><span class="line">            runner.start();</span><br><span class="line">            <span class="keyword">return</span> runner;</span><br><span class="line">         } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CompletionException(<span class="keyword">new</span> JobInitializationException(jobGraph.getJobID(), <span class="string">"Could not instantiate JobManager."</span>, e));</span><br><span class="line">         }</span><br><span class="line">      },</span><br><span class="line">      ioExecutor); <span class="comment">// do not use main thread executor. Otherwise, Dispatcher is blocked on JobManager creation</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>DefaultJobManagerRunnerFactory.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobManagerRunner <span class="title">createJobManagerRunner</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      JobGraph jobGraph,</span></span></span><br><span class="line"><span class="params"><span class="function">      Configuration configuration,</span></span></span><br><span class="line"><span class="params"><span class="function">      RpcService rpcService,</span></span></span><br><span class="line"><span class="params"><span class="function">      HighAvailabilityServices highAvailabilityServices,</span></span></span><br><span class="line"><span class="params"><span class="function">      HeartbeatServices heartbeatServices,</span></span></span><br><span class="line"><span class="params"><span class="function">      JobManagerSharedServices jobManagerServices,</span></span></span><br><span class="line"><span class="params"><span class="function">      JobManagerJobMetricGroupFactory jobManagerJobMetricGroupFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">      FatalErrorHandler fatalErrorHandler,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">long</span> initializationTimestamp)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> JobMasterConfiguration jobMasterConfiguration = JobMasterConfiguration.fromConfiguration(configuration);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> SlotPoolFactory slotPoolFactory = SlotPoolFactory.fromConfiguration(configuration);</span><br><span class="line">   <span class="keyword">final</span> SchedulerNGFactory schedulerNGFactory = SchedulerNGFactoryFactory.createSchedulerNGFactory(configuration);</span><br><span class="line">   <span class="keyword">final</span> ShuffleMaster&lt;?&gt; shuffleMaster = ShuffleServiceLoader.loadShuffleServiceFactory(configuration).createShuffleMaster(configuration);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> JobMasterServiceFactory jobMasterFactory = <span class="keyword">new</span> DefaultJobMasterServiceFactory(</span><br><span class="line">      jobMasterConfiguration,</span><br><span class="line">      slotPoolFactory,</span><br><span class="line">      rpcService,</span><br><span class="line">      highAvailabilityServices,</span><br><span class="line">      jobManagerServices,</span><br><span class="line">      heartbeatServices,</span><br><span class="line">      jobManagerJobMetricGroupFactory,</span><br><span class="line">      fatalErrorHandler,</span><br><span class="line">      schedulerNGFactory,</span><br><span class="line">      shuffleMaster);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> JobManagerRunnerImpl(</span><br><span class="line">      jobGraph,</span><br><span class="line">      jobMasterFactory,</span><br><span class="line">      highAvailabilityServices,</span><br><span class="line">      jobManagerServices.getLibraryCacheManager().registerClassLoaderLease(jobGraph.getJobID()),</span><br><span class="line">      jobManagerServices.getScheduledExecutorService(),</span><br><span class="line">      fatalErrorHandler,</span><br><span class="line">      initializationTimestamp);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>JobManagerRunnerImpl.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobManagerRunnerImpl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> JobGraph jobGraph,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> JobMasterServiceFactory jobMasterFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> HighAvailabilityServices haServices,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> LibraryCacheManager.ClassLoaderLease classLoaderLease,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> Executor executor,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> FatalErrorHandler fatalErrorHandler,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">long</span> initializationTimestamp)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.resultFuture = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line">   <span class="keyword">this</span>.terminationFuture = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line">   <span class="keyword">this</span>.leadershipOperation = CompletableFuture.completedFuture(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.jobGraph = checkNotNull(jobGraph);</span><br><span class="line">   <span class="keyword">this</span>.classLoaderLease = checkNotNull(classLoaderLease);</span><br><span class="line">   <span class="keyword">this</span>.executor = checkNotNull(executor);</span><br><span class="line">   <span class="keyword">this</span>.fatalErrorHandler = checkNotNull(fatalErrorHandler);</span><br><span class="line"></span><br><span class="line">   checkArgument(jobGraph.getNumberOfVertices() &gt; <span class="number">0</span>, <span class="string">"The given job is empty"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// libraries and class loader first</span></span><br><span class="line">   <span class="keyword">final</span> ClassLoader userCodeLoader;</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      userCodeLoader = classLoaderLease.getOrResolveClassLoader(</span><br><span class="line">         jobGraph.getUserJarBlobKeys(),</span><br><span class="line">         jobGraph.getClasspaths()).asClassLoader();</span><br><span class="line">   } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Cannot set up the user code libraries: "</span> + e.getMessage(), e);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// high availability services next</span></span><br><span class="line">   <span class="keyword">this</span>.runningJobsRegistry = haServices.getRunningJobsRegistry();</span><br><span class="line">   <span class="keyword">this</span>.leaderElectionService = haServices.getJobManagerLeaderElectionService(jobGraph.getJobID());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.leaderGatewayFuture = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// now start the JobManager</span></span><br><span class="line">   <span class="keyword">this</span>.jobMasterService = jobMasterFactory.createJobMasterService(jobGraph, <span class="keyword">this</span>, userCodeLoader, initializationTimestamp);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>DefaultJobManagerRunnerFactory.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobMaster <span class="title">createJobMasterService</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      JobGraph jobGraph,</span></span></span><br><span class="line"><span class="params"><span class="function">      OnCompletionActions jobCompletionActions,</span></span></span><br><span class="line"><span class="params"><span class="function">      ClassLoader userCodeClassloader,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">long</span> initializationTimestamp)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> JobMaster(</span><br><span class="line">      rpcService,</span><br><span class="line">      jobMasterConfiguration,</span><br><span class="line">      ResourceID.generate(),</span><br><span class="line">      jobGraph,</span><br><span class="line">      haServices,</span><br><span class="line">      slotPoolFactory,</span><br><span class="line">      jobManagerSharedServices,</span><br><span class="line">      heartbeatServices,</span><br><span class="line">      jobManagerJobMetricGroupFactory,</span><br><span class="line">      jobCompletionActions,</span><br><span class="line">      fatalErrorHandler,</span><br><span class="line">      userCodeClassloader,</span><br><span class="line">      schedulerNGFactory,</span><br><span class="line">      shuffleMaster,</span><br><span class="line">      lookup -&gt; <span class="keyword">new</span> JobMasterPartitionTrackerImpl(</span><br><span class="line">         jobGraph.getJobID(),</span><br><span class="line">         shuffleMaster,</span><br><span class="line">         lookup</span><br><span class="line">      ),</span><br><span class="line">      <span class="keyword">new</span> DefaultExecutionDeploymentTracker(),</span><br><span class="line">      DefaultExecutionDeploymentReconciler::<span class="keyword">new</span>,</span><br><span class="line">      initializationTimestamp);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>JobMaster.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobMaster</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      RpcService rpcService,</span></span></span><br><span class="line"><span class="params"><span class="function">      JobMasterConfiguration jobMasterConfiguration,</span></span></span><br><span class="line"><span class="params"><span class="function">      ResourceID resourceId,</span></span></span><br><span class="line"><span class="params"><span class="function">      JobGraph jobGraph,</span></span></span><br><span class="line"><span class="params"><span class="function">      HighAvailabilityServices highAvailabilityService,</span></span></span><br><span class="line"><span class="params"><span class="function">      SlotPoolFactory slotPoolFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">      JobManagerSharedServices jobManagerSharedServices,</span></span></span><br><span class="line"><span class="params"><span class="function">      HeartbeatServices heartbeatServices,</span></span></span><br><span class="line"><span class="params"><span class="function">      JobManagerJobMetricGroupFactory jobMetricGroupFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">      OnCompletionActions jobCompletionActions,</span></span></span><br><span class="line"><span class="params"><span class="function">      FatalErrorHandler fatalErrorHandler,</span></span></span><br><span class="line"><span class="params"><span class="function">      ClassLoader userCodeLoader,</span></span></span><br><span class="line"><span class="params"><span class="function">      SchedulerNGFactory schedulerNGFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">      ShuffleMaster&lt;?&gt; shuffleMaster,</span></span></span><br><span class="line"><span class="params"><span class="function">      PartitionTrackerFactory partitionTrackerFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">      ExecutionDeploymentTracker executionDeploymentTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">      ExecutionDeploymentReconciler.Factory executionDeploymentReconcilerFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">long</span> initializationTimestamp)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">super</span>(rpcService, AkkaRpcServiceUtils.createRandomName(JOB_MANAGER_NAME), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> ExecutionDeploymentReconciliationHandler executionStateReconciliationHandler = <span class="keyword">new</span> ExecutionDeploymentReconciliationHandler() {</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMissingDeploymentsOf</span><span class="params">(Collection&lt;ExecutionAttemptID&gt; executionAttemptIds, ResourceID host)</span> </span>{</span><br><span class="line">         log.debug(<span class="string">"Failing deployments {} due to no longer being deployed."</span>, executionAttemptIds);</span><br><span class="line">         <span class="keyword">for</span> (ExecutionAttemptID executionAttemptId : executionAttemptIds) {</span><br><span class="line">            schedulerNG.updateTaskExecutionState(<span class="keyword">new</span> TaskExecutionState(</span><br><span class="line">               jobGraph.getJobID(),</span><br><span class="line">               executionAttemptId,</span><br><span class="line">               ExecutionState.FAILED,</span><br><span class="line">               <span class="keyword">new</span> FlinkException(String.format(<span class="string">"Execution %s is unexpectedly no longer running on task executor %s."</span>, executionAttemptId, host))</span><br><span class="line">            ));</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUnknownDeploymentsOf</span><span class="params">(Collection&lt;ExecutionAttemptID&gt; executionAttemptIds, ResourceID host)</span> </span>{</span><br><span class="line">         log.debug(<span class="string">"Canceling left-over deployments {} on task executor {}."</span>, executionAttemptIds, host);</span><br><span class="line">         <span class="keyword">for</span> (ExecutionAttemptID executionAttemptId : executionAttemptIds) {</span><br><span class="line">            Tuple2&lt;TaskManagerLocation, TaskExecutorGateway&gt; taskManagerInfo = registeredTaskManagers.get(host);</span><br><span class="line">            <span class="keyword">if</span> (taskManagerInfo != <span class="keyword">null</span>) {</span><br><span class="line">               taskManagerInfo.f1.cancelTask(executionAttemptId, rpcTimeout);</span><br><span class="line">            }</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   };</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.executionDeploymentTracker = executionDeploymentTracker;</span><br><span class="line">   <span class="keyword">this</span>.executionDeploymentReconciler = executionDeploymentReconcilerFactory.create(executionStateReconciliationHandler);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.jobMasterConfiguration = checkNotNull(jobMasterConfiguration);</span><br><span class="line">   <span class="keyword">this</span>.resourceId = checkNotNull(resourceId);</span><br><span class="line">   <span class="keyword">this</span>.jobGraph = checkNotNull(jobGraph);</span><br><span class="line">   <span class="keyword">this</span>.rpcTimeout = jobMasterConfiguration.getRpcTimeout();</span><br><span class="line">   <span class="keyword">this</span>.highAvailabilityServices = checkNotNull(highAvailabilityService);</span><br><span class="line">   <span class="keyword">this</span>.blobWriter = jobManagerSharedServices.getBlobWriter();</span><br><span class="line">   <span class="keyword">this</span>.scheduledExecutorService = jobManagerSharedServices.getScheduledExecutorService();</span><br><span class="line">   <span class="keyword">this</span>.jobCompletionActions = checkNotNull(jobCompletionActions);</span><br><span class="line">   <span class="keyword">this</span>.fatalErrorHandler = checkNotNull(fatalErrorHandler);</span><br><span class="line">   <span class="keyword">this</span>.userCodeLoader = checkNotNull(userCodeLoader);</span><br><span class="line">   <span class="keyword">this</span>.schedulerNGFactory = checkNotNull(schedulerNGFactory);</span><br><span class="line">   <span class="keyword">this</span>.heartbeatServices = checkNotNull(heartbeatServices);</span><br><span class="line">   <span class="keyword">this</span>.jobMetricGroupFactory = checkNotNull(jobMetricGroupFactory);</span><br><span class="line">   <span class="keyword">this</span>.initializationTimestamp = initializationTimestamp;</span><br><span class="line">   <span class="keyword">this</span>.retrieveTaskManagerHostName = jobMasterConfiguration.getConfiguration()</span><br><span class="line">         .getBoolean(JobManagerOptions.RETRIEVE_TASK_MANAGER_HOSTNAME);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> String jobName = jobGraph.getName();</span><br><span class="line">   <span class="keyword">final</span> JobID jid = jobGraph.getJobID();</span><br><span class="line"></span><br><span class="line">   log.info(<span class="string">"Initializing job {} ({})."</span>, jobName, jid);</span><br><span class="line"></span><br><span class="line">   resourceManagerLeaderRetriever = highAvailabilityServices.getResourceManagerLeaderRetriever();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.slotPool = checkNotNull(slotPoolFactory).createSlotPool(jid);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.registeredTaskManagers = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">   <span class="keyword">this</span>.partitionTracker = checkNotNull(partitionTrackerFactory)</span><br><span class="line">      .create(resourceID -&gt; {</span><br><span class="line">         Tuple2&lt;TaskManagerLocation, TaskExecutorGateway&gt; taskManagerInfo = registeredTaskManagers.get(resourceID);</span><br><span class="line">         <span class="keyword">if</span> (taskManagerInfo == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> Optional.empty();</span><br><span class="line">         }</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> Optional.of(taskManagerInfo.f1);</span><br><span class="line">      });</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.backPressureStatsTracker = checkNotNull(jobManagerSharedServices.getBackPressureStatsTracker());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.shuffleMaster = checkNotNull(shuffleMaster);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.jobManagerJobMetricGroup = jobMetricGroupFactory.create(jobGraph);</span><br><span class="line">   <span class="comment">/*TODO 创建 调度器，创建的时候把 JobGraph转换成 ExecutionGraph*/</span></span><br><span class="line">   <span class="keyword">this</span>.schedulerNG = createScheduler(executionDeploymentTracker, jobManagerJobMetricGroup);</span><br><span class="line">   <span class="keyword">this</span>.jobStatusListener = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.resourceManagerConnection = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">this</span>.establishedResourceManagerConnection = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.accumulators = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   <span class="keyword">this</span>.taskManagerHeartbeatManager = NoOpHeartbeatManager.getInstance();</span><br><span class="line">   <span class="keyword">this</span>.resourceManagerHeartbeatManager = NoOpHeartbeatManager.getInstance();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SchedulerNG <span class="title">createScheduler</span><span class="params">(ExecutionDeploymentTracker executionDeploymentTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">final</span> JobManagerJobMetricGroup jobManagerJobMetricGroup)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">   <span class="keyword">return</span> schedulerNGFactory.createInstance(</span><br><span class="line">      log,</span><br><span class="line">      jobGraph,</span><br><span class="line">      backPressureStatsTracker,</span><br><span class="line">      scheduledExecutorService,</span><br><span class="line">      jobMasterConfiguration.getConfiguration(),</span><br><span class="line">      slotPool,</span><br><span class="line">      scheduledExecutorService,</span><br><span class="line">      userCodeLoader,</span><br><span class="line">      highAvailabilityServices.getCheckpointRecoveryFactory(),</span><br><span class="line">      rpcTimeout,</span><br><span class="line">      blobWriter,</span><br><span class="line">      jobManagerJobMetricGroup,</span><br><span class="line">      jobMasterConfiguration.getSlotRequestTimeout(),</span><br><span class="line">      shuffleMaster,</span><br><span class="line">      partitionTracker,</span><br><span class="line">      executionDeploymentTracker,</span><br><span class="line">      initializationTimestamp);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>DefaultSchedulerFactory.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SchedulerNG <span class="title">createInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> Logger log,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> JobGraph jobGraph,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> BackPressureStatsTracker backPressureStatsTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> Executor ioExecutor,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> Configuration jobMasterConfiguration,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> SlotPool slotPool,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> ScheduledExecutorService futureExecutor,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> ClassLoader userCodeLoader,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> CheckpointRecoveryFactory checkpointRecoveryFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> Time rpcTimeout,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> BlobWriter blobWriter,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> JobManagerJobMetricGroup jobManagerJobMetricGroup,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> Time slotRequestTimeout,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> ShuffleMaster&lt;?&gt; shuffleMaster,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> JobMasterPartitionTracker partitionTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> ExecutionDeploymentTracker executionDeploymentTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">long</span> initializationTimestamp)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> DefaultSchedulerComponents schedulerComponents = createSchedulerComponents(</span><br><span class="line">      jobGraph.getScheduleMode(),</span><br><span class="line">      jobGraph.isApproximateLocalRecoveryEnabled(),</span><br><span class="line">      jobMasterConfiguration,</span><br><span class="line">      slotPool,</span><br><span class="line">      slotRequestTimeout);</span><br><span class="line">   <span class="keyword">final</span> RestartBackoffTimeStrategy restartBackoffTimeStrategy = RestartBackoffTimeStrategyFactoryLoader</span><br><span class="line">      .createRestartBackoffTimeStrategyFactory(</span><br><span class="line">         jobGraph</span><br><span class="line">            .getSerializedExecutionConfig()</span><br><span class="line">            .deserializeValue(userCodeLoader)</span><br><span class="line">            .getRestartStrategy(),</span><br><span class="line">         jobMasterConfiguration,</span><br><span class="line">         jobGraph.isCheckpointingEnabled())</span><br><span class="line">      .create();</span><br><span class="line">   log.info(<span class="string">"Using restart back off time strategy {} for {} ({})."</span>, restartBackoffTimeStrategy, jobGraph.getName(), jobGraph.getJobID());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> DefaultScheduler(</span><br><span class="line">      log,</span><br><span class="line">      jobGraph,</span><br><span class="line">      backPressureStatsTracker,</span><br><span class="line">      ioExecutor,</span><br><span class="line">      jobMasterConfiguration,</span><br><span class="line">      schedulerComponents.getStartUpAction(),</span><br><span class="line">      futureExecutor,</span><br><span class="line">      <span class="keyword">new</span> ScheduledExecutorServiceAdapter(futureExecutor),</span><br><span class="line">      userCodeLoader,</span><br><span class="line">      checkpointRecoveryFactory,</span><br><span class="line">      rpcTimeout,</span><br><span class="line">      blobWriter,</span><br><span class="line">      jobManagerJobMetricGroup,</span><br><span class="line">      shuffleMaster,</span><br><span class="line">      partitionTracker,</span><br><span class="line">      schedulerComponents.getSchedulingStrategyFactory(),</span><br><span class="line">      FailoverStrategyFactoryLoader.loadFailoverStrategyFactory(jobMasterConfiguration),</span><br><span class="line">      restartBackoffTimeStrategy,</span><br><span class="line">      <span class="keyword">new</span> DefaultExecutionVertexOperations(),</span><br><span class="line">      <span class="keyword">new</span> ExecutionVertexVersioner(),</span><br><span class="line">      schedulerComponents.getAllocatorFactory(),</span><br><span class="line">      executionDeploymentTracker,</span><br><span class="line">      initializationTimestamp);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>SchedulerBase.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SchedulerBase</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> Logger log,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> JobGraph jobGraph,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> BackPressureStatsTracker backPressureStatsTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> Executor ioExecutor,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> Configuration jobMasterConfiguration,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> SlotProvider slotProvider,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> ScheduledExecutorService futureExecutor,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> ClassLoader userCodeLoader,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> CheckpointRecoveryFactory checkpointRecoveryFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> Time rpcTimeout,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> RestartStrategyFactory restartStrategyFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> BlobWriter blobWriter,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> JobManagerJobMetricGroup jobManagerJobMetricGroup,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> Time slotRequestTimeout,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> ShuffleMaster&lt;?&gt; shuffleMaster,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> JobMasterPartitionTracker partitionTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> ExecutionVertexVersioner executionVertexVersioner,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> ExecutionDeploymentTracker executionDeploymentTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> <span class="keyword">boolean</span> legacyScheduling,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">long</span> initializationTimestamp)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.log = checkNotNull(log);</span><br><span class="line">   <span class="keyword">this</span>.jobGraph = checkNotNull(jobGraph);</span><br><span class="line">   <span class="keyword">this</span>.backPressureStatsTracker = checkNotNull(backPressureStatsTracker);</span><br><span class="line">   <span class="keyword">this</span>.ioExecutor = checkNotNull(ioExecutor);</span><br><span class="line">   <span class="keyword">this</span>.jobMasterConfiguration = checkNotNull(jobMasterConfiguration);</span><br><span class="line">   <span class="keyword">this</span>.slotProvider = checkNotNull(slotProvider);</span><br><span class="line">   <span class="keyword">this</span>.futureExecutor = checkNotNull(futureExecutor);</span><br><span class="line">   <span class="keyword">this</span>.userCodeLoader = checkNotNull(userCodeLoader);</span><br><span class="line">   <span class="keyword">this</span>.checkpointRecoveryFactory = checkNotNull(checkpointRecoveryFactory);</span><br><span class="line">   <span class="keyword">this</span>.rpcTimeout = checkNotNull(rpcTimeout);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> RestartStrategies.RestartStrategyConfiguration restartStrategyConfiguration =</span><br><span class="line">      jobGraph.getSerializedExecutionConfig()</span><br><span class="line">         .deserializeValue(userCodeLoader)</span><br><span class="line">         .getRestartStrategy();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.restartStrategy = RestartStrategyResolving.resolve(restartStrategyConfiguration,</span><br><span class="line">      restartStrategyFactory,</span><br><span class="line">      jobGraph.isCheckpointingEnabled());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (legacyScheduling) {</span><br><span class="line">      log.info(<span class="string">"Using restart strategy {} for {} ({})."</span>, <span class="keyword">this</span>.restartStrategy, jobGraph.getName(), jobGraph.getJobID());</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.blobWriter = checkNotNull(blobWriter);</span><br><span class="line">   <span class="keyword">this</span>.jobManagerJobMetricGroup = checkNotNull(jobManagerJobMetricGroup);</span><br><span class="line">   <span class="keyword">this</span>.slotRequestTimeout = checkNotNull(slotRequestTimeout);</span><br><span class="line">   <span class="keyword">this</span>.executionVertexVersioner = checkNotNull(executionVertexVersioner);</span><br><span class="line">   <span class="keyword">this</span>.legacyScheduling = legacyScheduling;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.executionGraph = createAndRestoreExecutionGraph(jobManagerJobMetricGroup, checkNotNull(shuffleMaster), checkNotNull(partitionTracker), checkNotNull(executionDeploymentTracker), initializationTimestamp);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.schedulingTopology = executionGraph.getSchedulingTopology();</span><br><span class="line"></span><br><span class="line">   stateLocationRetriever =</span><br><span class="line">      executionVertexId -&gt; getExecutionVertex(executionVertexId).getPreferredLocationBasedOnState();</span><br><span class="line">   inputsLocationsRetriever = <span class="keyword">new</span> ExecutionGraphToInputsLocationsRetrieverAdapter(executionGraph);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.coordinatorMap = createCoordinatorMap();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ExecutionGraph <span class="title">createAndRestoreExecutionGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">   JobManagerJobMetricGroup currentJobManagerJobMetricGroup,</span></span></span><br><span class="line"><span class="params"><span class="function">   ShuffleMaster&lt;?&gt; shuffleMaster,</span></span></span><br><span class="line"><span class="params"><span class="function">   JobMasterPartitionTracker partitionTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">   ExecutionDeploymentTracker executionDeploymentTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">long</span> initializationTimestamp)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   ExecutionGraph newExecutionGraph = createExecutionGraph(currentJobManagerJobMetricGroup, shuffleMaster, partitionTracker, executionDeploymentTracker, initializationTimestamp);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> CheckpointCoordinator checkpointCoordinator = newExecutionGraph.getCheckpointCoordinator();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (checkpointCoordinator != <span class="keyword">null</span>) {</span><br><span class="line">      <span class="comment">// check whether we find a valid checkpoint</span></span><br><span class="line">      <span class="keyword">if</span> (!checkpointCoordinator.restoreInitialCheckpointIfPresent(</span><br><span class="line">            <span class="keyword">new</span> HashSet&lt;&gt;(newExecutionGraph.getAllVertices().values()))) {</span><br><span class="line"></span><br><span class="line">         <span class="comment">// check whether we can restore from a savepoint</span></span><br><span class="line">         tryRestoreExecutionGraphFromSavepoint(newExecutionGraph, jobGraph.getSavepointRestoreSettings());</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> newExecutionGraph;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来，分析生成 ExecutionGraph 的核心逻辑：</p>
<p>ExecutionGraphBuilder.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutionGraph <span class="title">buildGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Nullable</span> ExecutionGraph prior,</span></span></span><br><span class="line"><span class="params"><span class="function">      JobGraph jobGraph,</span></span></span><br><span class="line"><span class="params"><span class="function">      Configuration jobManagerConfig,</span></span></span><br><span class="line"><span class="params"><span class="function">      ScheduledExecutorService futureExecutor,</span></span></span><br><span class="line"><span class="params"><span class="function">      Executor ioExecutor,</span></span></span><br><span class="line"><span class="params"><span class="function">      SlotProvider slotProvider,</span></span></span><br><span class="line"><span class="params"><span class="function">      ClassLoader classLoader,</span></span></span><br><span class="line"><span class="params"><span class="function">      CheckpointRecoveryFactory recoveryFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">      Time rpcTimeout,</span></span></span><br><span class="line"><span class="params"><span class="function">      RestartStrategy restartStrategy,</span></span></span><br><span class="line"><span class="params"><span class="function">      MetricGroup metrics,</span></span></span><br><span class="line"><span class="params"><span class="function">      BlobWriter blobWriter,</span></span></span><br><span class="line"><span class="params"><span class="function">      Time allocationTimeout,</span></span></span><br><span class="line"><span class="params"><span class="function">      Logger log,</span></span></span><br><span class="line"><span class="params"><span class="function">      ShuffleMaster&lt;?&gt; shuffleMaster,</span></span></span><br><span class="line"><span class="params"><span class="function">      JobMasterPartitionTracker partitionTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">long</span> initializationTimestamp)</span> <span class="keyword">throws</span> JobExecutionException, JobException </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> FailoverStrategy.Factory failoverStrategy =</span><br><span class="line">      FailoverStrategyLoader.loadFailoverStrategy(jobManagerConfig, log);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> buildGraph(</span><br><span class="line">      prior,</span><br><span class="line">      jobGraph,</span><br><span class="line">      jobManagerConfig,</span><br><span class="line">      futureExecutor,</span><br><span class="line">      ioExecutor,</span><br><span class="line">      slotProvider,</span><br><span class="line">      classLoader,</span><br><span class="line">      recoveryFactory,</span><br><span class="line">      rpcTimeout,</span><br><span class="line">      restartStrategy,</span><br><span class="line">      metrics,</span><br><span class="line">      blobWriter,</span><br><span class="line">      allocationTimeout,</span><br><span class="line">      log,</span><br><span class="line">      shuffleMaster,</span><br><span class="line">      partitionTracker,</span><br><span class="line">      failoverStrategy,</span><br><span class="line">      NoOpExecutionDeploymentListener.get(),</span><br><span class="line">      (execution, newState) -&gt; {},</span><br><span class="line">      initializationTimestamp);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutionGraph <span class="title">buildGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="meta">@Nullable</span> ExecutionGraph prior,</span></span></span><br><span class="line"><span class="params"><span class="function">   JobGraph jobGraph,</span></span></span><br><span class="line"><span class="params"><span class="function">   Configuration jobManagerConfig,</span></span></span><br><span class="line"><span class="params"><span class="function">   ScheduledExecutorService futureExecutor,</span></span></span><br><span class="line"><span class="params"><span class="function">   Executor ioExecutor,</span></span></span><br><span class="line"><span class="params"><span class="function">   SlotProvider slotProvider,</span></span></span><br><span class="line"><span class="params"><span class="function">   ClassLoader classLoader,</span></span></span><br><span class="line"><span class="params"><span class="function">   CheckpointRecoveryFactory recoveryFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">   Time rpcTimeout,</span></span></span><br><span class="line"><span class="params"><span class="function">   RestartStrategy restartStrategy,</span></span></span><br><span class="line"><span class="params"><span class="function">   MetricGroup metrics,</span></span></span><br><span class="line"><span class="params"><span class="function">   BlobWriter blobWriter,</span></span></span><br><span class="line"><span class="params"><span class="function">   Time allocationTimeout,</span></span></span><br><span class="line"><span class="params"><span class="function">   Logger log,</span></span></span><br><span class="line"><span class="params"><span class="function">   ShuffleMaster&lt;?&gt; shuffleMaster,</span></span></span><br><span class="line"><span class="params"><span class="function">   JobMasterPartitionTracker partitionTracker,</span></span></span><br><span class="line"><span class="params"><span class="function">   FailoverStrategy.Factory failoverStrategyFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">   ExecutionDeploymentListener executionDeploymentListener,</span></span></span><br><span class="line"><span class="params"><span class="function">   ExecutionStateUpdateListener executionStateUpdateListener,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">long</span> initializationTimestamp)</span> <span class="keyword">throws</span> JobExecutionException, JobException </span>{</span><br><span class="line"></span><br><span class="line">   checkNotNull(jobGraph, <span class="string">"job graph cannot be null"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> String jobName = jobGraph.getName();</span><br><span class="line">   <span class="keyword">final</span> JobID jobId = jobGraph.getJobID();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> JobInformation jobInformation = <span class="keyword">new</span> JobInformation(</span><br><span class="line">      jobId,</span><br><span class="line">      jobName,</span><br><span class="line">      jobGraph.getSerializedExecutionConfig(),</span><br><span class="line">      jobGraph.getJobConfiguration(),</span><br><span class="line">      jobGraph.getUserJarBlobKeys(),</span><br><span class="line">      jobGraph.getClasspaths());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> maxPriorAttemptsHistoryLength =</span><br><span class="line">         jobManagerConfig.getInteger(JobManagerOptions.MAX_ATTEMPTS_HISTORY_SIZE);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> PartitionReleaseStrategy.Factory partitionReleaseStrategyFactory =</span><br><span class="line">      PartitionReleaseStrategyFactoryLoader.loadPartitionReleaseStrategyFactory(jobManagerConfig);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// create a new execution graph, if none exists so far</span></span><br><span class="line">   <span class="keyword">final</span> ExecutionGraph executionGraph;</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// 如果不存在执⾏图，就创建⼀个新的执⾏图</span></span><br><span class="line">      executionGraph = (prior != <span class="keyword">null</span>) ? prior :</span><br><span class="line">         <span class="keyword">new</span> ExecutionGraph(</span><br><span class="line">            jobInformation,</span><br><span class="line">            futureExecutor,</span><br><span class="line">            ioExecutor,</span><br><span class="line">            rpcTimeout,</span><br><span class="line">            restartStrategy,</span><br><span class="line">            maxPriorAttemptsHistoryLength,</span><br><span class="line">            failoverStrategyFactory,</span><br><span class="line">            slotProvider,</span><br><span class="line">            classLoader,</span><br><span class="line">            blobWriter,</span><br><span class="line">            allocationTimeout,</span><br><span class="line">            partitionReleaseStrategyFactory,</span><br><span class="line">            shuffleMaster,</span><br><span class="line">            partitionTracker,</span><br><span class="line">            jobGraph.getScheduleMode(),</span><br><span class="line">            executionDeploymentListener,</span><br><span class="line">            executionStateUpdateListener,</span><br><span class="line">            initializationTimestamp);</span><br><span class="line">   } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Could not create the ExecutionGraph."</span>, e);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// set the basic properties</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      executionGraph.setJsonPlan(JsonPlanGenerator.generatePlan(jobGraph));</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">      log.warn(<span class="string">"Cannot create JSON plan for job"</span>, t);</span><br><span class="line">      <span class="comment">// give the graph an empty plan</span></span><br><span class="line">      executionGraph.setJsonPlan(<span class="string">"{}"</span>);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// initialize the vertices that have a master initialization hook</span></span><br><span class="line">   <span class="comment">// file output formats create directories here, input formats create splits</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">long</span> initMasterStart = System.nanoTime();</span><br><span class="line">   log.info(<span class="string">"Running initialization on master for job {} ({})."</span>, jobName, jobId);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (JobVertex vertex : jobGraph.getVertices()) {</span><br><span class="line">      String executableClass = vertex.getInvokableClassName();</span><br><span class="line">      <span class="keyword">if</span> (executableClass == <span class="keyword">null</span> || executableClass.isEmpty()) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> JobSubmissionException(jobId,</span><br><span class="line">               <span class="string">"The vertex "</span> + vertex.getID() + <span class="string">" ("</span> + vertex.getName() + <span class="string">") has no invokable class."</span>);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         vertex.initializeOnMaster(classLoader);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobId,</span><br><span class="line">                  <span class="string">"Cannot initialize task '"</span> + vertex.getName() + <span class="string">"': "</span> + t.getMessage(), t);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   log.info(<span class="string">"Successfully ran initialization on master in {} ms."</span>,</span><br><span class="line">         (System.nanoTime() - initMasterStart) / <span class="number">1_000_000</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// topologically sort the job vertices and attach the graph to the existing one</span></span><br><span class="line">   <span class="comment">/*TODO 对JobGraph进⾏拓扑排序，获取所有的JobVertex列表*/</span></span><br><span class="line">   List&lt;JobVertex&gt; sortedTopology = jobGraph.getVerticesSortedTopologicallyFromSources();</span><br><span class="line">   <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">      log.debug(<span class="string">"Adding {} vertices from job graph {} ({})."</span>, sortedTopology.size(), jobName, jobId);</span><br><span class="line">   }</span><br><span class="line">   <span class="comment">/*TODO 核心逻辑：将拓扑排序过的JobGraph添加到 executionGraph数据结构中。*/</span></span><br><span class="line">   executionGraph.attachJobGraph(sortedTopology);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">      log.debug(<span class="string">"Successfully created execution graph from job graph {} ({})."</span>, jobName, jobId);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// configure the state checkpointing</span></span><br><span class="line">   JobCheckpointingSettings snapshotSettings = jobGraph.getCheckpointingSettings();</span><br><span class="line">   <span class="keyword">if</span> (snapshotSettings != <span class="keyword">null</span>) {</span><br><span class="line">      List&lt;ExecutionJobVertex&gt; triggerVertices =</span><br><span class="line">            idToVertex(snapshotSettings.getVerticesToTrigger(), executionGraph);</span><br><span class="line"></span><br><span class="line">      List&lt;ExecutionJobVertex&gt; ackVertices =</span><br><span class="line">            idToVertex(snapshotSettings.getVerticesToAcknowledge(), executionGraph);</span><br><span class="line"></span><br><span class="line">      List&lt;ExecutionJobVertex&gt; confirmVertices =</span><br><span class="line">            idToVertex(snapshotSettings.getVerticesToConfirm(), executionGraph);</span><br><span class="line"></span><br><span class="line">      CompletedCheckpointStore completedCheckpoints;</span><br><span class="line">      CheckpointIDCounter checkpointIdCounter;</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         <span class="keyword">int</span> maxNumberOfCheckpointsToRetain = jobManagerConfig.getInteger(</span><br><span class="line">               CheckpointingOptions.MAX_RETAINED_CHECKPOINTS);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (maxNumberOfCheckpointsToRetain &lt;= <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">// warning and use 1 as the default value if the setting in</span></span><br><span class="line">            <span class="comment">// state.checkpoints.max-retained-checkpoints is not greater than 0.</span></span><br><span class="line">            log.warn(<span class="string">"The setting for '{} : {}' is invalid. Using default value of {}"</span>,</span><br><span class="line">                  CheckpointingOptions.MAX_RETAINED_CHECKPOINTS.key(),</span><br><span class="line">                  maxNumberOfCheckpointsToRetain,</span><br><span class="line">                  CheckpointingOptions.MAX_RETAINED_CHECKPOINTS.defaultValue());</span><br><span class="line"></span><br><span class="line">            maxNumberOfCheckpointsToRetain = CheckpointingOptions.MAX_RETAINED_CHECKPOINTS.defaultValue();</span><br><span class="line">         }</span><br><span class="line"></span><br><span class="line">         completedCheckpoints = recoveryFactory.createCheckpointStore(jobId, maxNumberOfCheckpointsToRetain, classLoader);</span><br><span class="line">         checkpointIdCounter = recoveryFactory.createCheckpointIDCounter(jobId);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobId, <span class="string">"Failed to initialize high-availability checkpoint handler"</span>, e);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Maximum number of remembered checkpoints</span></span><br><span class="line">      <span class="keyword">int</span> historySize = jobManagerConfig.getInteger(WebOptions.CHECKPOINTS_HISTORY_SIZE);</span><br><span class="line"></span><br><span class="line">      CheckpointStatsTracker checkpointStatsTracker = <span class="keyword">new</span> CheckpointStatsTracker(</span><br><span class="line">            historySize,</span><br><span class="line">            ackVertices,</span><br><span class="line">            snapshotSettings.getCheckpointCoordinatorConfiguration(),</span><br><span class="line">            metrics);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// load the state backend from the application settings</span></span><br><span class="line">      <span class="keyword">final</span> StateBackend applicationConfiguredBackend;</span><br><span class="line">      <span class="keyword">final</span> SerializedValue&lt;StateBackend&gt; serializedAppConfigured = snapshotSettings.getDefaultStateBackend();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (serializedAppConfigured == <span class="keyword">null</span>) {</span><br><span class="line">         applicationConfiguredBackend = <span class="keyword">null</span>;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span> {</span><br><span class="line">         <span class="keyword">try</span> {</span><br><span class="line">            applicationConfiguredBackend = serializedAppConfigured.deserializeValue(classLoader);</span><br><span class="line">         } <span class="keyword">catch</span> (IOException | ClassNotFoundException e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobId,</span><br><span class="line">                  <span class="string">"Could not deserialize application-defined state backend."</span>, e);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> StateBackend rootBackend;</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         rootBackend = StateBackendLoader.fromApplicationOrConfigOrDefault(</span><br><span class="line">               applicationConfiguredBackend, jobManagerConfig, classLoader, log);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">catch</span> (IllegalConfigurationException | IOException | DynamicCodeLoadingException e) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobId, <span class="string">"Could not instantiate configured state backend"</span>, e);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// instantiate the user-defined checkpoint hooks</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> SerializedValue&lt;MasterTriggerRestoreHook.Factory[]&gt; serializedHooks = snapshotSettings.getMasterHooks();</span><br><span class="line">      <span class="keyword">final</span> List&lt;MasterTriggerRestoreHook&lt;?&gt;&gt; hooks;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (serializedHooks == <span class="keyword">null</span>) {</span><br><span class="line">         hooks = Collections.emptyList();</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span> {</span><br><span class="line">         <span class="keyword">final</span> MasterTriggerRestoreHook.Factory[] hookFactories;</span><br><span class="line">         <span class="keyword">try</span> {</span><br><span class="line">            hookFactories = serializedHooks.deserializeValue(classLoader);</span><br><span class="line">         }</span><br><span class="line">         <span class="keyword">catch</span> (IOException | ClassNotFoundException e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobExecutionException(jobId, <span class="string">"Could not instantiate user-defined checkpoint hooks"</span>, e);</span><br><span class="line">         }</span><br><span class="line"></span><br><span class="line">         <span class="keyword">final</span> Thread thread = Thread.currentThread();</span><br><span class="line">         <span class="keyword">final</span> ClassLoader originalClassLoader = thread.getContextClassLoader();</span><br><span class="line">         thread.setContextClassLoader(classLoader);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">try</span> {</span><br><span class="line">            hooks = <span class="keyword">new</span> ArrayList&lt;&gt;(hookFactories.length);</span><br><span class="line">            <span class="keyword">for</span> (MasterTriggerRestoreHook.Factory factory : hookFactories) {</span><br><span class="line">               hooks.add(MasterHooks.wrapHook(factory.create(), classLoader));</span><br><span class="line">            }</span><br><span class="line">         }</span><br><span class="line">         <span class="keyword">finally</span> {</span><br><span class="line">            thread.setContextClassLoader(originalClassLoader);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> CheckpointCoordinatorConfiguration chkConfig = snapshotSettings.getCheckpointCoordinatorConfiguration();</span><br><span class="line"></span><br><span class="line">      executionGraph.enableCheckpointing(</span><br><span class="line">         chkConfig,</span><br><span class="line">         triggerVertices,</span><br><span class="line">         ackVertices,</span><br><span class="line">         confirmVertices,</span><br><span class="line">         hooks,</span><br><span class="line">         checkpointIdCounter,</span><br><span class="line">         completedCheckpoints,</span><br><span class="line">         rootBackend,</span><br><span class="line">         checkpointStatsTracker);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// create all the metrics for the Execution Graph</span></span><br><span class="line"></span><br><span class="line">   metrics.gauge(RestartTimeGauge.METRIC_NAME, <span class="keyword">new</span> RestartTimeGauge(executionGraph));</span><br><span class="line">   metrics.gauge(DownTimeGauge.METRIC_NAME, <span class="keyword">new</span> DownTimeGauge(executionGraph));</span><br><span class="line">   metrics.gauge(UpTimeGauge.METRIC_NAME, <span class="keyword">new</span> UpTimeGauge(executionGraph));</span><br><span class="line"></span><br><span class="line">   executionGraph.getFailoverStrategy().registerMetrics(metrics);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> executionGraph;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attachJobGraph</span><span class="params">(List&lt;JobVertex&gt; topologiallySorted)</span> <span class="keyword">throws</span> JobException </span>{</span><br><span class="line"></span><br><span class="line">   assertRunningInJobMasterMainThread();</span><br><span class="line"></span><br><span class="line">   LOG.debug(<span class="string">"Attaching {} topologically sorted vertices to existing job graph with {} "</span> +</span><br><span class="line">         <span class="string">"vertices and {} intermediate results."</span>,</span><br><span class="line">      topologiallySorted.size(),</span><br><span class="line">      tasks.size(),</span><br><span class="line">      intermediateResults.size());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> ArrayList&lt;ExecutionJobVertex&gt; newExecJobVertices = <span class="keyword">new</span> ArrayList&lt;&gt;(topologiallySorted.size());</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">long</span> createTimestamp = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 遍历Job Vertex</span></span><br><span class="line">   <span class="keyword">for</span> (JobVertex jobVertex : topologiallySorted) {</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (jobVertex.isInputVertex() &amp;&amp; !jobVertex.isStoppable()) {</span><br><span class="line">         <span class="keyword">this</span>.isStoppable = <span class="keyword">false</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// create the execution job vertex and attach it to the graph</span></span><br><span class="line">      <span class="comment">/*TODO 实例化执行图节点，根据每⼀个job vertex，创建对应的 ExecutionVertex*/</span></span><br><span class="line">      ExecutionJobVertex ejv = <span class="keyword">new</span> ExecutionJobVertex(</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            jobVertex,</span><br><span class="line">            <span class="number">1</span>,</span><br><span class="line">            maxPriorAttemptsHistoryLength,</span><br><span class="line">            rpcTimeout,</span><br><span class="line">            globalModVersion,</span><br><span class="line">            createTimestamp);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*TODO 核心逻辑：将创建的ExecutionJobVertex与前置的IntermediateResult连接起来*/</span></span><br><span class="line">      ejv.connectToPredecessors(<span class="keyword">this</span>.intermediateResults);</span><br><span class="line"></span><br><span class="line">      ExecutionJobVertex previousTask = <span class="keyword">this</span>.tasks.putIfAbsent(jobVertex.getID(), ejv);</span><br><span class="line">      <span class="keyword">if</span> (previousTask != <span class="keyword">null</span>) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> JobException(String.format(<span class="string">"Encountered two job vertices with ID %s : previous=[%s] / new=[%s]"</span>,</span><br><span class="line">            jobVertex.getID(), ejv, previousTask));</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (IntermediateResult res : ejv.getProducedDataSets()) {</span><br><span class="line">         IntermediateResult previousDataSet = <span class="keyword">this</span>.intermediateResults.putIfAbsent(res.getId(), res);</span><br><span class="line">         <span class="keyword">if</span> (previousDataSet != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobException(String.format(<span class="string">"Encountered two intermediate data set with ID %s : previous=[%s] / new=[%s]"</span>,</span><br><span class="line">               res.getId(), res, previousDataSet));</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.verticesInCreationOrder.add(ejv);</span><br><span class="line">      <span class="comment">// 节点总数量需要加上当前执行图节点的并⾏度，因为执行图是作业图的并行化版本</span></span><br><span class="line">      <span class="keyword">this</span>.numVerticesTotal += ejv.getParallelism();</span><br><span class="line">      <span class="comment">/*TODO 将当前执⾏图节点加⼊到图中*/</span></span><br><span class="line">      newExecJobVertices.add(ejv);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// the topology assigning should happen before notifying new vertices to failoverStrategy</span></span><br><span class="line">   executionTopology = DefaultExecutionTopology.fromExecutionGraph(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">   failoverStrategy.notifyNewVertices(newExecJobVertices);</span><br><span class="line"></span><br><span class="line">   partitionReleaseStrategy = partitionReleaseStrategyFactory.createInstance(getSchedulingTopology());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">ExecutionJobVertex(</span><br><span class="line">      ExecutionGraph graph,</span><br><span class="line">      JobVertex jobVertex,</span><br><span class="line">      <span class="keyword">int</span> defaultParallelism,</span><br><span class="line">      <span class="keyword">int</span> maxPriorAttemptsHistoryLength,</span><br><span class="line">      Time timeout,</span><br><span class="line">      <span class="keyword">long</span> initialGlobalModVersion,</span><br><span class="line">      <span class="keyword">long</span> createTimestamp) <span class="keyword">throws</span> JobException {</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (graph == <span class="keyword">null</span> || jobVertex == <span class="keyword">null</span>) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.graph = graph;</span><br><span class="line">   <span class="keyword">this</span>.jobVertex = jobVertex;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> vertexParallelism = jobVertex.getParallelism();</span><br><span class="line">   <span class="keyword">int</span> numTaskVertices = vertexParallelism &gt; <span class="number">0</span> ? vertexParallelism : defaultParallelism;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> configuredMaxParallelism = jobVertex.getMaxParallelism();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.maxParallelismConfigured = (VALUE_NOT_SET != configuredMaxParallelism);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// if no max parallelism was configured by the user, we calculate and set a default</span></span><br><span class="line">   setMaxParallelismInternal(maxParallelismConfigured ?</span><br><span class="line">         configuredMaxParallelism : KeyGroupRangeAssignment.computeDefaultMaxParallelism(numTaskVertices));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// verify that our parallelism is not higher than the maximum parallelism</span></span><br><span class="line">   <span class="keyword">if</span> (numTaskVertices &gt; maxParallelism) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobException(</span><br><span class="line">         String.format(<span class="string">"Vertex %s's parallelism (%s) is higher than the max parallelism (%s). Please lower the parallelism or increase the max parallelism."</span>,</span><br><span class="line">            jobVertex.getName(),</span><br><span class="line">            numTaskVertices,</span><br><span class="line">            maxParallelism));</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.parallelism = numTaskVertices;</span><br><span class="line">   <span class="keyword">this</span>.resourceProfile = ResourceProfile.fromResourceSpec(jobVertex.getMinResources(), MemorySize.ZERO);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.taskVertices = <span class="keyword">new</span> ExecutionVertex[numTaskVertices];</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.inputs = <span class="keyword">new</span> ArrayList&lt;&gt;(jobVertex.getInputs().size());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// take the sharing group</span></span><br><span class="line">   <span class="keyword">this</span>.slotSharingGroup = checkNotNull(jobVertex.getSlotSharingGroup());</span><br><span class="line">   <span class="keyword">this</span>.coLocationGroup = jobVertex.getCoLocationGroup();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// create the intermediate results</span></span><br><span class="line">   <span class="keyword">this</span>.producedDataSets = <span class="keyword">new</span> IntermediateResult[jobVertex.getNumberOfProducedIntermediateDataSets()];</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jobVertex.getProducedDataSets().size(); i++) {</span><br><span class="line">      <span class="keyword">final</span> IntermediateDataSet result = jobVertex.getProducedDataSets().get(i);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.producedDataSets[i] = <span class="keyword">new</span> IntermediateResult(</span><br><span class="line">            result.getId(),</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            numTaskVertices,</span><br><span class="line">            result.getResultType());</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// create all task vertices</span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numTaskVertices; i++) {</span><br><span class="line">      ExecutionVertex vertex = <span class="keyword">new</span> ExecutionVertex(</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            i,</span><br><span class="line">            producedDataSets,</span><br><span class="line">            timeout,</span><br><span class="line">            initialGlobalModVersion,</span><br><span class="line">            createTimestamp,</span><br><span class="line">            maxPriorAttemptsHistoryLength);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.taskVertices[i] = vertex;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// sanity check for the double referencing between intermediate result partitions and execution vertices</span></span><br><span class="line">   <span class="keyword">for</span> (IntermediateResult ir : <span class="keyword">this</span>.producedDataSets) {</span><br><span class="line">      <span class="keyword">if</span> (ir.getNumberOfAssignedPartitions() != parallelism) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"The intermediate result's partitions were not correctly assigned."</span>);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> List&lt;SerializedValue&lt;OperatorCoordinator.Provider&gt;&gt; coordinatorProviders = getJobVertex().getOperatorCoordinators();</span><br><span class="line">   <span class="keyword">if</span> (coordinatorProviders.isEmpty()) {</span><br><span class="line">      <span class="keyword">this</span>.operatorCoordinators = Collections.emptyList();</span><br><span class="line">   } <span class="keyword">else</span> {</span><br><span class="line">      <span class="keyword">final</span> ArrayList&lt;OperatorCoordinatorHolder&gt; coordinators = <span class="keyword">new</span> ArrayList&lt;&gt;(coordinatorProviders.size());</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">final</span> SerializedValue&lt;OperatorCoordinator.Provider&gt; provider : coordinatorProviders) {</span><br><span class="line">            coordinators.add(OperatorCoordinatorHolder.create(provider, <span class="keyword">this</span>, graph.getUserClassLoader()));</span><br><span class="line">         }</span><br><span class="line">      } <span class="keyword">catch</span> (Exception | LinkageError e) {</span><br><span class="line">         IOUtils.closeAllQuietly(coordinators);</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Cannot instantiate the coordinator for operator "</span> + getName(), e);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">this</span>.operatorCoordinators = Collections.unmodifiableList(coordinators);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// set up the input splits, if the vertex has any</span></span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="meta">@SuppressWarnings("unchecked")</span></span><br><span class="line">      InputSplitSource&lt;InputSplit&gt; splitSource = (InputSplitSource&lt;InputSplit&gt;) jobVertex.getInputSplitSource();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (splitSource != <span class="keyword">null</span>) {</span><br><span class="line">         Thread currentThread = Thread.currentThread();</span><br><span class="line">         ClassLoader oldContextClassLoader = currentThread.getContextClassLoader();</span><br><span class="line">         currentThread.setContextClassLoader(graph.getUserClassLoader());</span><br><span class="line">         <span class="keyword">try</span> {</span><br><span class="line">            inputSplits = splitSource.createInputSplits(numTaskVertices);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (inputSplits != <span class="keyword">null</span>) {</span><br><span class="line">               splitAssigner = splitSource.getInputSplitAssigner(inputSplits);</span><br><span class="line">            }</span><br><span class="line">         } <span class="keyword">finally</span> {</span><br><span class="line">            currentThread.setContextClassLoader(oldContextClassLoader);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span> {</span><br><span class="line">         inputSplits = <span class="keyword">null</span>;</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Creating the input splits caused an error: "</span> + t.getMessage(), t);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectToPredecessors</span><span class="params">(Map&lt;IntermediateDataSetID, IntermediateResult&gt; intermediateDataSets)</span> <span class="keyword">throws</span> JobException </span>{</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* TODO 获取输入的JobEdge列表 */</span></span><br><span class="line">   List&lt;JobEdge&gt; inputs = jobVertex.getInputs();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (LOG.isDebugEnabled()) {</span><br><span class="line">      LOG.debug(String.format(<span class="string">"Connecting ExecutionJobVertex %s (%s) to %d predecessors."</span>, jobVertex.getID(), jobVertex.getName(), inputs.size()));</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 遍历每条JobEdge</span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> num = <span class="number">0</span>; num &lt; inputs.size(); num++) {</span><br><span class="line">      JobEdge edge = inputs.get(num);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) {</span><br><span class="line">         <span class="keyword">if</span> (edge.getSource() == <span class="keyword">null</span>) {</span><br><span class="line">            LOG.debug(String.format(<span class="string">"Connecting input %d of vertex %s (%s) to intermediate result referenced via ID %s."</span>,</span><br><span class="line">                  num, jobVertex.getID(), jobVertex.getName(), edge.getSourceId()));</span><br><span class="line">         } <span class="keyword">else</span> {</span><br><span class="line">            LOG.debug(String.format(<span class="string">"Connecting input %d of vertex %s (%s) to intermediate result referenced via predecessor %s (%s)."</span>,</span><br><span class="line">                  num, jobVertex.getID(), jobVertex.getName(), edge.getSource().getProducer().getID(), edge.getSource().getProducer().getName()));</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// fetch the intermediate result via ID. if it does not exist, then it either has not been created, or the order</span></span><br><span class="line">      <span class="comment">// in which this method is called for the job vertices is not a topological order</span></span><br><span class="line">      <span class="comment">/*TODO 通过 ID获取当前JobEdge的输入所对应的 IntermediateResult*/</span></span><br><span class="line">      IntermediateResult ires = intermediateDataSets.get(edge.getSourceId());</span><br><span class="line">      <span class="keyword">if</span> (ires == <span class="keyword">null</span>) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Cannot connect this job graph to the previous graph. No previous intermediate result found for ID "</span></span><br><span class="line">               + edge.getSourceId());</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*TODO 将IntermediateResult加入到当前ExecutionJobVertex的输入中*/</span></span><br><span class="line">      <span class="keyword">this</span>.inputs.add(ires);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*TODO 为 IntermediateResult 注册 consumer，就是当前节点*/</span></span><br><span class="line">      <span class="keyword">int</span> consumerIndex = ires.registerConsumer();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 由于每⼀个并行度都对应⼀个节点。所以要把每个节点都和前面中间结果相连。</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parallelism; i++) {</span><br><span class="line">         ExecutionVertex ev = taskVertices[i];</span><br><span class="line">         <span class="comment">/*TODO 将 ExecutionVertex与 IntermediateResult关联起来*/</span></span><br><span class="line">         ev.connectSource(num, ires, edge, consumerIndex);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectSource</span><span class="params">(<span class="keyword">int</span> inputNumber, IntermediateResult source, JobEdge edge, <span class="keyword">int</span> consumerNumber)</span> </span>{</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 只有forward的方式的情况下，pattern才是 POINTWISE的，否则均为 ALL_TO_ALL</span></span><br><span class="line">   <span class="keyword">final</span> DistributionPattern pattern = edge.getDistributionPattern();</span><br><span class="line">   <span class="keyword">final</span> IntermediateResultPartition[] sourcePartitions = source.getPartitions();</span><br><span class="line"></span><br><span class="line">   ExecutionEdge[] edges;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">switch</span> (pattern) {</span><br><span class="line">      <span class="keyword">case</span> POINTWISE:</span><br><span class="line">         edges = connectPointwise(sourcePartitions, inputNumber);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> ALL_TO_ALL:</span><br><span class="line">         edges = connectAllToAll(sourcePartitions, inputNumber);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unrecognized distribution pattern."</span>);</span><br><span class="line"></span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   inputEdges[inputNumber] = edges;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// add the consumers to the source</span></span><br><span class="line">   <span class="comment">// for now (until the receiver initiated handshake is in place), we need to register the</span></span><br><span class="line">   <span class="comment">// edges as the execution graph</span></span><br><span class="line">   <span class="comment">/*TODO 为IntermediateResultPartition添加consumer，即关联到ExecutionEdge上（之前已经为IntermediateResult添加了consumer）*/</span></span><br><span class="line">   <span class="keyword">for</span> (ExecutionEdge ee : edges) {</span><br><span class="line">      ee.getSource().addConsumer(ee, consumerNumber);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ExecutionEdge[] connectAllToAll(IntermediateResultPartition[] sourcePartitions, <span class="keyword">int</span> inputNumber) {</span><br><span class="line">   ExecutionEdge[] edges = <span class="keyword">new</span> ExecutionEdge[sourcePartitions.length];</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sourcePartitions.length; i++) {</span><br><span class="line">      IntermediateResultPartition irp = sourcePartitions[i];</span><br><span class="line">      edges[i] = <span class="keyword">new</span> ExecutionEdge(irp, <span class="keyword">this</span>, inputNumber);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> edges;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>看这个方法之前，需要知道，ExecutionVertex 的 inputEdges 变量，是一个二维数据。它 表示了这个 ExecutionVertex 上每一个 input 所包含的 ExecutionEdge 列表。 即，如果 ExecutionVertex 有两个不同的输入：输入 A 和 B。其中输入 A 的 partition=1， 输 入 B 的 partition=8 ， 那 么 这 个 二 维 数 组 inputEdges 如 下 如 下 ( 以 irp 代 替 IntermediateResultPartition)</p>
<p>[ ExecutionEdge[ A.irp[0]] ]  </p>
<p>[ ExecutionEdge[ B.irp[0], B.irp[1], …, B.irp[7] ]</p>
<h3 id="5-6-物理执行图（Task-的调度和执行）"><a href="#5-6-物理执行图（Task-的调度和执行）" class="headerlink" title="5.6 物理执行图（Task 的调度和执行）"></a>5.6 物理执行图（Task 的调度和执行）</h3><p>接着进行调度的源码分析</p>
<p>JobMaster.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Acknowledge <span class="title">startJobExecution</span><span class="params">(JobMasterId newJobMasterId)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   validateRunsInMainThread();</span><br><span class="line"></span><br><span class="line">   checkNotNull(newJobMasterId, <span class="string">"The new JobMasterId must not be null."</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (Objects.equals(getFencingToken(), newJobMasterId)) {</span><br><span class="line">      log.info(<span class="string">"Already started the job execution with JobMasterId {}."</span>, newJobMasterId);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> Acknowledge.get();</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   setNewFencingToken(newJobMasterId);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*TODO 真正启动JobMaster服务*/</span></span><br><span class="line">   startJobMasterServices();</span><br><span class="line"></span><br><span class="line">   log.info(<span class="string">"Starting execution of job {} ({}) under job master id {}."</span>, jobGraph.getName(), jobGraph.getJobID(), newJobMasterId);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*TODO 重置和启动调度器*/</span></span><br><span class="line">   resetAndStartScheduler();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> Acknowledge.get();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetAndStartScheduler</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">   validateRunsInMainThread();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> CompletableFuture&lt;Void&gt; schedulerAssignedFuture;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (schedulerNG.requestJobStatus() == JobStatus.CREATED) {</span><br><span class="line">      schedulerAssignedFuture = CompletableFuture.completedFuture(<span class="keyword">null</span>);</span><br><span class="line">      schedulerNG.setMainThreadExecutor(getMainThreadExecutor());</span><br><span class="line">   } <span class="keyword">else</span> {</span><br><span class="line">      suspendAndClearSchedulerFields(<span class="keyword">new</span> FlinkException(<span class="string">"ExecutionGraph is being reset in order to be rescheduled."</span>));</span><br><span class="line">      <span class="keyword">final</span> JobManagerJobMetricGroup newJobManagerJobMetricGroup = jobMetricGroupFactory.create(jobGraph);</span><br><span class="line">      <span class="keyword">final</span> SchedulerNG newScheduler = createScheduler(executionDeploymentTracker, newJobManagerJobMetricGroup);</span><br><span class="line"></span><br><span class="line">      schedulerAssignedFuture = schedulerNG.getTerminationFuture().handle(</span><br><span class="line">         (ignored, throwable) -&gt; {</span><br><span class="line">            newScheduler.setMainThreadExecutor(getMainThreadExecutor());</span><br><span class="line">            assignScheduler(newScheduler, newJobManagerJobMetricGroup);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         }</span><br><span class="line">      );</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   FutureUtils.assertNoException(schedulerAssignedFuture.thenRun(<span class="keyword">this</span>::startScheduling));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startScheduling</span><span class="params">()</span> </span>{</span><br><span class="line">   checkState(jobStatusListener == <span class="keyword">null</span>);</span><br><span class="line">   <span class="comment">// register self as job status change listener</span></span><br><span class="line">   jobStatusListener = <span class="keyword">new</span> JobManagerJobStatusListener();</span><br><span class="line">   schedulerNG.registerJobStatusListener(jobStatusListener);</span><br><span class="line"></span><br><span class="line">   schedulerNG.startScheduling();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>DefaultScheduler.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startSchedulingInternal</span><span class="params">()</span> </span>{</span><br><span class="line">   log.info(<span class="string">"Starting scheduling with scheduling strategy [{}]"</span>, schedulingStrategy.getClass().getName());</span><br><span class="line">   prepareExecutionGraphForNgScheduling();</span><br><span class="line">   <span class="comment">// 新版本中，默认的调度策略是 PipelinedRegion</span></span><br><span class="line">   schedulingStrategy.startScheduling();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>PipelinedRegionSchedulingStrategy.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startScheduling</span><span class="params">()</span> </span>{</span><br><span class="line">   <span class="keyword">final</span> Set&lt;SchedulingPipelinedRegion&gt; sourceRegions = IterableUtils</span><br><span class="line">      .toStream(schedulingTopology.getAllPipelinedRegions())</span><br><span class="line">      .filter(region -&gt; !region.getConsumedResults().iterator().hasNext())</span><br><span class="line">      .collect(Collectors.toSet());</span><br><span class="line">   maybeScheduleRegions(sourceRegions);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeScheduleRegions</span><span class="params">(<span class="keyword">final</span> Set&lt;SchedulingPipelinedRegion&gt; regions)</span> </span>{</span><br><span class="line">   <span class="keyword">final</span> List&lt;SchedulingPipelinedRegion&gt; regionsSorted =</span><br><span class="line">      SchedulingStrategyUtils.sortPipelinedRegionsInTopologicalOrder(schedulingTopology, regions);</span><br><span class="line">   <span class="keyword">for</span> (SchedulingPipelinedRegion region : regionsSorted) {</span><br><span class="line">      maybeScheduleRegion(region);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeScheduleRegion</span><span class="params">(<span class="keyword">final</span> SchedulingPipelinedRegion region)</span> </span>{</span><br><span class="line">   <span class="keyword">if</span> (!areRegionInputsAllConsumable(region)) {</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   checkState(areRegionVerticesAllInCreatedState(region), <span class="string">"BUG: trying to schedule a region which is not in CREATED state"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> List&lt;ExecutionVertexDeploymentOption&gt; vertexDeploymentOptions =</span><br><span class="line">      SchedulingStrategyUtils.createExecutionVertexDeploymentOptions(</span><br><span class="line">         regionVerticesSorted.get(region),</span><br><span class="line">         id -&gt; deploymentOption);</span><br><span class="line">   schedulerOperations.allocateSlotsAndDeploy(vertexDeploymentOptions);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>DefaultScheduler.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">allocateSlotsAndDeploy</span><span class="params">(<span class="keyword">final</span> List&lt;ExecutionVertexDeploymentOption&gt; executionVertexDeploymentOptions)</span> </span>{</span><br><span class="line">   validateDeploymentOptions(executionVertexDeploymentOptions);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> Map&lt;ExecutionVertexID, ExecutionVertexDeploymentOption&gt; deploymentOptionsByVertex =</span><br><span class="line">      groupDeploymentOptionsByVertexId(executionVertexDeploymentOptions);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> List&lt;ExecutionVertexID&gt; verticesToDeploy = executionVertexDeploymentOptions.stream()</span><br><span class="line">      .map(ExecutionVertexDeploymentOption::getExecutionVertexId)</span><br><span class="line">      .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> Map&lt;ExecutionVertexID, ExecutionVertexVersion&gt; requiredVersionByVertex =</span><br><span class="line">      executionVertexVersioner.recordVertexModifications(verticesToDeploy);</span><br><span class="line"></span><br><span class="line">   transitionToScheduled(verticesToDeploy);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> List&lt;SlotExecutionVertexAssignment&gt; slotExecutionVertexAssignments =</span><br><span class="line">      allocateSlots(executionVertexDeploymentOptions);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> List&lt;DeploymentHandle&gt; deploymentHandles = createDeploymentHandles(</span><br><span class="line">      requiredVersionByVertex,</span><br><span class="line">      deploymentOptionsByVertex,</span><br><span class="line">      slotExecutionVertexAssignments);</span><br><span class="line"></span><br><span class="line">   waitForAllSlotsAndDeploy(deploymentHandles);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">waitForAllSlotsAndDeploy</span><span class="params">(<span class="keyword">final</span> List&lt;DeploymentHandle&gt; deploymentHandles)</span> </span>{</span><br><span class="line">   FutureUtils.assertNoException(</span><br><span class="line">      assignAllResources(deploymentHandles).handle(deployAll(deploymentHandles)));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> BiFunction&lt;Void, Throwable, Void&gt; <span class="title">deployAll</span><span class="params">(<span class="keyword">final</span> List&lt;DeploymentHandle&gt; deploymentHandles)</span> </span>{</span><br><span class="line">   <span class="keyword">return</span> (ignored, throwable) -&gt; {</span><br><span class="line">      propagateIfNonNull(throwable);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">final</span> DeploymentHandle deploymentHandle : deploymentHandles) {</span><br><span class="line">         <span class="keyword">final</span> SlotExecutionVertexAssignment slotExecutionVertexAssignment = deploymentHandle.getSlotExecutionVertexAssignment();</span><br><span class="line">         <span class="keyword">final</span> CompletableFuture&lt;LogicalSlot&gt; slotAssigned = slotExecutionVertexAssignment.getLogicalSlotFuture();</span><br><span class="line">         checkState(slotAssigned.isDone());</span><br><span class="line"></span><br><span class="line">         FutureUtils.assertNoException(</span><br><span class="line">            slotAssigned.handle(deployOrHandleError(deploymentHandle)));</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> BiFunction&lt;Object, Throwable, Void&gt; <span class="title">deployOrHandleError</span><span class="params">(<span class="keyword">final</span> DeploymentHandle deploymentHandle)</span> </span>{</span><br><span class="line">   <span class="keyword">final</span> ExecutionVertexVersion requiredVertexVersion = deploymentHandle.getRequiredVertexVersion();</span><br><span class="line">   <span class="keyword">final</span> ExecutionVertexID executionVertexId = requiredVertexVersion.getExecutionVertexId();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> (ignored, throwable) -&gt; {</span><br><span class="line">      <span class="keyword">if</span> (executionVertexVersioner.isModified(requiredVertexVersion)) {</span><br><span class="line">         log.debug(<span class="string">"Refusing to deploy execution vertex {} because this deployment was "</span> +</span><br><span class="line">            <span class="string">"superseded by another deployment"</span>, executionVertexId);</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (throwable == <span class="keyword">null</span>) {</span><br><span class="line">         deployTaskSafe(executionVertexId);</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">         handleTaskDeploymentFailure(executionVertexId, throwable);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deployTaskSafe</span><span class="params">(<span class="keyword">final</span> ExecutionVertexID executionVertexId)</span> </span>{</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// 通过执行图的节点ID获取执行图的节点</span></span><br><span class="line">      <span class="keyword">final</span> ExecutionVertex executionVertex = getExecutionVertex(executionVertexId);</span><br><span class="line">      <span class="comment">/*TODO 部署执行图节点 */</span></span><br><span class="line">      executionVertexOperations.deploy(executionVertex);</span><br><span class="line">   } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">      handleTaskDeploymentFailure(executionVertexId, e);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>DefaultExecutionVertexOperations.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">(<span class="keyword">final</span> ExecutionVertex executionVertex)</span> <span class="keyword">throws</span> JobException </span>{</span><br><span class="line">   executionVertex.deploy();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ExecutionVertex.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span> <span class="keyword">throws</span> JobException </span>{</span><br><span class="line">   currentExecution.deploy();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span> <span class="keyword">throws</span> JobException </span>{</span><br><span class="line">   assertRunningInJobMasterMainThread();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> LogicalSlot slot  = assignedResource;</span><br><span class="line"></span><br><span class="line">   checkNotNull(slot, <span class="string">"In order to deploy the execution we first have to assign a resource via tryAssignResource."</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Check if the TaskManager died in the meantime</span></span><br><span class="line">   <span class="comment">// This only speeds up the response to TaskManagers failing concurrently to deployments.</span></span><br><span class="line">   <span class="comment">// The more general check is the rpcTimeout of the deployment call</span></span><br><span class="line">   <span class="keyword">if</span> (!slot.isAlive()) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Target slot (TaskManager) for deployment is no longer alive."</span>);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// make sure exactly one deployment call happens from the correct state</span></span><br><span class="line">   <span class="comment">// note: the transition from CREATED to DEPLOYING is for testing purposes only</span></span><br><span class="line">   ExecutionState previous = <span class="keyword">this</span>.state;</span><br><span class="line">   <span class="keyword">if</span> (previous == SCHEDULED || previous == CREATED) {</span><br><span class="line">      <span class="keyword">if</span> (!transitionState(previous, DEPLOYING)) {</span><br><span class="line">         <span class="comment">// race condition, someone else beat us to the deploying call.</span></span><br><span class="line">         <span class="comment">// this should actually not happen and indicates a race somewhere else</span></span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot deploy task: Concurrent deployment call race."</span>);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// vertex may have been cancelled, or it was already scheduled</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The vertex must be in CREATED or SCHEDULED state to be deployed. Found state "</span> + previous);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span> != slot.getPayload()) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">         String.format(<span class="string">"The execution %s has not been assigned to the assigned slot."</span>, <span class="keyword">this</span>));</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line"></span><br><span class="line">      <span class="comment">// race double check, did we fail/cancel and do we need to release the slot?</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.state != DEPLOYING) {</span><br><span class="line">         slot.releaseSlot(<span class="keyword">new</span> FlinkException(<span class="string">"Actual state of execution "</span> + <span class="keyword">this</span> + <span class="string">" ("</span> + state + <span class="string">") does not match expected state DEPLOYING."</span>));</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      LOG.info(<span class="string">"Deploying {} (attempt #{}) with attempt id {} to {} with allocation id {}"</span>, vertex.getTaskNameWithSubtaskIndex(),</span><br><span class="line">         attemptNumber, vertex.getCurrentExecutionAttempt().getAttemptId(), getAssignedResourceLocation(), slot.getAllocationId());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (taskRestore != <span class="keyword">null</span>) {</span><br><span class="line">         checkState(taskRestore.getTaskStateSnapshot().getSubtaskStateMappings().stream().allMatch(entry -&gt;</span><br><span class="line">            entry.getValue().getInputRescalingDescriptor().equals(InflightDataRescalingDescriptor.NO_RESCALE) &amp;&amp;</span><br><span class="line">            entry.getValue().getOutputRescalingDescriptor().equals(InflightDataRescalingDescriptor.NO_RESCALE)),</span><br><span class="line">            <span class="string">"Rescaling from unaligned checkpoint is not yet supported."</span>);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将 IntermediateResultPartition 转化成 ResultPartition</span></span><br><span class="line">      <span class="comment">// 将 ExecutionEdge 转成 InputChannelDeploymentDescriptor（最终会在执行时转化成InputGate）</span></span><br><span class="line">      <span class="keyword">final</span> TaskDeploymentDescriptor deployment = TaskDeploymentDescriptorFactory</span><br><span class="line">         .fromExecutionVertex(vertex, attemptNumber)</span><br><span class="line">         .createDeploymentDescriptor(</span><br><span class="line">            slot.getAllocationId(),</span><br><span class="line">            slot.getPhysicalSlotNumber(),</span><br><span class="line">            taskRestore,</span><br><span class="line">            producedPartitions.values());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// null taskRestore to let it be GC'ed</span></span><br><span class="line">      taskRestore = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> TaskManagerGateway taskManagerGateway = slot.getTaskManagerGateway();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> ComponentMainThreadExecutor jobMasterMainThreadExecutor =</span><br><span class="line">         vertex.getExecutionGraph().getJobMasterMainThreadExecutor();</span><br><span class="line"></span><br><span class="line">      getVertex().notifyPendingDeployment(<span class="keyword">this</span>);</span><br><span class="line">      <span class="comment">// We run the submission in the future executor so that the serialization of large TDDs does not block</span></span><br><span class="line">      <span class="comment">// the main thread and sync back to the main thread once submission is completed.</span></span><br><span class="line">      CompletableFuture.supplyAsync(() -&gt; taskManagerGateway.submitTask(deployment, rpcTimeout), executor)</span><br><span class="line">         .thenCompose(Function.identity())</span><br><span class="line">         .whenCompleteAsync(</span><br><span class="line">            (ack, failure) -&gt; {</span><br><span class="line">               <span class="keyword">if</span> (failure == <span class="keyword">null</span>) {</span><br><span class="line">                  vertex.notifyCompletedDeployment(<span class="keyword">this</span>);</span><br><span class="line">               } <span class="keyword">else</span> {</span><br><span class="line">                  <span class="keyword">if</span> (failure <span class="keyword">instanceof</span> TimeoutException) {</span><br><span class="line">                     String taskname = vertex.getTaskNameWithSubtaskIndex() + <span class="string">" ("</span> + attemptId + <span class="string">')'</span>;</span><br><span class="line"></span><br><span class="line">                     markFailed(<span class="keyword">new</span> Exception(</span><br><span class="line">                        <span class="string">"Cannot deploy task "</span> + taskname + <span class="string">" - TaskManager ("</span> + getAssignedResourceLocation()</span><br><span class="line">                           + <span class="string">") not responding after a rpcTimeout of "</span> + rpcTimeout, failure));</span><br><span class="line">                  } <span class="keyword">else</span> {</span><br><span class="line">                     markFailed(failure);</span><br><span class="line">                  }</span><br><span class="line">               }</span><br><span class="line">            },</span><br><span class="line">            jobMasterMainThreadExecutor);</span><br><span class="line"></span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">      markFailed(t);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isLegacyScheduling()) {</span><br><span class="line">         ExceptionUtils.rethrow(t);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>RpcTaskManagerGateway.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompletableFuture&lt;Acknowledge&gt; <span class="title">submitTask</span><span class="params">(TaskDeploymentDescriptor tdd, Time timeout)</span> </span>{</span><br><span class="line">   <span class="keyword">return</span> taskExecutorGateway.submitTask(tdd, jobMasterId, timeout);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>TaskExecutor.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompletableFuture&lt;Acknowledge&gt; <span class="title">submitTask</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      TaskDeploymentDescriptor tdd,</span></span></span><br><span class="line"><span class="params"><span class="function">      JobMasterId jobMasterId,</span></span></span><br><span class="line"><span class="params"><span class="function">      Time timeout)</span> </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">final</span> JobID jobId = tdd.getJobId();</span><br><span class="line">      <span class="keyword">final</span> ExecutionAttemptID executionAttemptID = tdd.getExecutionAttemptId();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> JobTable.Connection jobManagerConnection = jobTable.getConnection(jobId).orElseThrow(() -&gt; {</span><br><span class="line">         <span class="keyword">final</span> String message = <span class="string">"Could not submit task because there is no JobManager "</span> +</span><br><span class="line">            <span class="string">"associated for the job "</span> + jobId + <span class="string">'.'</span>;</span><br><span class="line"></span><br><span class="line">         log.debug(message);</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> TaskSubmissionException(message);</span><br><span class="line">      });</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!Objects.equals(jobManagerConnection.getJobMasterId(), jobMasterId)) {</span><br><span class="line">         <span class="keyword">final</span> String message = <span class="string">"Rejecting the task submission because the job manager leader id "</span> +</span><br><span class="line">            jobMasterId + <span class="string">" does not match the expected job manager leader id "</span> +</span><br><span class="line">            jobManagerConnection.getJobMasterId() + <span class="string">'.'</span>;</span><br><span class="line"></span><br><span class="line">         log.debug(message);</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> TaskSubmissionException(message);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!taskSlotTable.tryMarkSlotActive(jobId, tdd.getAllocationId())) {</span><br><span class="line">         <span class="keyword">final</span> String message = <span class="string">"No task slot allocated for job ID "</span> + jobId +</span><br><span class="line">            <span class="string">" and allocation ID "</span> + tdd.getAllocationId() + <span class="string">'.'</span>;</span><br><span class="line">         log.debug(message);</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> TaskSubmissionException(message);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// re-integrate offloaded data:</span></span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         tdd.loadBigData(blobCacheService.getPermanentBlobService());</span><br><span class="line">      } <span class="keyword">catch</span> (IOException | ClassNotFoundException e) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> TaskSubmissionException(<span class="string">"Could not re-integrate offloaded TaskDeploymentDescriptor data."</span>, e);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// deserialize the pre-serialized information</span></span><br><span class="line">      <span class="keyword">final</span> JobInformation jobInformation;</span><br><span class="line">      <span class="keyword">final</span> TaskInformation taskInformation;</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         jobInformation = tdd.getSerializedJobInformation().deserializeValue(getClass().getClassLoader());</span><br><span class="line">         taskInformation = tdd.getSerializedTaskInformation().deserializeValue(getClass().getClassLoader());</span><br><span class="line">      } <span class="keyword">catch</span> (IOException | ClassNotFoundException e) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> TaskSubmissionException(<span class="string">"Could not deserialize the job or task information."</span>, e);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!jobId.equals(jobInformation.getJobId())) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> TaskSubmissionException(</span><br><span class="line">            <span class="string">"Inconsistent job ID information inside TaskDeploymentDescriptor ("</span> +</span><br><span class="line">               tdd.getJobId() + <span class="string">" vs. "</span> + jobInformation.getJobId() + <span class="string">")"</span>);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      TaskMetricGroup taskMetricGroup = taskManagerMetricGroup.addTaskForJob(</span><br><span class="line">         jobInformation.getJobId(),</span><br><span class="line">         jobInformation.getJobName(),</span><br><span class="line">         taskInformation.getJobVertexId(),</span><br><span class="line">         tdd.getExecutionAttemptId(),</span><br><span class="line">         taskInformation.getTaskName(),</span><br><span class="line">         tdd.getSubtaskIndex(),</span><br><span class="line">         tdd.getAttemptNumber());</span><br><span class="line"></span><br><span class="line">      InputSplitProvider inputSplitProvider = <span class="keyword">new</span> RpcInputSplitProvider(</span><br><span class="line">         jobManagerConnection.getJobManagerGateway(),</span><br><span class="line">         taskInformation.getJobVertexId(),</span><br><span class="line">         tdd.getExecutionAttemptId(),</span><br><span class="line">         taskManagerConfiguration.getTimeout());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> TaskOperatorEventGateway taskOperatorEventGateway = <span class="keyword">new</span> RpcTaskOperatorEventGateway(</span><br><span class="line">         jobManagerConnection.getJobManagerGateway(),</span><br><span class="line">         executionAttemptID,</span><br><span class="line">         (t) -&gt; runAsync(() -&gt; failTask(executionAttemptID, t)));</span><br><span class="line"></span><br><span class="line">      TaskManagerActions taskManagerActions = jobManagerConnection.getTaskManagerActions();</span><br><span class="line">      CheckpointResponder checkpointResponder = jobManagerConnection.getCheckpointResponder();</span><br><span class="line">      GlobalAggregateManager aggregateManager = jobManagerConnection.getGlobalAggregateManager();</span><br><span class="line"></span><br><span class="line">      LibraryCacheManager.ClassLoaderHandle classLoaderHandle = jobManagerConnection.getClassLoaderHandle();</span><br><span class="line">      ResultPartitionConsumableNotifier resultPartitionConsumableNotifier = jobManagerConnection.getResultPartitionConsumableNotifier();</span><br><span class="line">      PartitionProducerStateChecker partitionStateChecker = jobManagerConnection.getPartitionStateChecker();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> TaskLocalStateStore localStateStore = localStateStoresManager.localStateStoreForSubtask(</span><br><span class="line">         jobId,</span><br><span class="line">         tdd.getAllocationId(),</span><br><span class="line">         taskInformation.getJobVertexId(),</span><br><span class="line">         tdd.getSubtaskIndex());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> JobManagerTaskRestore taskRestore = tdd.getTaskRestore();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> TaskStateManager taskStateManager = <span class="keyword">new</span> TaskStateManagerImpl(</span><br><span class="line">         jobId,</span><br><span class="line">         tdd.getExecutionAttemptId(),</span><br><span class="line">         localStateStore,</span><br><span class="line">         taskRestore,</span><br><span class="line">         checkpointResponder);</span><br><span class="line"></span><br><span class="line">      MemoryManager memoryManager;</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         memoryManager = taskSlotTable.getTaskMemoryManager(tdd.getAllocationId());</span><br><span class="line">      } <span class="keyword">catch</span> (SlotNotFoundException e) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> TaskSubmissionException(<span class="string">"Could not submit task."</span>, e);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      Task task = <span class="keyword">new</span> Task(</span><br><span class="line">         jobInformation,</span><br><span class="line">         taskInformation,</span><br><span class="line">         tdd.getExecutionAttemptId(),</span><br><span class="line">         tdd.getAllocationId(),</span><br><span class="line">         tdd.getSubtaskIndex(),</span><br><span class="line">         tdd.getAttemptNumber(),</span><br><span class="line">         tdd.getProducedPartitions(),</span><br><span class="line">         tdd.getInputGates(),</span><br><span class="line">         tdd.getTargetSlotNumber(),</span><br><span class="line">         memoryManager,</span><br><span class="line">         taskExecutorServices.getIOManager(),</span><br><span class="line">         taskExecutorServices.getShuffleEnvironment(),</span><br><span class="line">         taskExecutorServices.getKvStateService(),</span><br><span class="line">         taskExecutorServices.getBroadcastVariableManager(),</span><br><span class="line">         taskExecutorServices.getTaskEventDispatcher(),</span><br><span class="line">         externalResourceInfoProvider,</span><br><span class="line">         taskStateManager,</span><br><span class="line">         taskManagerActions,</span><br><span class="line">         inputSplitProvider,</span><br><span class="line">         checkpointResponder,</span><br><span class="line">         taskOperatorEventGateway,</span><br><span class="line">         aggregateManager,</span><br><span class="line">         classLoaderHandle,</span><br><span class="line">         fileCache,</span><br><span class="line">         taskManagerConfiguration,</span><br><span class="line">         taskMetricGroup,</span><br><span class="line">         resultPartitionConsumableNotifier,</span><br><span class="line">         partitionStateChecker,</span><br><span class="line">         getRpcService().getExecutor());</span><br><span class="line"></span><br><span class="line">      taskMetricGroup.gauge(MetricNames.IS_BACKPRESSURED, task::isBackPressured);</span><br><span class="line"></span><br><span class="line">      log.info(<span class="string">"Received task {} ({}), deploy into slot with allocation id {}."</span>,</span><br><span class="line">         task.getTaskInfo().getTaskNameWithSubtasks(), tdd.getExecutionAttemptId(), tdd.getAllocationId());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">boolean</span> taskAdded;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         taskAdded = taskSlotTable.addTask(task);</span><br><span class="line">      } <span class="keyword">catch</span> (SlotNotFoundException | SlotNotActiveException e) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> TaskSubmissionException(<span class="string">"Could not submit task."</span>, e);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (taskAdded) {</span><br><span class="line">         task.startTaskThread();</span><br><span class="line"></span><br><span class="line">         setupResultPartitionBookkeeping(</span><br><span class="line">            tdd.getJobId(),</span><br><span class="line">            tdd.getProducedPartitions(),</span><br><span class="line">            task.getTerminationFuture());</span><br><span class="line">         <span class="keyword">return</span> CompletableFuture.completedFuture(Acknowledge.get());</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">         <span class="keyword">final</span> String message = <span class="string">"TaskManager already contains a task for id "</span> +</span><br><span class="line">            task.getExecutionId() + <span class="string">'.'</span>;</span><br><span class="line"></span><br><span class="line">         log.debug(message);</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> TaskSubmissionException(message);</span><br><span class="line">      }</span><br><span class="line">   } <span class="keyword">catch</span> (TaskSubmissionException e) {</span><br><span class="line">      <span class="keyword">return</span> FutureUtils.completedExceptionally(e);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Task.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startTaskThread</span><span class="params">()</span> </span>{</span><br><span class="line">   <span class="comment">/*TODO 接下来启动Task执行线程，调用Task.run() -&gt; doRun()*/</span></span><br><span class="line">   executingThread.start();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来启动 Task 执行线程，调用 Task.run() -&gt; doRun()</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doRun</span><span class="params">()</span> </span>{</span><br><span class="line">   <span class="comment">// ----------------------------</span></span><br><span class="line">   <span class="comment">//  Initial State transition</span></span><br><span class="line">   <span class="comment">// ----------------------------</span></span><br><span class="line">   <span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br><span class="line">      ExecutionState current = <span class="keyword">this</span>.executionState;</span><br><span class="line">      <span class="keyword">if</span> (current == ExecutionState.CREATED) {</span><br><span class="line">         <span class="keyword">if</span> (transitionState(ExecutionState.CREATED, ExecutionState.DEPLOYING)) {</span><br><span class="line">            <span class="comment">// success, we can start our work</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (current == ExecutionState.FAILED) {</span><br><span class="line">         <span class="comment">// we were immediately failed. tell the TaskManager that we reached our final state</span></span><br><span class="line">         notifyFinalState();</span><br><span class="line">         <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) {</span><br><span class="line">            metrics.close();</span><br><span class="line">         }</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (current == ExecutionState.CANCELING) {</span><br><span class="line">         <span class="keyword">if</span> (transitionState(ExecutionState.CANCELING, ExecutionState.CANCELED)) {</span><br><span class="line">            <span class="comment">// we were immediately canceled. tell the TaskManager that we reached our final state</span></span><br><span class="line">            notifyFinalState();</span><br><span class="line">            <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) {</span><br><span class="line">               metrics.close();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span> {</span><br><span class="line">         <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) {</span><br><span class="line">            metrics.close();</span><br><span class="line">         }</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid state for beginning of operation of task "</span> + <span class="keyword">this</span> + <span class="string">'.'</span>);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// all resource acquisitions and registrations from here on</span></span><br><span class="line">   <span class="comment">// need to be undone in the end</span></span><br><span class="line">   Map&lt;String, Future&lt;Path&gt;&gt; distributedCacheEntries = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   AbstractInvokable invokable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// ----------------------------</span></span><br><span class="line">      <span class="comment">//  Task Bootstrap - We periodically</span></span><br><span class="line">      <span class="comment">//  check for canceling as a shortcut</span></span><br><span class="line">      <span class="comment">// ----------------------------</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// activate safety net for task thread</span></span><br><span class="line">      LOG.debug(<span class="string">"Creating FileSystem stream leak safety net for task {}"</span>, <span class="keyword">this</span>);</span><br><span class="line">      FileSystemSafetyNet.initializeSafetyNetForThread();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// first of all, get a user-code classloader</span></span><br><span class="line">      <span class="comment">// this may involve downloading the job's JAR files and/or classes</span></span><br><span class="line">      LOG.info(<span class="string">"Loading JAR files for task {}."</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">      userCodeClassLoader = createUserCodeClassloader();</span><br><span class="line">      <span class="keyword">final</span> ExecutionConfig executionConfig = serializedExecutionConfig.deserializeValue(userCodeClassLoader.asClassLoader());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (executionConfig.getTaskCancellationInterval() &gt;= <span class="number">0</span>) {</span><br><span class="line">         <span class="comment">// override task cancellation interval from Flink config if set in ExecutionConfig</span></span><br><span class="line">         taskCancellationInterval = executionConfig.getTaskCancellationInterval();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (executionConfig.getTaskCancellationTimeout() &gt;= <span class="number">0</span>) {</span><br><span class="line">         <span class="comment">// override task cancellation timeout from Flink config if set in ExecutionConfig</span></span><br><span class="line">         taskCancellationTimeout = executionConfig.getTaskCancellationTimeout();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isCanceledOrFailed()) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line">      <span class="comment">// register the task with the network stack</span></span><br><span class="line">      <span class="comment">// this operation may fail if the system does not have enough</span></span><br><span class="line">      <span class="comment">// memory to run the necessary data exchanges</span></span><br><span class="line">      <span class="comment">// the registration must also strictly be undone</span></span><br><span class="line">      <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">      LOG.info(<span class="string">"Registering task at network: {}."</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">      setupPartitionsAndGates(consumableNotifyingPartitionWriters, inputGates);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (ResultPartitionWriter partitionWriter : consumableNotifyingPartitionWriters) {</span><br><span class="line">         taskEventDispatcher.registerPartition(partitionWriter.getPartitionId());</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// next, kick off the background copying of files for the distributed cache</span></span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         <span class="keyword">for</span> (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; entry :</span><br><span class="line">               DistributedCache.readFileInfoFromConfig(jobConfiguration)) {</span><br><span class="line">            LOG.info(<span class="string">"Obtaining local cache file for '{}'."</span>, entry.getKey());</span><br><span class="line">            Future&lt;Path&gt; cp = fileCache.createTmpFile(entry.getKey(), entry.getValue(), jobId, executionId);</span><br><span class="line">            distributedCacheEntries.put(entry.getKey(), cp);</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> Exception(</span><br><span class="line">            String.format(<span class="string">"Exception while adding files to distributed cache of task %s (%s)."</span>, taskNameWithSubtask, executionId), e);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isCanceledOrFailed()) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line">      <span class="comment">//  call the user code initialization methods</span></span><br><span class="line">      <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">      TaskKvStateRegistry kvStateRegistry = kvStateService.createKvStateTaskRegistry(jobId, getJobVertexId());</span><br><span class="line"></span><br><span class="line">      Environment env = <span class="keyword">new</span> RuntimeEnvironment(</span><br><span class="line">         jobId,</span><br><span class="line">         vertexId,</span><br><span class="line">         executionId,</span><br><span class="line">         executionConfig,</span><br><span class="line">         taskInfo,</span><br><span class="line">         jobConfiguration,</span><br><span class="line">         taskConfiguration,</span><br><span class="line">         userCodeClassLoader,</span><br><span class="line">         memoryManager,</span><br><span class="line">         ioManager,</span><br><span class="line">         broadcastVariableManager,</span><br><span class="line">         taskStateManager,</span><br><span class="line">         aggregateManager,</span><br><span class="line">         accumulatorRegistry,</span><br><span class="line">         kvStateRegistry,</span><br><span class="line">         inputSplitProvider,</span><br><span class="line">         distributedCacheEntries,</span><br><span class="line">         consumableNotifyingPartitionWriters,</span><br><span class="line">         inputGates,</span><br><span class="line">         taskEventDispatcher,</span><br><span class="line">         checkpointResponder,</span><br><span class="line">         operatorCoordinatorEventGateway,</span><br><span class="line">         taskManagerConfig,</span><br><span class="line">         metrics,</span><br><span class="line">         <span class="keyword">this</span>,</span><br><span class="line">         externalResourceInfoProvider);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Make sure the user code classloader is accessible thread-locally.</span></span><br><span class="line">      <span class="comment">// We are setting the correct context class loader before instantiating the invokable</span></span><br><span class="line">      <span class="comment">// so that it is available to the invokable during its entire lifetime.</span></span><br><span class="line">      executingThread.setContextClassLoader(userCodeClassLoader.asClassLoader());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// now load and instantiate the task's invokable code</span></span><br><span class="line">      <span class="comment">/*TODO 加载和实例化task的可执行代码*/</span></span><br><span class="line">      invokable = loadAndInstantiateInvokable(userCodeClassLoader.asClassLoader(), nameOfInvokableClass, env);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line">      <span class="comment">//  actual task core work</span></span><br><span class="line">      <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// we must make strictly sure that the invokable is accessible to the cancel() call</span></span><br><span class="line">      <span class="comment">// by the time we switched to running.</span></span><br><span class="line">      <span class="keyword">this</span>.invokable = invokable;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// switch to the RUNNING state, if that fails, we have been canceled/failed in the meantime</span></span><br><span class="line">      <span class="keyword">if</span> (!transitionState(ExecutionState.DEPLOYING, ExecutionState.RUNNING)) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// notify everyone that we switched to running</span></span><br><span class="line">      taskManagerActions.updateTaskExecutionState(<span class="keyword">new</span> TaskExecutionState(jobId, executionId, ExecutionState.RUNNING));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// make sure the user code classloader is accessible thread-locally</span></span><br><span class="line">      executingThread.setContextClassLoader(userCodeClassLoader.asClassLoader());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// run the invokable</span></span><br><span class="line">      <span class="comment">/*TODO 执行代码（ invokable即为operator对象实例，比如 StreamTask里）*/</span></span><br><span class="line">      invokable.invoke();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// make sure, we enter the catch block if the task leaves the invoke() method due</span></span><br><span class="line">      <span class="comment">// to the fact that it has been canceled</span></span><br><span class="line">      <span class="keyword">if</span> (isCanceledOrFailed()) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line">      <span class="comment">//  finalization of a successful execution</span></span><br><span class="line">      <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// finish the produced partitions. if this fails, we consider the execution failed.</span></span><br><span class="line">      <span class="keyword">for</span> (ResultPartitionWriter partitionWriter : consumableNotifyingPartitionWriters) {</span><br><span class="line">         <span class="keyword">if</span> (partitionWriter != <span class="keyword">null</span>) {</span><br><span class="line">            partitionWriter.finish();</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// try to mark the task as finished</span></span><br><span class="line">      <span class="comment">// if that fails, the task was canceled/failed in the meantime</span></span><br><span class="line">      <span class="keyword">if</span> (!transitionState(ExecutionState.RUNNING, ExecutionState.FINISHED)) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"></span><br><span class="line">      <span class="comment">// unwrap wrapped exceptions to make stack traces more compact</span></span><br><span class="line">      <span class="keyword">if</span> (t <span class="keyword">instanceof</span> WrappingRuntimeException) {</span><br><span class="line">         t = ((WrappingRuntimeException) t).unwrap();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line">      <span class="comment">// the execution failed. either the invokable code properly failed, or</span></span><br><span class="line">      <span class="comment">// an exception was thrown as a side effect of cancelling</span></span><br><span class="line">      <span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">      TaskManagerExceptionUtils.tryEnrichTaskManagerError(t);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         <span class="comment">// check if the exception is unrecoverable</span></span><br><span class="line">         <span class="keyword">if</span> (ExceptionUtils.isJvmFatalError(t) ||</span><br><span class="line">               (t <span class="keyword">instanceof</span> OutOfMemoryError &amp;&amp; taskManagerConfig.shouldExitJvmOnOutOfMemoryError())) {</span><br><span class="line"></span><br><span class="line">            <span class="comment">// terminate the JVM immediately</span></span><br><span class="line">            <span class="comment">// don't attempt a clean shutdown, because we cannot expect the clean shutdown to complete</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">               LOG.error(<span class="string">"Encountered fatal error {} - terminating the JVM"</span>, t.getClass().getName(), t);</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">               Runtime.getRuntime().halt(-<span class="number">1</span>);</span><br><span class="line">            }</span><br><span class="line">         }</span><br><span class="line"></span><br><span class="line">         <span class="comment">// transition into our final state. we should be either in DEPLOYING, RUNNING, CANCELING, or FAILED</span></span><br><span class="line">         <span class="comment">// loop for multiple retries during concurrent state changes via calls to cancel() or</span></span><br><span class="line">         <span class="comment">// to failExternally()</span></span><br><span class="line">         <span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br><span class="line">            ExecutionState current = <span class="keyword">this</span>.executionState;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (current == ExecutionState.RUNNING || current == ExecutionState.DEPLOYING) {</span><br><span class="line">               <span class="keyword">if</span> (t <span class="keyword">instanceof</span> CancelTaskException) {</span><br><span class="line">                  <span class="keyword">if</span> (transitionState(current, ExecutionState.CANCELED)) {</span><br><span class="line">                     cancelInvokable(invokable);</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">                  }</span><br><span class="line">               }</span><br><span class="line">               <span class="keyword">else</span> {</span><br><span class="line">                  <span class="keyword">if</span> (transitionState(current, ExecutionState.FAILED, t)) {</span><br><span class="line">                     <span class="comment">// proper failure of the task. record the exception as the root cause</span></span><br><span class="line">                     failureCause = t;</span><br><span class="line">                     cancelInvokable(invokable);</span><br><span class="line"></span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">                  }</span><br><span class="line">               }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == ExecutionState.CANCELING) {</span><br><span class="line">               <span class="keyword">if</span> (transitionState(current, ExecutionState.CANCELED)) {</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">               }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == ExecutionState.FAILED) {</span><br><span class="line">               <span class="comment">// in state failed already, no transition necessary any more</span></span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// unexpected state, go to failed</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (transitionState(current, ExecutionState.FAILED, t)) {</span><br><span class="line">               LOG.error(<span class="string">"Unexpected state in task {} ({}) during an exception: {}."</span>, taskNameWithSubtask, executionId, current);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// else fall through the loop and</span></span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">catch</span> (Throwable tt) {</span><br><span class="line">         String message = String.format(<span class="string">"FATAL - exception in exception handler of task %s (%s)."</span>, taskNameWithSubtask, executionId);</span><br><span class="line">         LOG.error(message, tt);</span><br><span class="line">         notifyFatalError(message, tt);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">finally</span> {</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         LOG.info(<span class="string">"Freeing task resources for {} ({})."</span>, taskNameWithSubtask, executionId);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// clear the reference to the invokable. this helps guard against holding references</span></span><br><span class="line">         <span class="comment">// to the invokable and its structures in cases where this Task object is still referenced</span></span><br><span class="line">         <span class="keyword">this</span>.invokable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// free the network resources</span></span><br><span class="line">         releaseResources();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// free memory resources</span></span><br><span class="line">         <span class="keyword">if</span> (invokable != <span class="keyword">null</span>) {</span><br><span class="line">            memoryManager.releaseAll(invokable);</span><br><span class="line">         }</span><br><span class="line"></span><br><span class="line">         <span class="comment">// remove all of the tasks resources</span></span><br><span class="line">         fileCache.releaseJob(jobId, executionId);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// close and de-activate safety net for task thread</span></span><br><span class="line">         LOG.debug(<span class="string">"Ensuring all FileSystem streams are closed for task {}"</span>, <span class="keyword">this</span>);</span><br><span class="line">         FileSystemSafetyNet.closeSafetyNetAndGuardedResourcesForThread();</span><br><span class="line"></span><br><span class="line">         notifyFinalState();</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">         <span class="comment">// an error in the resource cleanup is fatal</span></span><br><span class="line">         String message = String.format(<span class="string">"FATAL - exception in resource cleanup of task %s (%s)."</span>, taskNameWithSubtask, executionId);</span><br><span class="line">         LOG.error(message, t);</span><br><span class="line">         notifyFatalError(message, t);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// un-register the metrics at the end so that the task may already be</span></span><br><span class="line">      <span class="comment">// counted as finished when this happens</span></span><br><span class="line">      <span class="comment">// errors here will only be logged</span></span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         metrics.close();</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">         LOG.error(<span class="string">"Error during metrics de-registration of task {} ({})."</span>, taskNameWithSubtask, executionId, t);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setupPartitionsAndGates</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">   ResultPartitionWriter[] producedPartitions, InputGate[] inputGates)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (ResultPartitionWriter partition : producedPartitions) {</span><br><span class="line">      partition.setup();</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// InputGates must be initialized after the partitions, since during InputGate#setup</span></span><br><span class="line">   <span class="comment">// we are requesting partitions</span></span><br><span class="line">   <span class="keyword">for</span> (InputGate gate : inputGates) {</span><br><span class="line">      gate.setup();</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里的 invokable 即为 operator 对象实例，通过反射创建，比如 StreamTask。 nameOfInvokableClass 在生成 StreamGraph 的时候，就已经确定了，见 3.1.2 中的 StreamGraph.addOperator 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;IN, OUT&gt; <span class="function"><span class="keyword">void</span> <span class="title">addOperator</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      Integer vertexID,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Nullable</span> String slotSharingGroup,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Nullable</span> String coLocationGroup,</span></span></span><br><span class="line"><span class="params"><span class="function">      StreamOperatorFactory&lt;OUT&gt; operatorFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">      TypeInformation&lt;IN&gt; inTypeInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">      TypeInformation&lt;OUT&gt; outTypeInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">      String operatorName,</span></span></span><br><span class="line"><span class="params"><span class="function">      Class&lt;? extends AbstractInvokable&gt; invokableClass)</span> </span>{</span><br><span class="line"></span><br><span class="line">   addNode(vertexID, slotSharingGroup, coLocationGroup, invokableClass, operatorFactory, operatorName);</span><br><span class="line">   setSerializers(vertexID, createSerializer(inTypeInfo), <span class="keyword">null</span>, createSerializer(outTypeInfo));</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (operatorFactory.isOutputTypeConfigurable() &amp;&amp; outTypeInfo != <span class="keyword">null</span>) {</span><br><span class="line">      <span class="comment">// sets the output type which must be know at StreamGraph creation time</span></span><br><span class="line">      operatorFactory.setOutputType(outTypeInfo, executionConfig);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (operatorFactory.isInputTypeConfigurable()) {</span><br><span class="line">      operatorFactory.setInputType(inTypeInfo, executionConfig);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (LOG.isDebugEnabled()) {</span><br><span class="line">      LOG.debug(<span class="string">"Vertex: {}"</span>, vertexID);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里的 OneInputStreamTask.class 即为生成的 StreamNode 的 vertexClass。这个值会一直 传递，当 StreamGraph 被转化成 JobGraph 的时候，这个值会被传递到 JobVertex 的 invokableClass。然后当 JobGraph 被转成 ExecutionGraph 的时候，这个值被传入到 ExecutionJobVertex.TaskInformation.invokableClassName 中，一直传到 Task 中。 继续看 invokable.invoke()：</p>
<p>StreamTask.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// 调用前的准备工作</span></span><br><span class="line">      beforeInvoke();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// final check to exit early before starting to run</span></span><br><span class="line">      <span class="keyword">if</span> (canceled) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// let the task do its work</span></span><br><span class="line">      <span class="comment">/*TODO 关键逻辑：运行任务*/</span></span><br><span class="line">      runMailboxLoop();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// if this left the run() method cleanly despite the fact that this was canceled,</span></span><br><span class="line">      <span class="comment">// make sure the "clean shutdown" is not attempted</span></span><br><span class="line">      <span class="keyword">if</span> (canceled) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> CancelTaskException();</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 运行任务之后的清理工作</span></span><br><span class="line">      afterInvoke();</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">catch</span> (Throwable invokeException) {</span><br><span class="line">      failing = !canceled;</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         cleanUpInvoke();</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> investigate why Throwable instead of Exception is used here.</span></span><br><span class="line">      <span class="keyword">catch</span> (Throwable cleanUpException) {</span><br><span class="line">         Throwable throwable = ExceptionUtils.firstOrSuppressed(cleanUpException, invokeException);</span><br><span class="line">         ExceptionUtils.rethrowException(throwable);</span><br><span class="line">      }</span><br><span class="line">      ExceptionUtils.rethrowException(invokeException);</span><br><span class="line">   }</span><br><span class="line">   cleanUpInvoke();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runMailboxLoop</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">   mailboxProcessor.runMailboxLoop();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>MailboxProcessor.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runMailboxLoop</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> TaskMailbox localMailbox = mailbox;</span><br><span class="line"></span><br><span class="line">   Preconditions.checkState(</span><br><span class="line">      localMailbox.isMailboxThread(),</span><br><span class="line">      <span class="string">"Method must be executed by declared mailbox thread!"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">assert</span> localMailbox.getState() == TaskMailbox.State.OPEN : <span class="string">"Mailbox must be opened!"</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> MailboxController defaultActionContext = <span class="keyword">new</span> MailboxController(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 邮箱里有邮件，就进行处理。邮件就是类似于map之类的⼦任务</span></span><br><span class="line">   <span class="keyword">while</span> (isMailboxLoopRunning()) {</span><br><span class="line">      <span class="comment">// The blocking `processMail` call will not return until default action is available.</span></span><br><span class="line">      processMail(localMailbox, <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (isMailboxLoopRunning()) {</span><br><span class="line">         <span class="comment">// 邮箱默认操作在 StreamTask构造器中指定，为 processInput()</span></span><br><span class="line">         mailboxDefaultAction.runDefaultAction(defaultActionContext); <span class="comment">// lock is acquired inside default action as needed</span></span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>runDefaultAction()执行默认操作，通过 Control+h 查找具体实现，为 StreamTask.java 中 第 292 行</p>
<p>StreamTask.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">StreamTask</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      Environment environment,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Nullable</span> TimerService timerService,</span></span></span><br><span class="line"><span class="params"><span class="function">      Thread.UncaughtExceptionHandler uncaughtExceptionHandler)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">   <span class="keyword">this</span>(environment, timerService, uncaughtExceptionHandler, StreamTaskActionExecutor.IMMEDIATE);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>MailboxProcessor.java 查看构造器</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MailboxProcessor</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      MailboxDefaultAction mailboxDefaultAction,</span></span></span><br><span class="line"><span class="params"><span class="function">      TaskMailbox mailbox,</span></span></span><br><span class="line"><span class="params"><span class="function">      StreamTaskActionExecutor actionExecutor)</span> </span>{</span><br><span class="line">   <span class="keyword">this</span>.mailboxDefaultAction = Preconditions.checkNotNull(mailboxDefaultAction);</span><br><span class="line">   <span class="keyword">this</span>.actionExecutor = Preconditions.checkNotNull(actionExecutor);</span><br><span class="line">   <span class="keyword">this</span>.mailbox = Preconditions.checkNotNull(mailbox);</span><br><span class="line">   <span class="keyword">this</span>.mailboxLoopRunning = <span class="keyword">true</span>;</span><br><span class="line">   <span class="keyword">this</span>.suspendedDefaultAction = <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>所以执行的默认操作就是 processInput(): </p>
<p>StreamTask.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processInput</span><span class="params">(MailboxDefaultAction.Controller controller)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">   InputStatus status = inputProcessor.processInput();</span><br><span class="line">   <span class="keyword">if</span> (status == InputStatus.MORE_AVAILABLE &amp;&amp; recordWriter.isAvailable()) {</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">if</span> (status == InputStatus.END_OF_INPUT) {</span><br><span class="line">      controller.allActionsCompleted();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   }</span><br><span class="line">   CompletableFuture&lt;?&gt; jointFuture = getInputOutputJointFuture(status);</span><br><span class="line">   MailboxDefaultAction.Suspension suspendedDefaultAction = controller.suspendDefaultAction();</span><br><span class="line">   assertNoException(jointFuture.thenRun(suspendedDefaultAction::resume));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>StreamOneInputProcessor.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> InputStatus <span class="title">processInput</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">   InputStatus status = input.emitNext(output);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (status == InputStatus.END_OF_INPUT) {</span><br><span class="line">      endOfInputAware.endInput(input.getInputIndex() + <span class="number">1</span>);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> status;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>StreamTaskNetworkInput.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> InputStatus <span class="title">emitNext</span><span class="params">(DataOutput&lt;T&gt; output)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br><span class="line">      <span class="comment">// get the stream element from the deserializer</span></span><br><span class="line">      <span class="keyword">if</span> (currentRecordDeserializer != <span class="keyword">null</span>) {</span><br><span class="line">         DeserializationResult result = currentRecordDeserializer.getNextRecord(deserializationDelegate);</span><br><span class="line">         <span class="keyword">if</span> (result.isBufferConsumed()) {</span><br><span class="line">            currentRecordDeserializer.getCurrentBuffer().recycleBuffer();</span><br><span class="line">            currentRecordDeserializer = <span class="keyword">null</span>;</span><br><span class="line">         }</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (result.isFullRecord()) {</span><br><span class="line">            processElement(deserializationDelegate.getInstance(), output);</span><br><span class="line">            <span class="keyword">return</span> InputStatus.MORE_AVAILABLE;</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      Optional&lt;BufferOrEvent&gt; bufferOrEvent = checkpointedInputGate.pollNext();</span><br><span class="line">      <span class="keyword">if</span> (bufferOrEvent.isPresent()) {</span><br><span class="line">         <span class="comment">// return to the mailbox after receiving a checkpoint barrier to avoid processing of</span></span><br><span class="line">         <span class="comment">// data after the barrier before checkpoint is performed for unaligned checkpoint mode</span></span><br><span class="line">         <span class="keyword">if</span> (bufferOrEvent.get().isBuffer()) {</span><br><span class="line">            processBuffer(bufferOrEvent.get());</span><br><span class="line">         } <span class="keyword">else</span> {</span><br><span class="line">            processEvent(bufferOrEvent.get());</span><br><span class="line">            <span class="keyword">return</span> InputStatus.MORE_AVAILABLE;</span><br><span class="line">         }</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">         <span class="keyword">if</span> (checkpointedInputGate.isFinished()) {</span><br><span class="line">            checkState(checkpointedInputGate.getAvailableFuture().isDone(), <span class="string">"Finished BarrierHandler should be available"</span>);</span><br><span class="line">            <span class="keyword">return</span> InputStatus.END_OF_INPUT;</span><br><span class="line">         }</span><br><span class="line">         <span class="keyword">return</span> InputStatus.NOTHING_AVAILABLE;</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(StreamElement recordOrMark, DataOutput&lt;T&gt; output)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">   <span class="keyword">if</span> (recordOrMark.isRecord()){</span><br><span class="line">      <span class="comment">//如果是map算子，emitRecord应该在OneInputStreamTask.java调用</span></span><br><span class="line">      output.emitRecord(recordOrMark.asRecord());</span><br><span class="line">   } <span class="keyword">else</span> <span class="keyword">if</span> (recordOrMark.isWatermark()) {</span><br><span class="line">      statusWatermarkValve.inputWatermark(recordOrMark.asWatermark(), lastChannel, output);</span><br><span class="line">   } <span class="keyword">else</span> <span class="keyword">if</span> (recordOrMark.isLatencyMarker()) {</span><br><span class="line">      output.emitLatencyMarker(recordOrMark.asLatencyMarker());</span><br><span class="line">   } <span class="keyword">else</span> <span class="keyword">if</span> (recordOrMark.isStreamStatus()) {</span><br><span class="line">      statusWatermarkValve.inputStreamStatus(recordOrMark.asStreamStatus(), lastChannel, output);</span><br><span class="line">   } <span class="keyword">else</span> {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Unknown type of StreamElement"</span>);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果是 map 算子，emitRecord 应该在 OneInputStreamTask.java 调用</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">emitRecord</span><span class="params">(StreamRecord&lt;IN&gt; record)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">   numRecordsIn.inc();</span><br><span class="line">   operator.setKeyContextElement1(record);</span><br><span class="line">   <span class="comment">// 如果是map算子，processElement应该在StreamMap.java调用</span></span><br><span class="line">   operator.processElement(record);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果是 map 算子，processElement 应该在 StreamMap.java 调用</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(StreamRecord&lt;IN&gt; element)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">   <span class="comment">// userFunction.map() 就是用户定义的MapFunction里的map方法</span></span><br><span class="line">   output.collect(element.replace(userFunction.map(element.getValue())));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-7-调度"><a href="#5-7-调度" class="headerlink" title="5.7 调度"></a>5.7 调度</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">调度器是</span> <span class="string">Flink 作业执行的核心组件，管理作业执行的所有相关过程，包括 JobGraph 到</span></span><br><span class="line"><span class="attr">ExecutionGraph</span> <span class="string">的转换、作业生命周期管理（作业的发布、取消、停止）、作业的 Task 生命</span></span><br><span class="line"><span class="meta">周期管理（Task</span> <span class="string">的发布、取消、停止）、资源申请与释放、作业和 Task 的 Failover 等。</span></span><br><span class="line"><span class="attr">调度有几个重要的组件：</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">调度器：SchedulerNG 及其子类、实现类</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">调度策略：SchedulingStrategy 及其实现类</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">调度模式：ScheduleMode 包含流和批的调度，有各自不同的调度模式</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-8-调度器"><a href="#5-8-调度器" class="headerlink" title="5.8 调度器"></a>5.8 调度器</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">调度器作用：</span></span><br><span class="line">	<span class="attr">1）作业的生命周期管理，如作业的发布、挂起、取消</span></span><br><span class="line">	<span class="attr">2）作业执行资源的申请、分配、释放</span></span><br><span class="line">	<span class="meta">3）作业的状态管理，作业发布过程中的状态变化和作业异常时的</span> <span class="string">FailOver 等</span></span><br><span class="line">	<span class="attr">4）作业的信息提供，对外提供作业的详细信息</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-8-1-看一下源码结构"><a href="#5-8-1-看一下源码结构" class="headerlink" title="5.8.1 看一下源码结构"></a>5.8.1 看一下源码结构</h4><p>SchedulerNG.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulerNG</span> </span>{</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">setMainThreadExecutor</span><span class="params">(ComponentMainThreadExecutor mainThreadExecutor)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">registerJobStatusListener</span><span class="params">(JobStatusListener jobStatusListener)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">startScheduling</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">suspend</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function">CompletableFuture&lt;Void&gt; <span class="title">getTerminationFuture</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">handleGlobalFailure</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">updateTaskExecutionState</span><span class="params">(TaskExecutionState taskExecutionState)</span> </span>{</span><br><span class="line">      <span class="keyword">return</span> updateTaskExecutionState(<span class="keyword">new</span> TaskExecutionStateTransition(taskExecutionState));</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">updateTaskExecutionState</span><span class="params">(TaskExecutionStateTransition taskExecutionState)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function">SerializedInputSplit <span class="title">requestNextInputSplit</span><span class="params">(JobVertexID vertexID, ExecutionAttemptID executionAttempt)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">   <span class="function">ExecutionState <span class="title">requestPartitionState</span><span class="params">(IntermediateDataSetID intermediateResultId, ResultPartitionID resultPartitionId)</span> <span class="keyword">throws</span> PartitionProducerDisposedException</span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">scheduleOrUpdateConsumers</span><span class="params">(ResultPartitionID partitionID)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function">ArchivedExecutionGraph <span class="title">requestJob</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function">JobStatus <span class="title">requestJobStatus</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="function">JobDetails <span class="title">requestJobDetails</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>实现类：DefaultScheduler（1.11 移除了 LegacyScheduler）</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715104658663.png" alt="DefaultScheduler"></p>
<h3 id="5-9-调度行为"><a href="#5-9-调度行为" class="headerlink" title="5.9 调度行为"></a>5.9 调度行为</h3><p>SchedulingStrategy.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulingStrategy</span> </span>{</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Called when the scheduling is started (initial scheduling operation).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">startScheduling</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Called whenever vertices need to be restarted (due to task failure).</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> verticesToRestart The tasks need to be restarted</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">restartTasks</span><span class="params">(Set&lt;ExecutionVertexID&gt; verticesToRestart)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Called whenever an {<span class="doctag">@link</span> Execution} changes its state.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> executionVertexId The id of the task</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> executionState The new state of the execution</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">onExecutionStateChange</span><span class="params">(ExecutionVertexID executionVertexId, ExecutionState executionState)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Called whenever an {<span class="doctag">@link</span> IntermediateResultPartition} becomes consumable.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> resultPartitionId The id of the result partition</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">onPartitionConsumable</span><span class="params">(IntermediateResultPartitionID resultPartitionId)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-10-调度模式"><a href="#5-10-调度模式" class="headerlink" title="5.10 调度模式"></a>5.10 调度模式</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ScheduleMode</span> <span class="string">决定如何启动 ExecutionGraph 中的 Task。Flink 提供 3 中调度模式：</span></span><br><span class="line"><span class="meta">1）Eager</span> <span class="string">调度</span></span><br><span class="line"><span class="attr">适用于流计算。一次性申请需要的所有资源，如果资源不足，则作业启动失败。</span></span><br><span class="line"><span class="attr">2）分阶段调度</span></span><br><span class="line"><span class="attr">LAZY_FROM_SOURCES</span> <span class="string">适用于批处理。从 SourceTask 开始分阶段调度，申请资源的</span></span><br><span class="line"><span class="meta">时候，一次性申请本阶段所需要的所有资源。上游</span> <span class="string">Task 执行完毕后开始调度执行下游的 Task，</span></span><br><span class="line"><span class="meta">读取上游的数据，执行本阶段的计算任务，执行完毕之后，调度后一个阶段的</span> <span class="string">Task，依次进</span></span><br><span class="line"><span class="attr">行调度，直到作业完成。</span></span><br><span class="line"><span class="meta">3）分阶段</span> <span class="string">Slot 重用调度</span></span><br><span class="line"><span class="attr">LAZY_FROM_SOURCES_WITH_BATCH_SLOT_REQUEST</span> <span class="string">适用于批处理。与分阶段调</span></span><br><span class="line"><span class="attr">度基本一样，区别在于该模式下使用批处理资源申请模式，可以在资源不足的情况下执行作</span></span><br><span class="line"><span class="meta">业，但是需要确保在本阶段的作业执行中没有</span> <span class="string">Shuffle 行为。</span></span><br><span class="line"><span class="meta">目前视线中的</span> <span class="string">Eager 模式和 LAZY_FROM_SOURCES 模式的资源申请逻辑一样，</span></span><br><span class="line"><span class="attr">LAZY_FROM_SOURCES_WITH_BATCH_SLOT_REQUEST</span> <span class="string">是单独的资源申请逻辑。</span></span><br></pre></td></tr></tbody></table></figure>

<p>ScheduleMode.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">ScheduleMode</span> </span>{</span><br><span class="line">   <span class="comment">/** Schedule tasks lazily from the sources. Downstream tasks are started once their input data are ready */</span></span><br><span class="line">   LAZY_FROM_SOURCES(<span class="keyword">true</span>),</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Same as LAZY_FROM_SOURCES just with the difference that it uses batch slot requests which support the</span></span><br><span class="line"><span class="comment">    * execution of jobs with fewer slots than requested. However, the user needs to make sure that the job</span></span><br><span class="line"><span class="comment">    * does not contain any pipelined shuffles (every pipelined region can be executed with a single slot).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   LAZY_FROM_SOURCES_WITH_BATCH_SLOT_REQUEST(<span class="keyword">true</span>),</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** Schedules all tasks immediately. */</span></span><br><span class="line">   EAGER(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> allowLazyDeployment;</span><br><span class="line"></span><br><span class="line">   ScheduleMode(<span class="keyword">boolean</span> allowLazyDeployment) {</span><br><span class="line">      <span class="keyword">this</span>.allowLazyDeployment = allowLazyDeployment;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns whether we are allowed to deploy consumers lazily.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">allowLazyDeployment</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="keyword">return</span> allowLazyDeployment;</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-11-调度策略"><a href="#5-11-调度策略" class="headerlink" title="5.11 调度策略"></a>5.11 调度策略</h3><p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210715104848201.png" alt="调度策略"></p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">调度策略有三种实现：</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">EagerSchedulingStrategy：适用于流计算，同时调度所有的 task</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">LazyFromSourcesSchedulingStrategy：适用于批处理，当输入数据准备好时（上游处</span></span><br><span class="line"><span class="meta">理完）进行</span> <span class="string">vertices 调度。</span></span><br><span class="line">	<span class="meta">⚫</span> <span class="string">PipelinedRegionSchedulingStrategy：以流水线的局部为粒度进行调度</span></span><br><span class="line"></span><br><span class="line"><span class="attr">PipelinedRegionSchedulingStrategy</span> <span class="string">是 1.11 加入的，从 1.12 开始，将以 pipelined region</span></span><br><span class="line"><span class="meta">为单位进行调度。pipelined</span> <span class="string">region 是一组流水线连接的任务。这意味着，对于包含多个 region</span></span><br><span class="line"><span class="meta">的流作业，在开始部署任务之前，它不再等待所有任务获取</span> <span class="string">slot。取而代之的是，一旦任何</span></span><br><span class="line"><span class="attr">region</span> <span class="string">获得了足够的任务 slot 就可以部署它。对于批处理作业，将不会为任务分配 slot，也不会单独部署任务。取而代之的是，一旦某个 region 获得了足够的 slot，则该任务将与所有其他任务一起部署在同一区域中。</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="6、内存管理"><a href="#6、内存管理" class="headerlink" title="6、内存管理"></a>6、内存管理</h2><h3 id="6-1-flink-内存介绍"><a href="#6-1-flink-内存介绍" class="headerlink" title="6.1 flink 内存介绍"></a>6.1 flink 内存介绍</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">目前，大数据计算引擎主要用</span> <span class="string">Java 或是基于 JVM 的编程语言实现的，例如 Apache</span></span><br><span class="line"><span class="meta">Hadoop、Apache</span> <span class="string">Spark、Apache Drill、Apache Flink 等。Java 语言的好处在于程序员不需要太关注底层内存资源的管理，但同样会面临一个问题，就是如何在内存中存储大量的数据（包括缓存和高效处理）。Flink 使用自主的内存管理，来避免这个问题。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">JVM</span> <span class="string">内存管理的不足：</span></span><br><span class="line">	<span class="meta">1）Java</span> <span class="string">对象存储密度低。Java 的对象在内存中存储包含 3 个主要部分：对象头、实数据、对齐填充部分。例如，一个只包含 boolean 属性的对象占 16byte：对象头占 8byte，boolean 属性占 1byte，为了对齐达到 8 的倍数额外占 7byte。而实际上只需要一个 bit（1/8字节）就够了。</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">2）Full</span> <span class="string">GC 会极大地影响性能。尤其是为了处理更大数据而开了很大内存空间的 JVM来说，GC 会达到秒级甚至分钟级。</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">3）OOM</span> <span class="string">问题影响稳定性。OutOfMemoryError 是分布式计算框架经常会遇到的问题，当JVM中所有对象大小超过分配给JVM的内存大小时，就会发生OutOfMemoryError错误，导致 JVM 崩溃，分布式框架的健壮性和性能都会受到影响。</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">4）缓存未命中问题。CPU</span> <span class="string">进行计算的时候，是从 CPU 缓存中获取数据。现代体系的CPU 会有多级缓存，而加载的时候是以 Cache Line 为单位加载。如果能够将对象连续存储，这样就会大大降低 Cache Miss。使得 CPU 集中处理业务，而不是空转。（Java 对象在堆上存储的时候并不是连续的，所以从内存中读取 Java 对象时，缓存的邻近的内存区域的数据往往不是 CPU 下一步计算所需要的，这就是缓存未命中。此时 CPU 需要空转等待从内存中重新读取数据。）</span></span><br><span class="line">	</span><br><span class="line"><span class="attr">Flink</span> <span class="string">并不是将大量对象存在堆内存上，而是将对象都序列化到一个预分配的内存块上，这个内存块叫做 MemorySegment，它代表了一段固定长度的内存（默认大小为 32KB），也是 Flink 中最小的内存分配单元，并且提供了非常高效的读写方法，很多运算可以直接操作二进制数据，不需要反序列化即可执行。每条记录都会以序列化的形式存储在一个或多个MemorySegment 中。如果需要处理的数据多于可以保存在内存中的数据，Flink 的运算符会将部分数据溢出到磁盘。</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="6-2-内存模型"><a href="#6-2-内存模型" class="headerlink" title="6.2 内存模型"></a>6.2 内存模型</h3><p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210716101205529.png" alt="Flink 内存管理"></p>
<h4 id="6-2-1-JobManager-内存模型"><a href="#6-2-1-JobManager-内存模型" class="headerlink" title="6.2.1 JobManager 内存模型"></a>6.2.1 JobManager 内存模型</h4><p>JobManagerFlinkMemory.java</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210716101511248.png" alt="JobManagerFlinkMemory内存管理"></p>
<p>在 1.10 中，Flink 统一了 TM 端的内存管理和配置，相应的在 1.11 中，Flink 进一步 对 JM 端的内存配置进行了修改，使它的选项和配置方式与 TM 端的配置方式保持一致。</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.10 版本</span></span><br><span class="line"><span class="comment"># The heap size for the JobManager JVM</span></span><br><span class="line"><span class="attr">jobmanager.heap.size:</span> <span class="string">1024m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.11 版本及以后</span></span><br><span class="line"><span class="comment"># The total process memory size for the JobManager.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The total process memory size for the JobManager.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Note this accounts for all memory usage within the JobManager process, including JVM metaspace and other overhead.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobmanager.memory.process.size:</span> <span class="string">1600m</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># The total process memory size for the TaskManager.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Note this accounts for all memory usage within the TaskManager process, including JVM metaspace and other overhead.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">taskmanager.memory.process.size:</span> <span class="string">1728m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To exclude JVM metaspace and overhead, please, use total Flink memory size instead of 'taskmanager.memory.process.size'.</span></span><br><span class="line"><span class="comment"># It is not recommended to set both 'taskmanager.memory.process.size' and Flink memory.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">taskmanager.memory.flink.size:</span> <span class="string">1280m</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="6-2-2-TaskManager-内存模型"><a href="#6-2-2-TaskManager-内存模型" class="headerlink" title="6.2.2 TaskManager 内存模型"></a>6.2.2 TaskManager 内存模型</h4><p>Flink 1.10 对 TaskManager 的内存模型和 Flink 应用程序的配置选项进行了重大更改， 让用户能够更加严格地控制其内存开销。</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210716104455968.png" alt="Flink TaskManager 内存模型"></p>
<p>TaskExecutorFlinkMemory.java</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210716104712072.png" alt="Task Executor Flink Memory"></p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">⚫</span> <span class="string">JVM Heap：JVM 堆上内存</span></span><br><span class="line">	<span class="meta">1、Framework</span> <span class="string">Heap Memory：Flink 框架本身使用的内存，即 TaskManager 本身所</span></span><br><span class="line"><span class="meta">占用的堆上内存，不计入</span> <span class="string">Slot 的资源中。配置参数：taskmanager.memory. framework. heap.size=128MB,默认 128MB</span></span><br><span class="line">	<span class="meta">2、Task</span> <span class="string">Heap Memory：Task 执行用户代码时所使用的堆上内存。配置参数：taskmanager. memory.task.heap.size</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">⚫</span> <span class="string">Off-Heap Mempry：JVM 堆外内存</span></span><br><span class="line">	<span class="meta">1、DirectMemory：JVM</span> <span class="string">直接内存</span></span><br><span class="line">		<span class="meta">1）Framework</span> <span class="string">Off-Heap Memory：Flink框架本身所使用的内存，即TaskManager</span></span><br><span class="line"><span class="meta">本身所占用的对外内存，不计入</span> <span class="string">Slot 资源。配置参数：taskmanager.memory.framework.off-heap.size=128MB,默认 128MB</span></span><br><span class="line">		<span class="meta">2）Task</span> <span class="string">Off-Heap Memory：Task 执行用户代码所使用的对外内存。配置参数：taskma -nager.memory.task.off-heap.size=0,默认 0</span></span><br><span class="line">		<span class="meta">3）Network</span> <span class="string">Memory：网络数据交换所使用的堆外内存大小，如网络数据交换缓冲区</span></span><br><span class="line"></span><br><span class="line"><span class="attr">配置参数：</span></span><br><span class="line">	<span class="meta">taskmanager.memory.network.fraction</span>: <span class="string">0.1</span></span><br><span class="line">	<span class="meta">taskmanager.memory.network.min</span>: <span class="string">64mb</span></span><br><span class="line">	<span class="meta">taskmanager.memory.network.max</span>: <span class="string">1gb</span></span><br><span class="line">	</span><br><span class="line">	<span class="meta">2、Managed</span> <span class="string">Memory：Flink 管理的堆外内存，用于排序、哈希表、缓存中间结果及RocksDB State Backend 的本地内存。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">配置参数：</span></span><br><span class="line">	<span class="meta">taskmanager.memory.managed.fraction</span>=<span class="string">0.4</span></span><br><span class="line">	<span class="attr">taskmanager.memory.managed.size</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">⚫</span> <span class="string">JVM specific memory：JVM 本身使用的内存</span></span><br><span class="line">    <span class="meta">1、JVM</span> <span class="string">metaspace：JVM 元空间</span></span><br><span class="line">    <span class="meta">2、JVM</span> <span class="string">over-head 执行开销：JVM 执行时自身所需要的内容，包括线程堆栈、IO、编译缓存等所使用的内存。</span></span><br><span class="line">    <span class="attr">配置参数：</span></span><br><span class="line">    <span class="meta">taskmanager.memory.jvm-overhead.min</span>=<span class="string">192mb</span></span><br><span class="line">    <span class="meta">taskmanager.memory.jvm-overhead.max</span>=<span class="string">1gb</span></span><br><span class="line">    <span class="meta">taskmanager.memory.jvm-overhead.fraction</span>=<span class="string">0.1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">⚫</span> <span class="string">总体内存</span></span><br><span class="line">	<span class="meta">1、总进程内存：Flink</span> <span class="string">Java 应用程序（包括用户代码）和 JVM 运行整个进程所消耗的总内存。总进程内存 = Flink 使用内存 + JVM 元空间 + JVM 执行开销</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">配置项：taskmanager.memory.process.size</span>: <span class="string">1728m</span></span><br><span class="line">	<span class="meta">2、Flink</span> <span class="string">总内存：仅 Flink Java 应用程序消耗的内存，包括用户代码，但不包括 JVM</span></span><br><span class="line"><span class="attr">为其运行而分配的内存</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">Flink</span> <span class="string">使用内存：框架堆内外 + task 堆内外 + network + manage</span></span><br><span class="line"><span class="meta">配置项：taskmanager.memory.flink.size</span>: <span class="string">1280m</span></span><br><span class="line"><span class="attr">说明：配置项详细信息查看如下链接</span></span><br><span class="line"><span class="attr">https</span>:<span class="string">//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/config.html#memory-configuration</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="6-3-内存分配"><a href="#6-3-内存分配" class="headerlink" title="6.3 内存分配"></a>6.3 内存分配</h3><h4 id="6-3-1-JobManager-内存分配"><a href="#6-3-1-JobManager-内存分配" class="headerlink" title="6.3.1 JobManager 内存分配"></a>6.3.1 JobManager 内存分配</h4><p>YarnClusterDescriptor.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ApplicationReport <span class="title">startAppMaster</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      Configuration configuration,</span></span></span><br><span class="line"><span class="params"><span class="function">      String applicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">      String yarnClusterEntrypoint,</span></span></span><br><span class="line"><span class="params"><span class="function">      JobGraph jobGraph,</span></span></span><br><span class="line"><span class="params"><span class="function">      YarnClient yarnClient,</span></span></span><br><span class="line"><span class="params"><span class="function">      YarnClientApplication yarnApplication,</span></span></span><br><span class="line"><span class="params"><span class="function">      ClusterSpecification clusterSpecification)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ------------------ Initialize the file systems -------------------------</span></span><br><span class="line">   <span class="comment">/*TODO 初始化、创建 Hadoop的 FileSystem*/</span></span><br><span class="line">   org.apache.flink.core.fs.FileSystem.initialize(</span><br><span class="line">         configuration,</span><br><span class="line">         PluginUtils.createPluginManagerFromRootFolder(configuration));</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> FileSystem fs = FileSystem.get(yarnConfiguration);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// hard coded check for the GoogleHDFS client because its not overriding the getScheme() method.</span></span><br><span class="line">   <span class="keyword">if</span> (!fs.getClass().getSimpleName().equals(<span class="string">"GoogleHadoopFileSystem"</span>) &amp;&amp;</span><br><span class="line">         fs.getScheme().startsWith(<span class="string">"file"</span>)) {</span><br><span class="line">      LOG.warn(<span class="string">"The file system scheme is '"</span> + fs.getScheme() + <span class="string">"'. This indicates that the "</span></span><br><span class="line">            + <span class="string">"specified Hadoop configuration path is wrong and the system is using the default Hadoop configuration values."</span></span><br><span class="line">            + <span class="string">"The Flink YARN client needs to store its files in a distributed file system"</span>);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   ApplicationSubmissionContext appContext = yarnApplication.getApplicationSubmissionContext();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> List&lt;Path&gt; providedLibDirs = Utils.getQualifiedRemoteSharedPaths(configuration, yarnConfiguration);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*TODO Yarn应用的文件上传器：FS、对应的HDFS路径</span></span><br><span class="line"><span class="comment">   *     用来上传：用户jar包、flink的依赖、flink的配置文件（接下来接近300行，不用看）</span></span><br><span class="line"><span class="comment">   *     直接跳到 fileUploader.close()</span></span><br><span class="line"><span class="comment">   * */</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> YarnApplicationFileUploader fileUploader = YarnApplicationFileUploader.from(</span><br><span class="line">      fs,</span><br><span class="line">      getStagingDir(fs),</span><br><span class="line">      providedLibDirs,</span><br><span class="line">      appContext.getApplicationId(),</span><br><span class="line">      getFileReplication());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// The files need to be shipped and added to classpath.</span></span><br><span class="line">   Set&lt;File&gt; systemShipFiles = <span class="keyword">new</span> HashSet&lt;&gt;(shipFiles.size());</span><br><span class="line">   <span class="keyword">for</span> (File file : shipFiles) {</span><br><span class="line">      systemShipFiles.add(file.getAbsoluteFile());</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> String logConfigFilePath = configuration.getString(YarnConfigOptionsInternal.APPLICATION_LOG_CONFIG_FILE);</span><br><span class="line">   <span class="keyword">if</span> (logConfigFilePath != <span class="keyword">null</span>) {</span><br><span class="line">      systemShipFiles.add(<span class="keyword">new</span> File(logConfigFilePath));</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Set-up ApplicationSubmissionContext for the application</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> ApplicationId appId = appContext.getApplicationId();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ------------------ Add Zookeeper namespace to local flinkConfiguraton ------</span></span><br><span class="line">   String zkNamespace = getZookeeperNamespace();</span><br><span class="line">   <span class="comment">// no user specified cli argument for namespace?</span></span><br><span class="line">   <span class="keyword">if</span> (zkNamespace == <span class="keyword">null</span> || zkNamespace.isEmpty()) {</span><br><span class="line">      <span class="comment">// namespace defined in config? else use applicationId as default.</span></span><br><span class="line">      zkNamespace = configuration.getString(HighAvailabilityOptions.HA_CLUSTER_ID, String.valueOf(appId));</span><br><span class="line">      setZookeeperNamespace(zkNamespace);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   configuration.setString(HighAvailabilityOptions.HA_CLUSTER_ID, zkNamespace);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*TODO 高可用配置：重试次数，默认2次*/</span></span><br><span class="line">   <span class="keyword">if</span> (HighAvailabilityMode.isHighAvailabilityModeActivated(configuration)) {</span><br><span class="line">      <span class="comment">// activate re-execution of failed applications</span></span><br><span class="line">      appContext.setMaxAppAttempts(</span><br><span class="line">            configuration.getInteger(</span><br><span class="line">                  YarnConfigOptions.APPLICATION_ATTEMPTS.key(),</span><br><span class="line">                  YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS));</span><br><span class="line"></span><br><span class="line">      activateHighAvailabilitySupport(appContext);</span><br><span class="line">   } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// set number of application retries to 1 in the default case</span></span><br><span class="line">      appContext.setMaxAppAttempts(</span><br><span class="line">            configuration.getInteger(</span><br><span class="line">                  YarnConfigOptions.APPLICATION_ATTEMPTS.key(),</span><br><span class="line">                  <span class="number">1</span>));</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*TODO 添加用户jar包*/</span></span><br><span class="line">   <span class="keyword">final</span> Set&lt;Path&gt; userJarFiles = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">   <span class="keyword">if</span> (jobGraph != <span class="keyword">null</span>) {</span><br><span class="line">      userJarFiles.addAll(jobGraph.getUserJars().stream().map(f -&gt; f.toUri()).map(Path::<span class="keyword">new</span>).collect(Collectors.toSet()));</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> List&lt;URI&gt; jarUrls = ConfigUtils.decodeListFromConfig(configuration, PipelineOptions.JARS, URI::create);</span><br><span class="line">   <span class="keyword">if</span> (jarUrls != <span class="keyword">null</span> &amp;&amp; YarnApplicationClusterEntryPoint.class.getName().equals(yarnClusterEntrypoint)) {</span><br><span class="line">      userJarFiles.addAll(jarUrls.stream().map(Path::<span class="keyword">new</span>).collect(Collectors.toSet()));</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// only for per job mode</span></span><br><span class="line">   <span class="keyword">if</span> (jobGraph != <span class="keyword">null</span>) {</span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;String, DistributedCache.DistributedCacheEntry&gt; entry : jobGraph.getUserArtifacts().entrySet()) {</span><br><span class="line">         <span class="comment">// only upload local files</span></span><br><span class="line">         <span class="keyword">if</span> (!Utils.isRemotePath(entry.getValue().filePath)) {</span><br><span class="line">            Path localPath = <span class="keyword">new</span> Path(entry.getValue().filePath);</span><br><span class="line">            Tuple2&lt;Path, Long&gt; remoteFileInfo =</span><br><span class="line">                  fileUploader.uploadLocalFileToRemote(localPath, entry.getKey());</span><br><span class="line">            jobGraph.setUserArtifactRemotePath(entry.getKey(), remoteFileInfo.f0.toString());</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      jobGraph.writeUserArtifactEntriesToConfiguration();</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (providedLibDirs == <span class="keyword">null</span> || providedLibDirs.isEmpty()) {</span><br><span class="line">      addLibFoldersToShipFiles(systemShipFiles);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register all files in provided lib dirs as local resources with public visibility</span></span><br><span class="line">   <span class="comment">// and upload the remaining dependencies as local resources with APPLICATION visibility.</span></span><br><span class="line">   <span class="keyword">final</span> List&lt;String&gt; systemClassPaths = fileUploader.registerProvidedLocalResources();</span><br><span class="line">   <span class="keyword">final</span> List&lt;String&gt; uploadedDependencies = fileUploader.registerMultipleLocalResources(</span><br><span class="line">      systemShipFiles.stream().map(e -&gt; <span class="keyword">new</span> Path(e.toURI())).collect(Collectors.toSet()),</span><br><span class="line">      Path.CUR_DIR,</span><br><span class="line">      LocalResourceType.FILE);</span><br><span class="line">   systemClassPaths.addAll(uploadedDependencies);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// upload and register ship-only files</span></span><br><span class="line">   <span class="comment">// Plugin files only need to be shipped and should not be added to classpath.</span></span><br><span class="line">   <span class="keyword">if</span> (providedLibDirs == <span class="keyword">null</span> || providedLibDirs.isEmpty()) {</span><br><span class="line">      Set&lt;File&gt; shipOnlyFiles = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">      addPluginsFoldersToShipFiles(shipOnlyFiles);</span><br><span class="line">      fileUploader.registerMultipleLocalResources(</span><br><span class="line">            shipOnlyFiles.stream().map(e -&gt; <span class="keyword">new</span> Path(e.toURI())).collect(Collectors.toSet()),</span><br><span class="line">            Path.CUR_DIR,</span><br><span class="line">            LocalResourceType.FILE);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!shipArchives.isEmpty()) {</span><br><span class="line">      fileUploader.registerMultipleLocalResources(</span><br><span class="line">         shipArchives.stream().map(e -&gt; <span class="keyword">new</span> Path(e.toURI())).collect(Collectors.toSet()),</span><br><span class="line">         Path.CUR_DIR,</span><br><span class="line">         LocalResourceType.ARCHIVE);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Upload and register user jars</span></span><br><span class="line">   <span class="keyword">final</span> List&lt;String&gt; userClassPaths = fileUploader.registerMultipleLocalResources(</span><br><span class="line">      userJarFiles,</span><br><span class="line">      userJarInclusion == YarnConfigOptions.UserJarInclusion.DISABLED</span><br><span class="line">            ? ConfigConstants.DEFAULT_FLINK_USR_LIB_DIR</span><br><span class="line">            : Path.CUR_DIR,</span><br><span class="line">      LocalResourceType.FILE);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (userJarInclusion == YarnConfigOptions.UserJarInclusion.ORDER) {</span><br><span class="line">      systemClassPaths.addAll(userClassPaths);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// normalize classpath by sorting</span></span><br><span class="line">   Collections.sort(systemClassPaths);</span><br><span class="line">   Collections.sort(userClassPaths);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// classpath assembler</span></span><br><span class="line">   StringBuilder classPathBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">   <span class="keyword">if</span> (userJarInclusion == YarnConfigOptions.UserJarInclusion.FIRST) {</span><br><span class="line">      <span class="keyword">for</span> (String userClassPath : userClassPaths) {</span><br><span class="line">         classPathBuilder.append(userClassPath).append(File.pathSeparator);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">for</span> (String classPath : systemClassPaths) {</span><br><span class="line">      classPathBuilder.append(classPath).append(File.pathSeparator);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Setup jar for ApplicationMaster</span></span><br><span class="line">   <span class="keyword">final</span> YarnLocalResourceDescriptor localResourceDescFlinkJar = fileUploader.uploadFlinkDist(flinkJarPath);</span><br><span class="line">   classPathBuilder.append(localResourceDescFlinkJar.getResourceKey()).append(File.pathSeparator);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// write job graph to tmp file and add it to local resource</span></span><br><span class="line">   <span class="comment">// <span class="doctag">TODO:</span> server use user main method to generate job graph</span></span><br><span class="line">   <span class="keyword">if</span> (jobGraph != <span class="keyword">null</span>) {</span><br><span class="line">      File tmpJobGraphFile = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         tmpJobGraphFile = File.createTempFile(appId.toString(), <span class="keyword">null</span>);</span><br><span class="line">         <span class="keyword">try</span> (FileOutputStream output = <span class="keyword">new</span> FileOutputStream(tmpJobGraphFile);</span><br><span class="line">            ObjectOutputStream obOutput = <span class="keyword">new</span> ObjectOutputStream(output)) {</span><br><span class="line">            obOutput.writeObject(jobGraph);</span><br><span class="line">         }</span><br><span class="line"></span><br><span class="line">         <span class="keyword">final</span> String jobGraphFilename = <span class="string">"job.graph"</span>;</span><br><span class="line">         configuration.setString(JOB_GRAPH_FILE_PATH, jobGraphFilename);</span><br><span class="line"></span><br><span class="line">         fileUploader.registerSingleLocalResource(</span><br><span class="line">            jobGraphFilename,</span><br><span class="line">            <span class="keyword">new</span> Path(tmpJobGraphFile.toURI()),</span><br><span class="line">            <span class="string">""</span>,</span><br><span class="line">            LocalResourceType.FILE,</span><br><span class="line">            <span class="keyword">true</span>,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line">         classPathBuilder.append(jobGraphFilename).append(File.pathSeparator);</span><br><span class="line">      } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">         LOG.warn(<span class="string">"Add job graph to local resource fail."</span>);</span><br><span class="line">         <span class="keyword">throw</span> e;</span><br><span class="line">      } <span class="keyword">finally</span> {</span><br><span class="line">         <span class="keyword">if</span> (tmpJobGraphFile != <span class="keyword">null</span> &amp;&amp; !tmpJobGraphFile.delete()) {</span><br><span class="line">            LOG.warn(<span class="string">"Fail to delete temporary file {}."</span>, tmpJobGraphFile.toPath());</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Upload the flink configuration</span></span><br><span class="line">   <span class="comment">// write out configuration file</span></span><br><span class="line">   <span class="comment">/*TODO 上传Flink的配置文件 - flink-conf.yaml*/</span></span><br><span class="line">   File tmpConfigurationFile = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      tmpConfigurationFile = File.createTempFile(appId + <span class="string">"-flink-conf.yaml"</span>, <span class="keyword">null</span>);</span><br><span class="line">      BootstrapTools.writeConfiguration(configuration, tmpConfigurationFile);</span><br><span class="line"></span><br><span class="line">      String flinkConfigKey = <span class="string">"flink-conf.yaml"</span>;</span><br><span class="line">      fileUploader.registerSingleLocalResource(</span><br><span class="line">         flinkConfigKey,</span><br><span class="line">         <span class="keyword">new</span> Path(tmpConfigurationFile.getAbsolutePath()),</span><br><span class="line">         <span class="string">""</span>,</span><br><span class="line">         LocalResourceType.FILE,</span><br><span class="line">         <span class="keyword">true</span>,</span><br><span class="line">         <span class="keyword">true</span>);</span><br><span class="line">      classPathBuilder.append(<span class="string">"flink-conf.yaml"</span>).append(File.pathSeparator);</span><br><span class="line">   } <span class="keyword">finally</span> {</span><br><span class="line">      <span class="keyword">if</span> (tmpConfigurationFile != <span class="keyword">null</span> &amp;&amp; !tmpConfigurationFile.delete()) {</span><br><span class="line">         LOG.warn(<span class="string">"Fail to delete temporary file {}."</span>, tmpConfigurationFile.toPath());</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (userJarInclusion == YarnConfigOptions.UserJarInclusion.LAST) {</span><br><span class="line">      <span class="keyword">for</span> (String userClassPath : userClassPaths) {</span><br><span class="line">         classPathBuilder.append(userClassPath).append(File.pathSeparator);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//To support Yarn Secure Integration Test Scenario</span></span><br><span class="line">   <span class="comment">//In Integration test setup, the Yarn containers created by YarnMiniCluster does not have the Yarn site XML</span></span><br><span class="line">   <span class="comment">//and KRB5 configuration files. We are adding these files as container local resources for the container</span></span><br><span class="line">   <span class="comment">//applications (JM/TMs) to have proper secure cluster setup</span></span><br><span class="line">   Path remoteYarnSiteXmlPath = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (System.getenv(<span class="string">"IN_TESTS"</span>) != <span class="keyword">null</span>) {</span><br><span class="line">      File f = <span class="keyword">new</span> File(System.getenv(<span class="string">"YARN_CONF_DIR"</span>), Utils.YARN_SITE_FILE_NAME);</span><br><span class="line">      LOG.info(<span class="string">"Adding Yarn configuration {} to the AM container local resource bucket"</span>, f.getAbsolutePath());</span><br><span class="line">      Path yarnSitePath = <span class="keyword">new</span> Path(f.getAbsolutePath());</span><br><span class="line">      remoteYarnSiteXmlPath = fileUploader.registerSingleLocalResource(</span><br><span class="line">         Utils.YARN_SITE_FILE_NAME,</span><br><span class="line">         yarnSitePath,</span><br><span class="line">         <span class="string">""</span>,</span><br><span class="line">         LocalResourceType.FILE,</span><br><span class="line">         <span class="keyword">false</span>,</span><br><span class="line">         <span class="keyword">false</span>).getPath();</span><br><span class="line">      <span class="keyword">if</span> (System.getProperty(<span class="string">"java.security.krb5.conf"</span>) != <span class="keyword">null</span>) {</span><br><span class="line">         configuration.set(SecurityOptions.KERBEROS_KRB5_PATH, System.getProperty(<span class="string">"java.security.krb5.conf"</span>));</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   Path remoteKrb5Path = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">boolean</span> hasKrb5 = <span class="keyword">false</span>;</span><br><span class="line">   String krb5Config = configuration.get(SecurityOptions.KERBEROS_KRB5_PATH);</span><br><span class="line">   <span class="keyword">if</span> (!StringUtils.isNullOrWhitespaceOnly(krb5Config)) {</span><br><span class="line">      <span class="keyword">final</span> File krb5 = <span class="keyword">new</span> File(krb5Config);</span><br><span class="line">      LOG.info(<span class="string">"Adding KRB5 configuration {} to the AM container local resource bucket"</span>, krb5.getAbsolutePath());</span><br><span class="line">      <span class="keyword">final</span> Path krb5ConfPath = <span class="keyword">new</span> Path(krb5.getAbsolutePath());</span><br><span class="line">      remoteKrb5Path = fileUploader.registerSingleLocalResource(</span><br><span class="line">            Utils.KRB5_FILE_NAME,</span><br><span class="line">            krb5ConfPath,</span><br><span class="line">            <span class="string">""</span>,</span><br><span class="line">            LocalResourceType.FILE,</span><br><span class="line">            <span class="keyword">false</span>,</span><br><span class="line">            <span class="keyword">false</span>).getPath();</span><br><span class="line">      hasKrb5 = <span class="keyword">true</span>;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   Path remotePathKeytab = <span class="keyword">null</span>;</span><br><span class="line">   String localizedKeytabPath = <span class="keyword">null</span>;</span><br><span class="line">   String keytab = configuration.getString(SecurityOptions.KERBEROS_LOGIN_KEYTAB);</span><br><span class="line">   <span class="keyword">if</span> (keytab != <span class="keyword">null</span>) {</span><br><span class="line">      <span class="keyword">boolean</span>    localizeKeytab = flinkConfiguration.getBoolean(YarnConfigOptions.SHIP_LOCAL_KEYTAB);</span><br><span class="line">      localizedKeytabPath = flinkConfiguration.getString(YarnConfigOptions.LOCALIZED_KEYTAB_PATH);</span><br><span class="line">      <span class="keyword">if</span> (localizeKeytab) {</span><br><span class="line">         <span class="comment">// Localize the keytab to YARN containers via local resource.</span></span><br><span class="line">         LOG.info(<span class="string">"Adding keytab {} to the AM container local resource bucket"</span>, keytab);</span><br><span class="line">         remotePathKeytab = fileUploader.registerSingleLocalResource(</span><br><span class="line">            localizedKeytabPath,</span><br><span class="line">            <span class="keyword">new</span> Path(keytab),</span><br><span class="line">            <span class="string">""</span>,</span><br><span class="line">            LocalResourceType.FILE,</span><br><span class="line">            <span class="keyword">false</span>,</span><br><span class="line">            <span class="keyword">false</span>).getPath();</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">         <span class="comment">// // Assume Keytab is pre-installed in the container.</span></span><br><span class="line">         localizedKeytabPath = flinkConfiguration.getString(YarnConfigOptions.LOCALIZED_KEYTAB_PATH);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*TODO jobmanager内存配置*/</span></span><br><span class="line">   <span class="keyword">final</span> JobManagerProcessSpec processSpec = JobManagerProcessUtils.processSpecFromConfigWithNewOptionToInterpretLegacyHeap(</span><br><span class="line">      flinkConfiguration,</span><br><span class="line">      JobManagerOptions.TOTAL_PROCESS_MEMORY);</span><br><span class="line">   <span class="keyword">final</span> ContainerLaunchContext amContainer = setupApplicationMasterContainer(</span><br><span class="line">         yarnClusterEntrypoint,</span><br><span class="line">         hasKrb5,</span><br><span class="line">         processSpec);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// setup security tokens</span></span><br><span class="line">   <span class="keyword">if</span> (UserGroupInformation.isSecurityEnabled()) {</span><br><span class="line">      <span class="comment">// set HDFS delegation tokens when security is enabled</span></span><br><span class="line">      LOG.info(<span class="string">"Adding delegation token to the AM container."</span>);</span><br><span class="line">      List&lt;Path&gt; yarnAccessList = ConfigUtils.decodeListFromConfig(configuration, YarnConfigOptions.YARN_ACCESS, Path::<span class="keyword">new</span>);</span><br><span class="line">      Utils.setTokensFor(amContainer,</span><br><span class="line">         ListUtils.union(yarnAccessList, fileUploader.getRemotePaths()), yarnConfiguration</span><br><span class="line">      );</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   amContainer.setLocalResources(fileUploader.getRegisteredLocalResources());</span><br><span class="line">   fileUploader.close();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Setup CLASSPATH and environment variables for ApplicationMaster</span></span><br><span class="line">   <span class="comment">/*TODO 创建Map，用来存储 AM的环境变量和类路径*/</span></span><br><span class="line">   <span class="keyword">final</span> Map&lt;String, String&gt; appMasterEnv = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   <span class="comment">// set user specified app master environment variables</span></span><br><span class="line">   appMasterEnv.putAll(</span><br><span class="line">      ConfigurationUtils.getPrefixedKeyValuePairs(ResourceManagerOptions.CONTAINERIZED_MASTER_ENV_PREFIX, configuration));</span><br><span class="line">   <span class="comment">// set Flink app class path</span></span><br><span class="line">   appMasterEnv.put(YarnConfigKeys.ENV_FLINK_CLASSPATH, classPathBuilder.toString());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// set Flink on YARN internal configuration values</span></span><br><span class="line">   appMasterEnv.put(YarnConfigKeys.FLINK_DIST_JAR, localResourceDescFlinkJar.toString());</span><br><span class="line">   appMasterEnv.put(YarnConfigKeys.ENV_APP_ID, appId.toString());</span><br><span class="line">   appMasterEnv.put(YarnConfigKeys.ENV_CLIENT_HOME_DIR, fileUploader.getHomeDir().toString());</span><br><span class="line">   appMasterEnv.put(YarnConfigKeys.ENV_CLIENT_SHIP_FILES, encodeYarnLocalResourceDescriptorListToString(fileUploader.getEnvShipResourceList()));</span><br><span class="line">   appMasterEnv.put(YarnConfigKeys.ENV_ZOOKEEPER_NAMESPACE, getZookeeperNamespace());</span><br><span class="line">   appMasterEnv.put(YarnConfigKeys.FLINK_YARN_FILES, fileUploader.getApplicationDir().toUri().toString());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// https://github.com/apache/hadoop/blob/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-site/src/site/markdown/YarnApplicationSecurity.md#identity-on-an-insecure-cluster-hadoop_user_name</span></span><br><span class="line">   appMasterEnv.put(YarnConfigKeys.ENV_HADOOP_USER_NAME, UserGroupInformation.getCurrentUser().getUserName());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (localizedKeytabPath != <span class="keyword">null</span>) {</span><br><span class="line">      appMasterEnv.put(YarnConfigKeys.LOCAL_KEYTAB_PATH, localizedKeytabPath);</span><br><span class="line">      String principal = configuration.getString(SecurityOptions.KERBEROS_LOGIN_PRINCIPAL);</span><br><span class="line">      appMasterEnv.put(YarnConfigKeys.KEYTAB_PRINCIPAL, principal);</span><br><span class="line">      <span class="keyword">if</span> (remotePathKeytab != <span class="keyword">null</span>) {</span><br><span class="line">         appMasterEnv.put(YarnConfigKeys.REMOTE_KEYTAB_PATH, remotePathKeytab.toString());</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//To support Yarn Secure Integration Test Scenario</span></span><br><span class="line">   <span class="keyword">if</span> (remoteYarnSiteXmlPath != <span class="keyword">null</span>) {</span><br><span class="line">      appMasterEnv.put(YarnConfigKeys.ENV_YARN_SITE_XML_PATH, remoteYarnSiteXmlPath.toString());</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">if</span> (remoteKrb5Path != <span class="keyword">null</span>) {</span><br><span class="line">      appMasterEnv.put(YarnConfigKeys.ENV_KRB5_PATH, remoteKrb5Path.toString());</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// set classpath from YARN configuration</span></span><br><span class="line">   Utils.setupYarnClassPath(yarnConfiguration, appMasterEnv);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*TODO 将之前封装的 Map（AM的环境信息、类路径），设置到容器里*/</span></span><br><span class="line">   amContainer.setEnvironment(appMasterEnv);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Set up resource type requirements for ApplicationMaster</span></span><br><span class="line">   Resource capability = Records.newRecord(Resource.class);</span><br><span class="line">   capability.setMemory(clusterSpecification.getMasterMemoryMB());</span><br><span class="line">   capability.setVirtualCores(flinkConfiguration.getInteger(YarnConfigOptions.APP_MASTER_VCORES));</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> String customApplicationName = customName != <span class="keyword">null</span> ? customName : applicationName;</span><br><span class="line"></span><br><span class="line">   appContext.setApplicationName(customApplicationName);</span><br><span class="line">   appContext.setApplicationType(applicationType != <span class="keyword">null</span> ? applicationType : <span class="string">"Apache Flink"</span>);</span><br><span class="line">   appContext.setAMContainerSpec(amContainer);</span><br><span class="line">   appContext.setResource(capability);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Set priority for application</span></span><br><span class="line">   <span class="keyword">int</span> priorityNum = flinkConfiguration.getInteger(YarnConfigOptions.APPLICATION_PRIORITY);</span><br><span class="line">   <span class="keyword">if</span> (priorityNum &gt;= <span class="number">0</span>) {</span><br><span class="line">      Priority priority = Priority.newInstance(priorityNum);</span><br><span class="line">      appContext.setPriority(priority);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (yarnQueue != <span class="keyword">null</span>) {</span><br><span class="line">      appContext.setQueue(yarnQueue);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   setApplicationNodeLabel(appContext);</span><br><span class="line"></span><br><span class="line">   setApplicationTags(appContext);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// add a hook to clean up in case deployment fails</span></span><br><span class="line">   Thread deploymentFailureHook = <span class="keyword">new</span> DeploymentFailureHook(yarnApplication, fileUploader.getApplicationDir());</span><br><span class="line">   Runtime.getRuntime().addShutdownHook(deploymentFailureHook);</span><br><span class="line">   LOG.info(<span class="string">"Submitting application master "</span> + appId);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*TODO 前面做了很多上传、环境配置，终于可以提交应用了*/</span></span><br><span class="line">   yarnClient.submitApplication(appContext);</span><br><span class="line"></span><br><span class="line">   LOG.info(<span class="string">"Waiting for the cluster to be allocated"</span>);</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">   ApplicationReport report;</span><br><span class="line">   YarnApplicationState lastAppState = YarnApplicationState.NEW;</span><br><span class="line">   loop: <span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">         report = yarnClient.getApplicationReport(appId);</span><br><span class="line">      } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> YarnDeploymentException(<span class="string">"Failed to deploy the cluster."</span>, e);</span><br><span class="line">      }</span><br><span class="line">      YarnApplicationState appState = report.getYarnApplicationState();</span><br><span class="line">      LOG.debug(<span class="string">"Application State: {}"</span>, appState);</span><br><span class="line">      <span class="keyword">switch</span>(appState) {</span><br><span class="line">         <span class="keyword">case</span> FAILED:</span><br><span class="line">         <span class="keyword">case</span> KILLED:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> YarnDeploymentException(<span class="string">"The YARN application unexpectedly switched to state "</span></span><br><span class="line">                  + appState + <span class="string">" during deployment. \n"</span> +</span><br><span class="line">                  <span class="string">"Diagnostics from YARN: "</span> + report.getDiagnostics() + <span class="string">"\n"</span> +</span><br><span class="line">                  <span class="string">"If log aggregation is enabled on your cluster, use this command to further investigate the issue:\n"</span> +</span><br><span class="line">                  <span class="string">"yarn logs -applicationId "</span> + appId);</span><br><span class="line">            <span class="comment">//break ..</span></span><br><span class="line">         <span class="keyword">case</span> RUNNING:</span><br><span class="line">            LOG.info(<span class="string">"YARN application has been deployed successfully."</span>);</span><br><span class="line">            <span class="keyword">break</span> loop;</span><br><span class="line">         <span class="keyword">case</span> FINISHED:</span><br><span class="line">            LOG.info(<span class="string">"YARN application has been finished successfully."</span>);</span><br><span class="line">            <span class="keyword">break</span> loop;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">if</span> (appState != lastAppState) {</span><br><span class="line">               LOG.info(<span class="string">"Deploying cluster, current state "</span> + appState);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis() - startTime &gt; <span class="number">60000</span>) {</span><br><span class="line">               LOG.info(<span class="string">"Deployment took more than 60 seconds. Please check if the requested resources are available in the YARN cluster"</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">      }</span><br><span class="line">      lastAppState = appState;</span><br><span class="line">      Thread.sleep(<span class="number">250</span>);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">// since deployment was successful, remove the hook</span></span><br><span class="line">   ShutdownHookUtil.removeShutdownHook(deploymentFailureHook, getClass().getSimpleName(), LOG);</span><br><span class="line">   <span class="keyword">return</span> report;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>JobManagerProcessUtils.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobManagerProcessSpec <span class="title">processSpecFromConfigWithNewOptionToInterpretLegacyHeap</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      Configuration config,</span></span></span><br><span class="line"><span class="params"><span class="function">      ConfigOption&lt;MemorySize&gt; newOptionToInterpretLegacyHeap)</span> </span>{</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">return</span> processSpecFromConfig(</span><br><span class="line">         getConfigurationWithLegacyHeapSizeMappedToNewConfigOption(</span><br><span class="line">            config,</span><br><span class="line">            newOptionToInterpretLegacyHeap));</span><br><span class="line">   } <span class="keyword">catch</span> (IllegalConfigurationException e) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalConfigurationException(<span class="string">"JobManager memory configuration failed: "</span> + e.getMessage(), e);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> JobManagerProcessSpec <span class="title">processSpecFromConfig</span><span class="params">(Configuration config)</span> </span>{</span><br><span class="line">   <span class="keyword">return</span> createMemoryProcessSpec(PROCESS_MEMORY_UTILS.memoryProcessSpecFromConfig(config));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ProcessMemoryUtils.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> CommonProcessMemorySpec&lt;FM&gt; <span class="title">memoryProcessSpecFromConfig</span><span class="params">(Configuration config)</span> </span>{</span><br><span class="line">   <span class="keyword">if</span> (options.getRequiredFineGrainedOptions().stream().allMatch(config::contains)) {</span><br><span class="line">      <span class="comment">// all internal memory options are configured, use these to derive total Flink and process memory</span></span><br><span class="line">      <span class="keyword">return</span> deriveProcessSpecWithExplicitInternalMemory(config);</span><br><span class="line">   } <span class="keyword">else</span> <span class="keyword">if</span> (config.contains(options.getTotalFlinkMemoryOption())) {</span><br><span class="line">      <span class="comment">/*TODO 如果配置文件，配置的是 flink内存 的方式*/</span></span><br><span class="line">      <span class="comment">// internal memory options are not configured, total Flink memory is configured,</span></span><br><span class="line">      <span class="comment">// derive from total flink memory</span></span><br><span class="line">      <span class="keyword">return</span> deriveProcessSpecWithTotalFlinkMemory(config);</span><br><span class="line">   } <span class="keyword">else</span> <span class="keyword">if</span> (config.contains(options.getTotalProcessMemoryOption())) {</span><br><span class="line">      <span class="comment">/*TODO 如果配置文件，配置的是 进程内存 的方式*/</span></span><br><span class="line">      <span class="comment">// total Flink memory is not configured, total process memory is configured,</span></span><br><span class="line">      <span class="comment">// derive from total process memory</span></span><br><span class="line">      <span class="keyword">return</span> deriveProcessSpecWithTotalProcessMemory(config);</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> failBecauseRequiredOptionsNotConfigured();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> CommonProcessMemorySpec&lt;FM&gt; <span class="title">deriveProcessSpecWithTotalFlinkMemory</span><span class="params">(Configuration config)</span> </span>{</span><br><span class="line">   MemorySize totalFlinkMemorySize = getMemorySizeFromConfig(config, options.getTotalFlinkMemoryOption());</span><br><span class="line">   <span class="comment">// 获取 JM 的 Flink 总内存</span></span><br><span class="line">   FM flinkInternalMemory = flinkMemoryUtils.deriveFromTotalFlinkMemory(config, totalFlinkMemorySize);</span><br><span class="line">   <span class="comment">// 获取 JM 的 JVM 元空间和执行开销</span></span><br><span class="line">   JvmMetaspaceAndOverhead jvmMetaspaceAndOverhead = deriveJvmMetaspaceAndOverheadFromTotalFlinkMemory(config, totalFlinkMemorySize);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> CommonProcessMemorySpec&lt;&gt;(flinkInternalMemory, jvmMetaspaceAndOverhead);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>JobManagerFlinkMemoryUtils.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobManagerFlinkMemory <span class="title">deriveFromTotalFlinkMemory</span><span class="params">(Configuration config, MemorySize totalFlinkMemorySize)</span> </span>{</span><br><span class="line">   MemorySize offHeapMemorySize = ProcessMemoryUtils.getMemorySizeFromConfig(config, JobManagerOptions.OFF_HEAP_MEMORY);</span><br><span class="line">   <span class="keyword">if</span> (totalFlinkMemorySize.compareTo(offHeapMemorySize) &lt; <span class="number">1</span>) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalConfigurationException(</span><br><span class="line">         <span class="string">"The configured Total Flink Memory (%s) is less than the configured Off-heap Memory (%s)."</span>,</span><br><span class="line">         totalFlinkMemorySize.toHumanReadableString(),</span><br><span class="line">         offHeapMemorySize.toHumanReadableString());</span><br><span class="line">   }</span><br><span class="line">   MemorySize derivedJvmHeapMemorySize = totalFlinkMemorySize.subtract(offHeapMemorySize);</span><br><span class="line">   <span class="keyword">return</span> createJobManagerFlinkMemory(derivedJvmHeapMemorySize, offHeapMemorySize);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JobManagerFlinkMemory <span class="title">createJobManagerFlinkMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      MemorySize jvmHeap,</span></span></span><br><span class="line"><span class="params"><span class="function">      MemorySize offHeapMemory)</span> </span>{</span><br><span class="line">   verifyJvmHeapSize(jvmHeap);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> JobManagerFlinkMemory(jvmHeap, offHeapMemory);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="6-3-2-TaskManager-内存分配"><a href="#6-3-2-TaskManager-内存分配" class="headerlink" title="6.3.2 TaskManager 内存分配"></a>6.3.2 TaskManager 内存分配</h4><p>ActiveResourceManager.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">requestNewWorker</span><span class="params">(WorkerResourceSpec workerResourceSpec)</span> </span>{</span><br><span class="line">   <span class="keyword">final</span> TaskExecutorProcessSpec taskExecutorProcessSpec =</span><br><span class="line">         TaskExecutorProcessUtils.processSpecFromWorkerResourceSpec(flinkConfig, workerResourceSpec);</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> pendingCount = pendingWorkerCounter.increaseAndGet(workerResourceSpec);</span><br><span class="line"></span><br><span class="line">   log.info(<span class="string">"Requesting new worker with resource spec {}, current pending count: {}."</span>,</span><br><span class="line">         workerResourceSpec,</span><br><span class="line">         pendingCount);</span><br><span class="line"></span><br><span class="line">   CompletableFuture&lt;WorkerType&gt; requestResourceFuture = resourceManagerDriver.requestResource(taskExecutorProcessSpec);</span><br><span class="line">   FutureUtils.assertNoException(</span><br><span class="line">         requestResourceFuture.handle((worker, exception) -&gt; {</span><br><span class="line">            <span class="keyword">if</span> (exception != <span class="keyword">null</span>) {</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> count = pendingWorkerCounter.decreaseAndGet(workerResourceSpec);</span><br><span class="line">               log.warn(<span class="string">"Failed requesting worker with resource spec {}, current pending count: {}, exception: {}"</span>,</span><br><span class="line">                     workerResourceSpec,</span><br><span class="line">                     count,</span><br><span class="line">                     exception);</span><br><span class="line">               requestWorkerIfRequired();</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">               <span class="keyword">final</span> ResourceID resourceId = worker.getResourceID();</span><br><span class="line">               workerNodeMap.put(resourceId, worker);</span><br><span class="line">               currentAttemptUnregisteredWorkers.put(resourceId, workerResourceSpec);</span><br><span class="line">               log.info(<span class="string">"Requested worker {} with resource spec {}."</span>,</span><br><span class="line">                     resourceId.getStringWithMetadata(),</span><br><span class="line">                     workerResourceSpec);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         }));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>TaskExecutorProcessUtils.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TaskExecutorProcessSpec <span class="title">processSpecFromWorkerResourceSpec</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">final</span> Configuration config, <span class="keyword">final</span> WorkerResourceSpec workerResourceSpec)</span> </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> MemorySize frameworkHeapMemorySize = TaskExecutorFlinkMemoryUtils.getFrameworkHeapMemorySize(config);</span><br><span class="line">   <span class="keyword">final</span> MemorySize frameworkOffHeapMemorySize = TaskExecutorFlinkMemoryUtils.getFrameworkOffHeapMemorySize(config);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> TaskExecutorFlinkMemory flinkMemory = <span class="keyword">new</span> TaskExecutorFlinkMemory(</span><br><span class="line">      frameworkHeapMemorySize,</span><br><span class="line">      frameworkOffHeapMemorySize,</span><br><span class="line">      workerResourceSpec.getTaskHeapSize(),</span><br><span class="line">      workerResourceSpec.getTaskOffHeapSize(),</span><br><span class="line">      workerResourceSpec.getNetworkMemSize(),</span><br><span class="line">      workerResourceSpec.getManagedMemSize());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> JvmMetaspaceAndOverhead jvmMetaspaceAndOverhead =</span><br><span class="line">      PROCESS_MEMORY_UTILS.deriveJvmMetaspaceAndOverheadFromTotalFlinkMemory(</span><br><span class="line">         config, flinkMemory.getTotalFlinkMemorySize());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> TaskExecutorProcessSpec(workerResourceSpec.getCpuCores(), flinkMemory, jvmMetaspaceAndOverhead);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="6-4-内存数据结构"><a href="#6-4-内存数据结构" class="headerlink" title="6.4 内存数据结构"></a>6.4 内存数据结构</h3><h4 id="6-4-1-内存段"><a href="#6-4-1-内存段" class="headerlink" title="6.4.1 内存段"></a>6.4.1 内存段</h4><p>内存段在 Flink 内部叫 MemorySegment，是 Flink 中最小的内存分配单元，默认大 小 32KB。它即可以是堆上内存（Java 的 byte 数组），也可以是堆外内存（基于 Netty 的 DirectByteBuffer），同时提供了对二进制数据进行读取和写入的方法。</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210716110128334.png" alt="内存段"></p>
<p>HeapMemorySegment：用来分配堆上内存 HybridMemorySegment：用来分配堆外内存和堆上内存，2017 年以后的版本实 际上只使用了 HybridMemo`rySegment。 如下图展示一个内嵌型的 Tuple3 对象的序列化过程：</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210716110205405.png" alt="Memory Segment"></p>
<p>可以看出这种序列化方式存储密度是相当紧凑的。其中 int 占 4 字节，double 占 8 字 节，POJO 多个一个字节的 header，PojoSerializer 只负责将 header 序列化进去，并委托每个 字段对应的 serializer 对字段进行序列化。</p>
<p>⚫ 内存页 内存页是 MemorySegment 之上的数据访问视图，数据读取抽象为 DataInputView， 数据写入抽象为 DataOutputView。使用时就无需关心 MemorySegment 的细节，会自 动处理跨 MemorySegment 的读取和写入。</p>
<p> ⚫ Buffer Task 算子之间在网络层面上传输数据，使用的是 Buffer，申请和释放由 Flink</p>
<p>自行管理，实现类为 NetworkBuffer。1 个 NetworkBuffer 包装了 1 个 MemorySegment。同时继承了 AbstractReferenceCountedByteBuf，是 Netty 中的抽 象类。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkBuffer</span> <span class="keyword">extends</span> <span class="title">AbstractReferenceCountedByteBuf</span> <span class="keyword">implements</span> <span class="title">Buffer</span> </span>{</span><br><span class="line">	....</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>⚫ Buffer 资源池 BufferPool 用来管理 Buffer，包含 Buffer 的申请、释放、销毁、可用 Buffer 通知 等，实现类是 LocalBufferPool，每个 Task 拥有自己的 LocalBufferPool。</p>
<p>BufferPoolFactory 用 来 提 供 BufferPool 的 创 建 和 销 毁 ， 唯 一 的 实 现 类 是 NetworkBufferPool ， 每 个 TaskManager 只 有 一 个 NetworkBufferPool 。 同一个 TaskManager 上的 Task 共享 NetworkBufferPool，在 TaskManager 启动的时候创建并 分配内存。</p>
<h3 id="6-5-内存管理器"><a href="#6-5-内存管理器" class="headerlink" title="6.5 内存管理器"></a>6.5 内存管理器</h3><p>​    MemoryManager 用来管理 Flink 中用于排序、Hash 表、中间结果的缓存或使用堆外内 存的状态后端（RocksDB）的内存。 1.10 之前版本，负责 TaskManager 所有内存。 1.10 版本开始，管理范围是 Slot 级别。</p>
<h4 id="6-5-1-堆外内存资源申请"><a href="#6-5-1-堆外内存资源申请" class="headerlink" title="6.5.1 堆外内存资源申请"></a>6.5.1 堆外内存资源申请</h4><p>MemoryManager.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">allocatePages</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      Object owner,</span></span></span><br><span class="line"><span class="params"><span class="function">      Collection&lt;MemorySegment&gt; target,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">int</span> numberOfPages)</span> <span class="keyword">throws</span> MemoryAllocationException </span>{</span><br><span class="line">   <span class="comment">// sanity check</span></span><br><span class="line">   Preconditions.checkNotNull(owner, <span class="string">"The memory owner must not be null."</span>);</span><br><span class="line">   Preconditions.checkState(!isShutDown, <span class="string">"Memory manager has been shut down."</span>);</span><br><span class="line">   Preconditions.checkArgument(</span><br><span class="line">      numberOfPages &lt;= totalNumberOfPages,</span><br><span class="line">      <span class="string">"Cannot allocate more segments %d than the max number %d"</span>,</span><br><span class="line">      numberOfPages,</span><br><span class="line">      totalNumberOfPages);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// reserve array space, if applicable</span></span><br><span class="line">   <span class="keyword">if</span> (target <span class="keyword">instanceof</span> ArrayList) {</span><br><span class="line">      ((ArrayList&lt;MemorySegment&gt;) target).ensureCapacity(numberOfPages);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">long</span> memoryToReserve = numberOfPages * pageSize;</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      memoryBudget.reserveMemory(memoryToReserve);</span><br><span class="line">   } <span class="keyword">catch</span> (MemoryReservationException e) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> MemoryAllocationException(String.format(<span class="string">"Could not allocate %d pages"</span>, numberOfPages), e);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   Runnable pageCleanup = <span class="keyword">this</span>::releasePage;</span><br><span class="line">   allocatedSegments.compute(owner, (o, currentSegmentsForOwner) -&gt; {</span><br><span class="line">      Set&lt;MemorySegment&gt; segmentsForOwner = currentSegmentsForOwner == <span class="keyword">null</span> ?</span><br><span class="line">         <span class="keyword">new</span> HashSet&lt;&gt;(numberOfPages) : currentSegmentsForOwner;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">long</span> i = numberOfPages; i &gt; <span class="number">0</span>; i--) {</span><br><span class="line">         MemorySegment segment = allocateOffHeapUnsafeMemory(getPageSize(), owner, pageCleanup);</span><br><span class="line">         target.add(segment);</span><br><span class="line">         segmentsForOwner.add(segment);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> segmentsForOwner;</span><br><span class="line">   });</span><br><span class="line"></span><br><span class="line">   Preconditions.checkState(!isShutDown, <span class="string">"Memory manager has been concurrently shut down."</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>MemorySegmentFactory.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MemorySegment <span class="title">allocateOffHeapUnsafeMemory</span><span class="params">(<span class="keyword">int</span> size, Object owner, Runnable customCleanupAction)</span> </span>{</span><br><span class="line">   <span class="keyword">long</span> address = MemoryUtils.allocateUnsafe(size);</span><br><span class="line">   ByteBuffer offHeapBuffer = MemoryUtils.wrapUnsafeMemoryWithByteBuffer(address, size);</span><br><span class="line">   MemoryUtils.createMemoryGcCleaner(offHeapBuffer, address, customCleanupAction);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> HybridMemorySegment(offHeapBuffer, owner);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="6-5-2-RocksDB-自己负责内存申请和释放"><a href="#6-5-2-RocksDB-自己负责内存申请和释放" class="headerlink" title="6.5.2 RocksDB 自己负责内存申请和释放"></a>6.5.2 RocksDB 自己负责内存申请和释放</h4><p>RocksDBOperationUtils.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OpaqueMemoryResource&lt;RocksDBSharedResources&gt; <span class="title">allocateSharedCachesIfConfigured</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      RocksDBMemoryConfiguration memoryConfig,</span></span></span><br><span class="line"><span class="params"><span class="function">      MemoryManager memoryManager,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">double</span> memoryFraction,</span></span></span><br><span class="line"><span class="params"><span class="function">      Logger logger)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!memoryConfig.isUsingFixedMemoryPerSlot() &amp;&amp; !memoryConfig.isUsingManagedMemory()) {</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">double</span> highPriorityPoolRatio = memoryConfig.getHighPriorityPoolRatio();</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">double</span> writeBufferRatio = memoryConfig.getWriteBufferRatio();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> LongFunctionWithException&lt;RocksDBSharedResources, Exception&gt; allocator = (size) -&gt;</span><br><span class="line">      RocksDBMemoryControllerUtils.allocateRocksDBSharedResources(size, writeBufferRatio, highPriorityPoolRatio);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">if</span> (memoryConfig.isUsingFixedMemoryPerSlot()) {</span><br><span class="line">         <span class="keyword">assert</span> memoryConfig.getFixedMemoryPerSlot() != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">         logger.info(<span class="string">"Getting fixed-size shared cache for RocksDB."</span>);</span><br><span class="line">         <span class="keyword">return</span> memoryManager.getExternalSharedMemoryResource(</span><br><span class="line">               FIXED_SLOT_MEMORY_RESOURCE_ID, allocator, memoryConfig.getFixedMemoryPerSlot().getBytes());</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span> {</span><br><span class="line">         logger.info(<span class="string">"Getting managed memory shared cache for RocksDB."</span>);</span><br><span class="line">         <span class="keyword">return</span> memoryManager.getSharedMemoryResourceForManagedMemory(MANAGED_MEMORY_RESOURCE_ID, allocator, memoryFraction);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Failed to acquire shared cache resource for RocksDB"</span>, e);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>MemoryManager.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends AutoCloseable&gt; <span class="function">OpaqueMemoryResource&lt;T&gt; <span class="title">getExternalSharedMemoryResource</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      String type,</span></span></span><br><span class="line"><span class="params"><span class="function">      LongFunctionWithException&lt;T, Exception&gt; initializer,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">long</span> numBytes)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"></span><br><span class="line">   <span class="comment">// This object identifies the lease in this request. It is used only to identify the release operation.</span></span><br><span class="line">   <span class="comment">// Using the object to represent the lease is a bit nicer safer than just using a reference counter.</span></span><br><span class="line">   <span class="keyword">final</span> Object leaseHolder = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> SharedResources.ResourceAndSize&lt;T&gt; resource =</span><br><span class="line">         sharedResources.getOrAllocateSharedResource(type, leaseHolder, initializer, numBytes);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> ThrowingRunnable&lt;Exception&gt; disposer = () -&gt; sharedResources.release(type, leaseHolder);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> OpaqueMemoryResource&lt;&gt;(resource.resourceHandle(), resource.size(), disposer);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="6-6-网络传输中的内存管理"><a href="#6-6-网络传输中的内存管理" class="headerlink" title="6.6 网络传输中的内存管理"></a>6.6 网络传输中的内存管理</h3><p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210716110900387.png" alt="内存管理"></p>
<p>网络上传输的数据会写到 Task 的 InputGate（IG）中，经过 Task 的处理后，再由 Task 写到 ResultPartition（RS） 中。每个 Task 都包括了输入和输入，输入和输出的数据存在 Buffer 中（都是字节数据）。Buffer 是 MemorySegment 的包装类。</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">1）TaskManager（TM）在启动时，会先初始化</span> <span class="string">NetworkEnvironment 对象，TM 中所有</span></span><br><span class="line"><span class="meta">与网络相关的东西都由该类来管理（如</span> <span class="string">Netty 连接），其中就包括 NetworkBufferPool。根据</span></span><br><span class="line"><span class="meta">配置，</span> <span class="string">Flink 会 在 NetworkBufferPool 中 生 成 一 定 数 量 （ 默 认 2048 ） 的 内 存 块MemorySegment（关于 Flink 的内存管理，后续文章会详细谈到），内存块的总数量就代表</span></span><br><span class="line"><span class="meta">了网络传输中所有可用的内存。NetworkEnvironment</span> <span class="string">和 NetworkBufferPool 是 Task 之间共</span></span><br><span class="line"><span class="meta">享的，每个</span> <span class="string">TM 只会实例化一个。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">2）Task</span> <span class="string">线程启动时，会向 NetworkEnvironment 注册，NetworkEnvironment 会为 Task</span></span><br><span class="line"><span class="meta">的</span> <span class="string">InputGate（IG）和 ResultPartition（RP） 分别创建一个 LocalBufferPool（缓冲池）并设置可申请的 MemorySegment（内存块）数量。IG 对应的缓冲池初始的内存块数量与 IG 中</span></span><br><span class="line"><span class="attr">InputChannel</span> <span class="string">数量一致，RP 对应的缓冲池初始的内存块数量与 RP 中的 ResultSubpartition</span></span><br><span class="line"><span class="meta">数量一致。不过，每当创建或销毁缓冲池时，NetworkBufferPool</span> <span class="string">会计算剩余空闲的内存块数量，并平均分配给已创建的缓冲池。注意，这个过程只是指定了缓冲池所能使用的内存块数量，并没有真正分配内存块，只有当需要时才分配。为什么要动态地为缓冲池扩容呢？因为内存越多，意味着系统可以更轻松地应对瞬时压力（如 GC），不会频繁地进入反压状态，所以我们要利用起那部分闲置的内存块。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">3）在</span> <span class="string">Task 线程执行过程中，当 Netty 接收端收到数据时，为了将 Netty 中的数据拷贝到 Task 中，InputChannel（实际是 RemoteInputChannel）会向其对应的缓冲池申请内存块（上图中的①）。如果缓冲池中也没有可用的内存块且已申请的数量还没到池子上限，则会向NetworkBufferPool 申请内存块（上图中的②）并交给 InputChannel 填上数据（上图中的③和④）。如果缓冲池已申请的数量达到上限了呢？或者 NetworkBufferPool 也没有可用内存块了呢？这时候，Task 的 Netty Channel 会暂停读取，上游的发送端会立即响应停止发送，拓扑会进入反压状态。当 Task 线程写数据到 ResultPartition 时，也会向缓冲池请求内存块，如果没有可用内存块时，会阻塞在请求内存块的地方，达到暂停写入的目的。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">4）当一个内存块被消费完成之后（在输入端是指内存块中的字节被反序列化成对象了，在输出端是指内存块中的字节写入到</span> <span class="string">Netty Channel 了），会调用 Buffer.recycle() 方法，会将内存块还给 LocalBufferPool （上图中的⑤）。如果 LocalBufferPool 中当前申请的数量超过了池子容量（由于上文提到的动态容量，由于新注册的 Task 导致该池子容量变小），则LocalBufferPool 会将该内存块回收给 NetworkBufferPool（上图中的⑥）。如果没超过池子容量，则会继续留在池子中，减少反复申请的开销。</span></span><br></pre></td></tr></tbody></table></figure>

<p>⚫ 反压的过程</p>
<p><img src="/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20210716111051546.png" alt="反压过程"></p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">1）记录“A”进入了</span> <span class="string">Flink 并且被 Task 1 处理。（这里省略了 Netty 接收、反序列化</span></span><br><span class="line"><span class="attr">等过程）</span></span><br><span class="line"><span class="meta">2）记录被序列化到</span> <span class="string">buffer 中。</span></span><br><span class="line"><span class="meta">3）该</span> <span class="string">buffer 被发送到 Task 2，然后 Task 2 从这个 buffer 中读出记录。</span></span><br><span class="line"><span class="meta">记录能被</span> <span class="string">Flink 处理的前提是：必须有空闲可用的 Buffer。</span></span><br><span class="line"><span class="meta">结合上面两张图看：Task</span> <span class="string">1 在输出端有一个相关联的 LocalBufferPool（称缓冲池 1），</span></span><br><span class="line"><span class="attr">Task</span> <span class="string">2 在输入端也有一个相关联的 LocalBufferPool（称缓冲池 2）。如果缓冲池 1 中有空闲</span></span><br><span class="line"><span class="meta">可用的</span> <span class="string">buffer 来序列化记录 “A”，我们就序列化并发送该 buffer。</span></span><br><span class="line"><span class="attr">注意两个场景：</span></span><br><span class="line"><span class="meta">1）本地传输：如果</span> <span class="string">Task 1 和 Task 2 运行在同一个 worker 节点（TaskManager），该</span></span><br><span class="line"><span class="attr">buffer</span> <span class="string">可以直接交给下一个 Task。一旦 Task 2 消费了该 buffer，则该 buffer 会被缓冲池 1回收。如果 Task 2 的速度比 1 慢，那么 buffer 回收的速度就会赶不上 Task 1 取 buffer</span></span><br><span class="line"><span class="meta">的速度，导致缓冲池</span> <span class="string">1 无可用的 buffer，Task 1 等待在可用的 buffer 上。最终形成 Task 1</span></span><br><span class="line"><span class="attr">的降速。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">2）远程传输：如果</span> <span class="string">Task 1 和 Task 2 运行在不同的 worker 节点上，那么 buffer 会在</span></span><br><span class="line"><span class="meta">发送到网络（TCP</span> <span class="string">Channel）后被回收。在接收端，会从 LocalBufferPool 中申请 buffer，然</span></span><br><span class="line"><span class="meta">后拷贝网络中的数据到</span> <span class="string">buffer 中。如果没有可用的 buffer，会停止从 TCP 连接中读取数据。</span></span><br><span class="line"><span class="meta">在输出端，通过</span> <span class="string">Netty 的水位值机制来保证不往网络中写入太多数据（后面会说）。如果网络中的数据（Netty 输出缓冲中的字节数）超过了高水位值，我们会等到其降到低水位值以下才继续写入数据。这保证了网络中不会有太多的数据。如果接收端停止消费网络中的数据（由于接收端缓冲池没有可用 buffer），网络中的缓冲数据就会堆积，那么发送端也会暂停发送。另外，这会使得发送端的缓冲池得不到回收，writer 阻塞在向 LocalBufferPool 请求buffer，阻塞了 writer 往 ResultSubPartition 写数据。这种固定大小缓冲池就像阻塞队列一样，保证了 Flink 有一套健壮的反压机制，使得Task 生产数据的速度不会快于消费的速度。我们上面描述的这个方案可以从两个Task 之间的数据传输自然地扩展到更复杂的 pipeline 中，保证反压机制可以扩散到整个pipeline。</span></span><br></pre></td></tr></tbody></table></figure>


                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">情深骚明</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">http://example.com/2021/07/12/Flink1-12%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">情深骚明</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/flink/">
                                    <span class="chip bg-color">flink</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2021/07/13/flink%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="">
                        
                        <span class="card-title"></span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-07-13
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/flink/" class="post-category">
                                    flink
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/flink/">
                        <span class="chip bg-color">flink</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/11/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%85%83%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="大数据元数据管理">
                        
                        <span class="card-title">大数据元数据管理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-11
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/hive/" class="post-category">
                                    hive
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/hive/">
                        <span class="chip bg-color">hive</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        font-size: 15px;
        color: #42b983;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="436514312"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='false'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">情深骚明</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wmyBigdata-1" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2647716549@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2647716549" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2647716549" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>

    <div class="progress-bar"></div>
          
        <span id="busuanzi_container_site_pv" style='display:none'></span>
            <i class="fa fa-heart-o"></i>
            本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>

    

    
        <span id="busuanzi_container_site_uv" style='display:none'></span>
            人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.

    

    
        <span id="busuanzi_container_site_pv" style='display:none'></span>
        <i class="fa fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
        <span id="busuanzi_value_page_pv" ></span>

    

    <span id="busuanzi_container_site_pv" style='display:none'></span>
    <span id="busuanzi_container_site_uv" style='display:none'></span>
</footer>



    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":0.7}});</script></body>

</html>
