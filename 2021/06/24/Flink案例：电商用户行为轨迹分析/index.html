<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Flink案例：电商用户行为轨迹分析, HTML,CSS,JavaScript,JQuery,java,linux">
    <meta name="description" content="本网址是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的嘘唏旅途中，走出自己的风景。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Flink案例：电商用户行为轨迹分析 | 情深骚明&amp;博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>
    <script src="http://echarts.baidu.com/dist/echarts.common.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">情深骚明&amp;博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">情深骚明&amp;博客</div>
        <div class="logo-desc">
            
            本网址是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的嘘唏旅途中，走出自己的风景。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/16.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Flink案例：电商用户行为轨迹分析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E9%A1%B9%E7%9B%AE/">
                                <span class="chip bg-color">项目</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="post-category">
                                项目
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2021-06-24
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Flink案例：电商用户行为轨迹分析"><a href="#Flink案例：电商用户行为轨迹分析" class="headerlink" title="Flink案例：电商用户行为轨迹分析"></a>Flink案例：电商用户行为轨迹分析</h1><h3 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h3><ul>
<li>flink 1.13.0</li>
<li>kafka-2.11.2.4</li>
<li>三台节点</li>
</ul>
<h2 id="电商用户行为分析"><a href="#电商用户行为分析" class="headerlink" title="电商用户行为分析"></a>电商用户行为分析</h2><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624182335030.png" alt="电商用户行为分析"></p>
<ul>
<li>统计分析<ul>
<li>点击、浏览</li>
<li>热门商品、近期热门商品、分类热门商品，流量统计</li>
</ul>
</li>
<li>偏好统计<ul>
<li>收藏、喜欢、评分、打标签</li>
<li>用户画像，推荐列表（结合特征工程和机器学习算法）</li>
</ul>
</li>
<li>风险控制<ul>
<li>下订单、支付、登录</li>
<li>刷单监控，订单失效监控，恶意登录（短时间内频繁登录失败）监控</li>
</ul>
</li>
</ul>
<h3 id="项目模块设计"><a href="#项目模块设计" class="headerlink" title="项目模块设计"></a>项目模块设计</h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624182432422.png" alt="项目模块设计"></p>
<h3 id="项目指标设计"><a href="#项目指标设计" class="headerlink" title="项目指标设计"></a>项目指标设计</h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624182517978.png" alt="项目指标"></p>
<h3 id="数据源解析"><a href="#数据源解析" class="headerlink" title="数据源解析"></a>数据源解析</h3><ul>
<li><p>用户行为数据</p>
<ul>
<li>UserBehavior.csv — 543462, 1715, 1464116, pv, 1511658000</li>
</ul>
</li>
<li><p> web 服务器日志</p>
</li>
<li><p>apache.log — 66.249.73.135 - - 17/05/2015:10:05:40 +0000 GET /blog/tags/ipv6</p>
</li>
<li><p>数据结构</p>
<ul>
<li>UserBehavior</li>
</ul>
<p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624183404970.png" alt="UserBehavior"></p>
<ul>
<li>ApacheLogEvent</li>
</ul>
<p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624183418020.png" alt="ApacheLogEvent"></p>
</li>
</ul>
<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p><em><strong>idea展示</strong></em></p>
<p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624203320440.png" alt="项目模块展示"></p>
<p><em><strong>项目展板</strong></em></p>
<p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624174610922.png" alt="项目模块"></p>
<h2 id="实时热门商品统计"><a href="#实时热门商品统计" class="headerlink" title="实时热门商品统计"></a>实时热门商品统计</h2><p>数据量的话有48w条，但是在真实的场景中，是往往不够的。。。</p>
<h3 id="基本需求"><a href="#基本需求" class="headerlink" title="基本需求"></a>基本需求</h3><ul>
<li>统计近一小时内的热门商品，每5分钟更新一次</li>
<li>热门度用浏览次数 <font color="red" size="4">PV</font> 来衡量</li>
</ul>
<h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><ul>
<li>在所有用户行为数据中，过滤出浏览  <font color="red" size="4">PV</font>  行为进行统计</li>
<li>构建滑动窗口，窗口长度为1小时，滑动距离为5分钟</li>
</ul>
<h3 id="流程图解析"><a href="#流程图解析" class="headerlink" title="流程图解析"></a>流程图解析</h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624175707944.png" alt="实时热门商品统计"></p>
<h3 id="按照商品Id进行分区"><a href="#按照商品Id进行分区" class="headerlink" title="按照商品Id进行分区"></a><em><strong>按照商品Id进行分区</strong></em></h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624175825190.png" alt="商品ID分区"></p>
<h3 id="设置时间窗口"><a href="#设置时间窗口" class="headerlink" title="设置时间窗口"></a>设置时间窗口</h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624175913548.png" alt="设置时间窗口"></p>
<p>时间窗口（timeWindow）区间为左闭右开</p>
<h3 id="同一份数据会被分发到不同的窗口"><a href="#同一份数据会被分发到不同的窗口" class="headerlink" title="同一份数据会被分发到不同的窗口"></a>同一份数据会被分发到不同的窗口</h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624180026085.png" alt="同一份数据会被分发到不同的窗口"></p>
<h3 id="窗口聚合"><a href="#窗口聚合" class="headerlink" title="窗口聚合"></a>窗口聚合</h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624180056443.png" alt="窗口聚合"></p>
<h3 id="窗口聚合策略——每出现一条记录就加一"><a href="#窗口聚合策略——每出现一条记录就加一" class="headerlink" title="窗口聚合策略——每出现一条记录就加一"></a>窗口聚合策略——每出现一条记录就加一</h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624180138985.png" alt="窗口聚合策略"></p>
<h3 id="实现-AggregateFunction-接口"><a href="#实现-AggregateFunction-接口" class="headerlink" title="实现 AggregateFunction 接口"></a>实现 AggregateFunction 接口</h3><p>— interface AggregateFunction</p>
<h3 id="定义输出结构"><a href="#定义输出结构" class="headerlink" title="定义输出结构"></a>定义输出结构</h3><p>— ItemViewCount(itemId, windowEnd, count)</p>
<h3 id="实现-WindowFunction-接口"><a href="#实现-WindowFunction-接口" class="headerlink" title="实现 WindowFunction 接口"></a>实现 WindowFunction 接口</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">–</span> <span class="string">interface WindowFunction </span></span><br><span class="line"><span class="meta">•</span> <span class="string">IN: 输入为累加器的类型，Long </span></span><br><span class="line"><span class="meta">•</span> <span class="string">OUT: 窗口累加以后输出的类型为 </span></span><br><span class="line">    <span class="meta">​</span>	<span class="string">ItemViewCount(itemId: Long, windowEnd: Long, count: Long), </span></span><br><span class="line">    <span class="meta">​</span>	<span class="string">windowEnd为窗口的 结束时间，也是窗口的唯一标识 </span></span><br><span class="line"><span class="meta">•</span> <span class="string">KEY: Tuple泛型，在这里是 itemId，窗口根据itemId聚合 </span></span><br><span class="line"><span class="meta">•</span> <span class="string">W: 聚合的窗口，w.getEnd 就能拿到窗口的结束时间</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624180531432.png" alt="apply接口"></p>
<h3 id="窗口聚合示例"><a href="#窗口聚合示例" class="headerlink" title="窗口聚合示例"></a>窗口聚合示例</h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624180618771.png" alt="窗口聚合示例"></p>
<h3 id="进行统计整理"><a href="#进行统计整理" class="headerlink" title="进行统计整理"></a>进行统计整理</h3><p>​    — keyBy(“windowEnd”)</p>
<p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624180743844.png" alt="进行统计整理 "></p>
<h3 id="状态编程"><a href="#状态编程" class="headerlink" title="状态编程"></a>状态编程</h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624180844359.png" alt="状态编程"></p>
<h3 id="最终排序输出"><a href="#最终排序输出" class="headerlink" title="最终排序输出"></a>最终排序输出</h3><ul>
<li>keyedProcessFunction</li>
<li>针对有状态流的底层API</li>
<li>KeyedProcessFunction 会对分区后的每一条子流进行处理</li>
<li>以 windowEnd 作为 key，保证分流以后每一条流的数据都在一个时间窗口内</li>
<li>从 ListState 中读取当前流的状态，存储数据进行排序输出</li>
<li>用 ProcessFunction 来定义 KeyedStream 的处理逻辑 </li>
<li>分区之后，每个 KeyedStream 都有其自己的生命周期<ul>
<li>open：初始化，在这里可以获取当前流的状态 </li>
<li>processElement：处理流中每一个元素时调用 </li>
<li>onTimer：定时调用，注册定时器 Timer 并触发之后的回调操作</li>
</ul>
</li>
</ul>
<p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624181113434.png" alt="状态编程"></p>
<p>定时器触发时，相当于收到了大于 windowEnd + 100 的 watermark，可 以认为这时窗口已经收集到了所有数据，从 ListState 中读取进行处理。</p>
<h3 id="测试效果"><a href="#测试效果" class="headerlink" title="测试效果"></a>测试效果</h3><p><em><strong>Kafka数据</strong></em></p>
<p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624211213861.png" alt="Kafka数据"></p>
<p><em><strong>展示结果</strong></em></p>
<p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210624211255578.png" alt="效果展示"></p>
<h3 id="时间退回到一个小时之后的界面"><a href="#时间退回到一个小时之后的界面" class="headerlink" title="时间退回到一个小时之后的界面"></a>时间退回到一个小时之后的界面</h3><p>937166,1715,2355072,pv,1511661600</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:05:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 1715 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 3611281 热门度 = 1</span></span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:10:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 3611281 热门度 = 3</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 1715 热门度 = 2</span></span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:15:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 3611281 热门度 = 3</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 1715 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:20:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 3611281 热门度 = 3</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 1715 热门度 = 2</span></span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:25:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 3611281 热门度 = 3</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 1715 热门度 = 2</span></span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:30:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 3611281 热门度 = 3</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 1715 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:35:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 3611281 热门度 = 3</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 1715 热门度 = 2</span></span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:40:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 3611281 热门度 = 3</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 1715 热门度 = 2</span></span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:45:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 3611281 热门度 = 3</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 1715 热门度 = 2</span></span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:50:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 3611281 热门度 = 3</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 1715 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"><span class="meta">窗口结束时间：2017-11-26</span> <span class="string">09:55:00.0</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">1: 商品ID = 3611281 热门度 = 3</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">2: 商品ID = 1715 热门度 = 2</span></span><br><span class="line"><span class="attr">NO</span> <span class="string">3: 商品ID = 2244074 热门度 = 2</span></span><br><span class="line">===============================</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动顺序"><a href="#启动顺序" class="headerlink" title="启动顺序"></a>启动顺序</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1、热门商品统计</span></span><br><span class="line">	=================== <span class="meta">第一种实现方式</span> =<span class="string">==================</span></span><br><span class="line">	<span class="attr">1、KafkaProducerUtil：</span></span><br><span class="line">		<span class="attr">模拟Kafka生产</span></span><br><span class="line">		</span><br><span class="line">	<span class="attr">2、HotItems：</span></span><br><span class="line">		<span class="attr">分配时间：assignTimestampsAndWatermarks</span></span><br><span class="line">		<span class="attr">增量聚合函数：AggregateFunction</span></span><br><span class="line">		<span class="attr">全窗口函数：WindowFunction</span></span><br><span class="line">		<span class="attr">换成Kafka消费</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">先启动1、在启动2</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">模拟实时的场景一定要启动1，在启动2，才能更好的达到测试效果。。。。</span></span><br></pre></td></tr></tbody></table></figure>



<h2 id="实时流量统计-—-热门页面"><a href="#实时流量统计-—-热门页面" class="headerlink" title="实时流量统计 — 热门页面"></a>实时流量统计 — 热门页面</h2><h3 id="基本需求-1"><a href="#基本需求-1" class="headerlink" title="基本需求"></a>基本需求</h3><ul>
<li>从web服务器的日志中，统计实时的热门访问页面 </li>
<li>统计每分钟的ip访问量，取出访问量最大的5个地址，每5秒更新一次 </li>
</ul>
<h3 id="解决思路-1"><a href="#解决思路-1" class="headerlink" title="解决思路"></a>解决思路</h3><ul>
<li>将 apache 服务器日志中的时间，转换为时间戳，作为 Event Time </li>
<li>构建滑动窗口，窗口长度为1分钟，滑动距离为5秒</li>
</ul>
<h3 id="启动过程和遇见错误"><a href="#启动过程和遇见错误" class="headerlink" title="启动过程和遇见错误"></a>启动过程和遇见错误</h3><h3 id="PV页面统计"><a href="#PV页面统计" class="headerlink" title="PV页面统计"></a>PV页面统计</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">NetworkFlowAnalysis</span> <span class="string">模块2</span></span><br><span class="line">	<span class="meta">热门页面</span> <span class="string">--- 只有一万条数据</span></span><br><span class="line">	<span class="attr">1、ApacheLogEvent</span></span><br><span class="line">	<span class="attr">2、PageViewCount</span></span><br><span class="line">	<span class="attr">3、UserBehavior</span></span><br><span class="line">	<span class="attr">4、HotPages</span></span><br><span class="line">	<span class="attr">5、AggregateFunction</span></span><br><span class="line">	<span class="attr">6、WindowFunction</span></span><br><span class="line">	<span class="meta">7、KeyedProcessFunction</span> <span class="string">---&gt; 状态编程和触发器的使用</span></span><br><span class="line">	<span class="attr">记住关于Flink中的key是String还是Tumble类型的，是看我们返回的类型是什么，所以这个在编程的时候一定要特别注意。</span></span><br><span class="line">	</span><br><span class="line">	<span class="meta">安装了redis，但是在启动的时候，要注意先启动./bin/redis-server</span> <span class="string">然后 在 ./bin/redis-cli -h 192.168.22.140</span></span><br><span class="line"></span><br><span class="line"><span class="attr">问题：</span></span><br><span class="line">	<span class="attr">Redis安装：</span></span><br><span class="line">		<span class="attr">编译安装的时候，需要把src里面的东西拿过来，单独启动server，要不然就会出现客户端连接不上</span></span><br><span class="line">		</span><br><span class="line">	<span class="attr">求PV的时候，分组使用的是map给定一个固定的key</span></span><br><span class="line">	<span class="attr">并行测试：</span></span><br><span class="line">		<span class="attr">KeyBy，分组全部分到一个分区，避免用WindowAll分到同一个分区，这样就没有办法用到并行。。。</span></span><br><span class="line">	<span class="attr">解决办法：</span></span><br><span class="line">		<span class="attr">数据倾斜的问题？？？</span></span><br><span class="line">		<span class="attr">资源利用率较低，如何去解决，如何把key均匀分配到分区上，就会达到负载均衡的作用</span></span><br><span class="line">		<span class="meta">随机生成key，求HashCode</span> <span class="string">% 可能会分配到同一个分区中，一般都比分区数大一点</span></span><br><span class="line">		<span class="attr">如何将每个分区全聚合操作。。。</span></span><br><span class="line">		<span class="attr">如何直接分组，然后sum，这样就是每个元素都得走一遍，效率极差</span></span><br><span class="line">		<span class="attr">应该使用AGG然后全窗口来进行实现。。。</span></span><br><span class="line">		<span class="attr">来一个数据处理一次，得到得URL，当前得分区里面，一个URL就有一个count值</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="针对数据倾斜代码更改进"><a href="#针对数据倾斜代码更改进" class="headerlink" title="针对数据倾斜代码更改进"></a>针对数据倾斜代码更改进</h4><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">//</span>  <span class="string">并行任务改进，设计随机key，解决数据倾斜问题</span></span><br><span class="line"><span class="meta">SingleOutputStreamOperator&lt;PageViewCount&gt;</span> <span class="string">pvStream = dataStream.filter(data -&gt;       "pv".equals(data.getBehavior()))</span></span><br><span class="line"><span class="meta">.map(new</span> <span class="string">MapFunction&lt;UserBehavior, Tuple2&lt;Integer, Long&gt;&gt;() {</span></span><br><span class="line">                    <span class="attr">@Override</span></span><br><span class="line">                    <span class="attr">public</span> <span class="string">Tuple2&lt;Integer, Long&gt; map(UserBehavior value) throws Exception {</span></span><br><span class="line">                        <span class="attr">Random</span> <span class="string">random = new Random();</span></span><br><span class="line">                        <span class="attr">return</span> <span class="string">new Tuple2&lt;&gt;(random.nextInt(10), 1L);</span></span><br><span class="line">                    <span class="attr">}</span></span><br><span class="line">                <span class="attr">})</span></span><br><span class="line"><span class="meta">.keyBy(data</span> <span class="string">-&gt; data.f0)</span></span><br><span class="line"><span class="attr">.timeWindow(Time.hours(1))</span></span><br><span class="line"><span class="meta">.aggregate(new</span> <span class="string">PvCountAgg(), new PvCountResult());</span></span><br><span class="line"></span><br><span class="line"><span class="meta">//</span> <span class="string">将各分区数据汇总起来</span></span><br><span class="line"><span class="meta">DataStream&lt;PageViewCount&gt;</span> <span class="string">pvResultStream = pvStream</span></span><br><span class="line"><span class="meta">.keyBy(PageViewCount</span>:<span class="string">:getWindowEnd)</span></span><br><span class="line"><span class="meta">.process(new</span> <span class="string">TotalPvCount());</span></span><br><span class="line"></span><br><span class="line"><span class="meta">//</span> <span class="string">实现自定义处理函数，把相同窗口分组统计的count值叠加</span></span><br><span class="line"><span class="attr">public</span> <span class="string">static class TotalPvCount extends KeyedProcessFunction&lt;Long, PageViewCount, PageViewCount&gt;{</span></span><br><span class="line">    <span class="meta">//</span> <span class="string">定义状态，保存当前的总count值</span></span><br><span class="line">    <span class="meta">ValueState&lt;Long&gt;</span> <span class="string">totalCountState;</span></span><br><span class="line">    <span class="attr">@Override</span></span><br><span class="line">    <span class="attr">public</span> <span class="string">void open(Configuration parameters) throws Exception {</span></span><br><span class="line">        <span class="attr">totalCountState</span> = <span class="string">getRuntimeContext().getState(new ValueStateDescriptor&lt;Long&gt;("total-count", Long.class, 0L));</span></span><br><span class="line">    <span class="attr">}</span></span><br><span class="line">    <span class="attr">@Override</span></span><br><span class="line">    <span class="attr">public</span> <span class="string">void processElement(PageViewCount value, Context ctx, Collector&lt;PageViewCount&gt; out) throws Exception {</span></span><br><span class="line">        <span class="meta">totalCountState.update(</span> <span class="string">totalCountState.value() + value.getCount() );</span></span><br><span class="line">        <span class="meta">ctx.timerService().registerEventTimeTimer(value.getWindowEnd()</span> <span class="string">+ 1);</span></span><br><span class="line">    <span class="attr">}</span></span><br><span class="line">    <span class="attr">@Override</span></span><br><span class="line">    <span class="attr">public</span> <span class="string">void onTimer(long timestamp, OnTimerContext ctx, Collector&lt;PageViewCount&gt; out) throws Exception {</span></span><br><span class="line">        <span class="meta">//</span> <span class="string">定时器触发，所有分组count值都到齐，直接输出当前的总count数量</span></span><br><span class="line">        <span class="attr">Long</span> <span class="string">totalCount = totalCountState.value();</span></span><br><span class="line">        <span class="meta">out.collect(new</span> <span class="string">PageViewCount("pv", ctx.getCurrentKey(), totalCount));</span></span><br><span class="line">        <span class="meta">//</span> <span class="string">清空状态</span></span><br><span class="line">        <span class="attr">totalCountState.clear();</span></span><br><span class="line">    <span class="attr">}</span></span><br><span class="line"><span class="attr">}</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="UV页面统计"><a href="#UV页面统计" class="headerlink" title="UV页面统计"></a>UV页面统计</h3><h4 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h4><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">timeWindowAll</span> <span class="string">---&gt; AllWindowFunction</span></span><br><span class="line"><span class="attr">去重的话，我们第一种是采用的是全窗口的方式，就是采用的Set数据结构，对内存的压力比较大</span></span><br><span class="line"><span class="attr">如果UserId比较多的话，采用这种方式的就不太好了。。。</span></span><br><span class="line"><span class="attr">但是极端的场景下Redis，Redis可能也存不下</span></span><br><span class="line"><span class="meta">上亿的数据量，UserId</span> <span class="string">几十个字节到几百个字节</span></span><br><span class="line"><span class="attr">100Bit</span> <span class="string">10^8*100 = 10^10Bit </span></span><br><span class="line"><span class="meta">10^3</span> = <span class="string">1K</span></span><br><span class="line"><span class="meta">10^9</span> = <span class="string">1G</span></span><br><span class="line"><span class="meta">10^10</span> = <span class="string">10GB</span></span><br><span class="line"><span class="attr">这样的话太大了，一个窗口一个任务存了10个G，用来专门保存一个状态</span></span><br><span class="line"><span class="attr">如何进行优化：不太适合用存储工具做考虑</span></span><br><span class="line"><span class="meta">🍙采用存储结构</span> <span class="string">---&gt; 布隆过滤器，存储的是很大的位图，位图存放的bit，bitMap</span></span><br><span class="line"><span class="attr">思想：</span></span><br><span class="line"><span class="attr">01状态表示UserId是否存在，一个UserId，对应某一位，1表示存在，bitMap有多少1表示多少UserId存在</span></span><br><span class="line"><span class="meta">压缩的对应，100Bit</span> <span class="string">---&gt; 1Bit</span></span><br><span class="line"><span class="meta">一亿占用空间</span> <span class="string">---&gt; 10^8Bit = 100Mb / 8 ---&gt; 12.5Mb</span></span><br><span class="line"><span class="meta">每个UserId严格对应bitMap的每一位，用一个Hash计算做对应选择，UserId来了之后求HahsCode，对应的offset，一个bitMap对应</span> <span class="string">一个数组</span></span><br><span class="line"><span class="attr">不同UserId，HashCode出现HashCode碰撞，稍微出现一点散列，就会出现</span></span><br><span class="line"><span class="attr">扩充bitMap，处理一亿的数据，相当于全部分散开</span></span><br><span class="line"><span class="attr">原则：HashFunction选取，BitMap的扩充，碰撞概率无限趋向于零</span></span><br><span class="line"><span class="attr">布隆过滤器是一个概率性的算法。</span></span><br><span class="line"><span class="attr">主要问题：hash碰撞</span></span><br><span class="line"><span class="meta">特点重要重要的一点：Google</span> <span class="string">Grave算法，现成的，传入一个所容忍的碰撞概率，默认是0.03。。。</span></span><br><span class="line"><span class="attr">不要做Process，定义一个计算规则，每来个计算触发一个计算，连接Redis，中间判断</span></span><br><span class="line"><span class="attr">以前做一个增量聚合函数也使用过这种思想，但是使用Redis来实现就会有点复杂</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="自定义触发器"><a href="#自定义触发器" class="headerlink" title="自定义触发器"></a>自定义触发器</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义触发器</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTrigger</span> <span class="keyword">extends</span> <span class="title">Trigger</span>&lt;<span class="title">UserBehavior</span>, <span class="title">TimeWindow</span>&gt;</span>{</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> TriggerResult <span class="title">onElement</span><span class="params">(UserBehavior element, <span class="keyword">long</span> timestamp, TimeWindow window, TriggerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="comment">// 每一条数据来到，直接触发窗口计算，并且直接清空窗口</span></span><br><span class="line">            <span class="keyword">return</span> TriggerResult.FIRE_AND_PURGE;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> TriggerResult <span class="title">onProcessingTime</span><span class="params">(<span class="keyword">long</span> time, TimeWindow window, TriggerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="keyword">return</span> TriggerResult.CONTINUE;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> TriggerResult <span class="title">onEventTime</span><span class="params">(<span class="keyword">long</span> time, TimeWindow window, TriggerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="keyword">return</span> TriggerResult.CONTINUE;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">(TimeWindow window, TriggerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<h3 id="扩展算法"><a href="#扩展算法" class="headerlink" title="扩展算法"></a>扩展算法</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">🍙自定义窗口触发器</span></span><br><span class="line"><span class="attr">🍙Flink自带的布隆过滤器</span></span><br><span class="line"><span class="attr">🍙MurmurHash</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="如何计算大小"><a href="#如何计算大小" class="headerlink" title="如何计算大小"></a>如何计算大小</h4><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">如何去计算布隆过滤器的大小：</span></span><br><span class="line">	<span class="attr">一亿数据去重</span></span><br><span class="line">	<span class="attr">2的整数倍大小Mb</span></span><br><span class="line">	<span class="attr">64Mb</span> <span class="string">---&gt; 多少bit</span></span><br><span class="line">	<span class="meta">2^6</span> <span class="string">2^20 2^3 ---&gt; 2^29</span></span><br></pre></td></tr></tbody></table></figure>

<h5 id="在线计算"><a href="#在线计算" class="headerlink" title="在线计算"></a>在线计算</h5><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210625091657154.png" alt="网页在线计算"></p>
<h5 id="计算器计算"><a href="#计算器计算" class="headerlink" title="计算器计算"></a>计算器计算</h5><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210625091550042.png" alt="64MB多少位bit"></p>
<h4 id="自定义全窗口函数"><a href="#自定义全窗口函数" class="headerlink" title="自定义全窗口函数"></a>自定义全窗口函数</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 实现自定义的处理函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UvCountResultWithBloomFliter</span> <span class="keyword">extends</span> <span class="title">ProcessAllWindowFunction</span>&lt;<span class="title">UserBehavior</span>, <span class="title">PageViewCount</span>, <span class="title">TimeWindow</span>&gt;</span>{</span><br><span class="line">    <span class="comment">// 定义jedis连接和布隆过滤器</span></span><br><span class="line">    Jedis jedis;</span><br><span class="line">    MyBloomFilter myBloomFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        jedis = <span class="keyword">new</span> Jedis(<span class="string">"yaxin01"</span>, <span class="number">6379</span>);</span><br><span class="line">        myBloomFilter = <span class="keyword">new</span> MyBloomFilter(<span class="number">1</span>&lt;&lt;<span class="number">29</span>);    <span class="comment">// 要处理1亿个数据，用64MB大小的位图</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Context context, Iterable&lt;UserBehavior&gt; elements, Collector&lt;PageViewCount&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 将位图和窗口count值全部存入redis，用windowEnd作为key</span></span><br><span class="line">        Long windowEnd = context.window().getEnd();</span><br><span class="line">        String bitmapKey = windowEnd.toString();</span><br><span class="line">        <span class="comment">// 把count值存成一张hash表</span></span><br><span class="line">        String countHashName = <span class="string">"uv_count"</span>;</span><br><span class="line">        String countKey = windowEnd.toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 取当前的userId</span></span><br><span class="line">        Long userId = elements.iterator().next().getUserId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 计算位图中的offset</span></span><br><span class="line">        Long offset = myBloomFilter.hashCode(userId.toString(), <span class="number">61</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 用redis的getbit命令，判断对应位置的值</span></span><br><span class="line">        Boolean isExist = jedis.getbit(bitmapKey, offset);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( !isExist ){</span><br><span class="line">            <span class="comment">// 如果不存在，对应位图位置置1</span></span><br><span class="line">            jedis.setbit(bitmapKey, offset, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新redis中保存的count值</span></span><br><span class="line">            Long uvCount = <span class="number">0L</span>;    <span class="comment">// 初始count值</span></span><br><span class="line">            String uvCountString = jedis.hget(countHashName, countKey);</span><br><span class="line">            <span class="keyword">if</span>( uvCountString != <span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(uvCountString) )</span><br><span class="line">                uvCount = Long.valueOf(uvCountString);</span><br><span class="line">            jedis.hset(countHashName, countKey, String.valueOf(uvCount + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">            out.collect(<span class="keyword">new</span> PageViewCount(<span class="string">"uv"</span>, windowEnd, uvCount + <span class="number">1</span>));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        jedis.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动结果查看"><a href="#启动结果查看" class="headerlink" title="启动结果查看"></a>启动结果查看</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">如何去测试这个布隆过滤器：</span></span><br><span class="line">	<span class="attr">启动./bin/redis.server</span></span><br><span class="line">	<span class="meta">redis-cli</span> <span class="string">-h 192.168.22.140</span></span><br><span class="line">	<span class="attr">然后启动RedisDesktop来进行查看</span></span><br><span class="line">	<span class="attr">启动UvWithBloomFilter</span></span><br><span class="line"></span><br><span class="line"><span class="meta">192.168.22.140</span>:<span class="string">6379&gt; </span></span><br><span class="line"><span class="meta">192.168.22.140</span>:<span class="string">6379&gt; keys *</span></span><br><span class="line"><span class="meta">1)</span> <span class="string">"uv_count"</span></span><br><span class="line"><span class="meta">2)</span> <span class="string">"1511661600000"</span></span><br><span class="line"><span class="meta">192.168.22.140</span>:<span class="string">6379&gt; hget uv_count 1511661600000</span></span><br><span class="line"><span class="attr">"17414"</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210625093119562.png" alt="Idea结果展示"></p>
<h3 id="启动和总结要点"><a href="#启动和总结要点" class="headerlink" title="启动和总结要点"></a>启动和总结要点</h3><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">NetworkFlowAnalysis</span> <span class="string">模块2</span></span><br><span class="line">    <span class="attr">首先进行所有页面的统计，然后对PV，UV单独进行分析的处理。。。</span></span><br><span class="line">    <span class="meta">热门页面</span> <span class="string">--- 只有一万条数据</span></span><br><span class="line">    <span class="attr">1、ApacheLogEvent</span></span><br><span class="line">    <span class="attr">2、PageViewCount</span></span><br><span class="line">    <span class="attr">3、UserBehavior</span></span><br><span class="line">    <span class="attr">4、HotPages</span></span><br><span class="line">    <span class="attr">5、AggregateFunction</span></span><br><span class="line">    <span class="attr">6、WindowFunction</span></span><br><span class="line">    <span class="meta">7、KeyedProcessFunction</span> <span class="string">---&gt; 状态编程和触发器的使用</span></span><br><span class="line">    <span class="attr">记住关于Flink中的key是String还是Tumble类型的，是看我们返回的类型是什么，所以这个在编程的时候一定要特别注意。</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">安装了redis，但是在启动的时候，要注意先启动./bin/redis-server</span> <span class="string">然后 在 ./bin/redis-cli -h 192.168.22.140</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pv</span> <span class="string">页面统计：</span></span><br><span class="line">    <span class="attr">做一个状态编程和触发器</span></span><br><span class="line">    <span class="attr">open</span> <span class="string">---&gt; 做一个状态句柄，可以给定一个初始值，考虑刚开始就为null值的情况了</span></span><br><span class="line">    <span class="attr">processElement</span> <span class="string">---&gt; 更新状态值、和注册触发器</span></span><br><span class="line">    <span class="attr">onTimer</span>  <span class="string">---&gt; 定时器触发的时候，所有窗口的数据都是到齐了</span></span><br><span class="line">    <span class="attr">当前的TotalCount就是状态的值</span></span><br><span class="line">    <span class="meta">清空当前的状态</span> <span class="string">totalCounState.clear()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">问题：</span></span><br><span class="line">    <span class="attr">Redis安装：</span></span><br><span class="line">    <span class="attr">编译安装的时候，需要把src里面的东西拿过来，单独启动server，要不然就会出现客户端连接不上</span></span><br><span class="line"></span><br><span class="line"><span class="attr">求PV的时候，分组使用的是map给定一个固定的key</span></span><br><span class="line"><span class="attr">并行测试：</span></span><br><span class="line"><span class="attr">KeyBy，分组全部分到一个分区，避免用WindowAll分到同一个分区，这样就没有办法用到并行。。。</span></span><br><span class="line"><span class="attr">解决办法：</span></span><br><span class="line">    <span class="attr">数据倾斜的问题？？？</span></span><br><span class="line">    <span class="attr">资源利用率较低，如何去解决，如何把key均匀分配到分区上，就会达到负载均衡的作用</span></span><br><span class="line">    <span class="meta">随机生成key，求HashCode</span> <span class="string">% 可能会分配到同一个分区中，一般都比分区数大一点</span></span><br><span class="line">    <span class="attr">如何将每个分区全聚合操作。。。</span></span><br><span class="line">    <span class="attr">如何直接分组，然后sum，这样就是每个元素都得走一遍，效率极差</span></span><br><span class="line">    <span class="attr">应该使用AGG然后全窗口来进行实现。。。</span></span><br><span class="line">    <span class="attr">来一个数据处理一次，得到得URL，当前得分区里面，一个URL就有一个count值</span></span><br><span class="line"></span><br><span class="line"><span class="attr">UV独立访问用户数</span></span><br><span class="line">    <span class="attr">timeWindowAll</span> <span class="string">---&gt; AllWindowFunction</span></span><br><span class="line">    <span class="attr">去重的话，我们第一种是采用的是全窗口的方式，就是采用的Set数据结构，对内存的压力比较大</span></span><br><span class="line">    <span class="attr">如果UserId比较多的话，采用这种方式的就不太好了。。。</span></span><br><span class="line">    <span class="attr">但是极端的场景下Redis，Redis可能也存不下</span></span><br><span class="line">    <span class="meta">上亿的数据量，UserId</span> <span class="string">几十个字节到几百个字节</span></span><br><span class="line">    <span class="attr">100Bit</span> <span class="string">10^8*100 = 10^10Bit </span></span><br><span class="line">    <span class="meta">10^3</span> = <span class="string">1K</span></span><br><span class="line">    <span class="meta">10^9</span> = <span class="string">1G</span></span><br><span class="line">    <span class="meta">10^10</span> = <span class="string">10GB</span></span><br><span class="line"><span class="attr">这样的话太大了，一个窗口一个任务存了10个G，用来专门保存一个状态</span></span><br><span class="line"><span class="attr">如何进行优化：不太适合用存储工具做考虑</span></span><br><span class="line"><span class="meta">🍙采用存储结构</span> <span class="string">---&gt; 布隆过滤器，存储的是很大的位图，位图存放的bit，bitMap</span></span><br><span class="line"><span class="attr">思想：</span></span><br><span class="line"><span class="attr">01状态表示UserId是否存在，一个UserId，对应某一位，1表示存在，bitMap有多少1表示多少UserId存在</span></span><br><span class="line"><span class="meta">压缩的对应，100Bit</span> <span class="string">---&gt; 1Bit</span></span><br><span class="line"><span class="meta">一亿占用空间</span> <span class="string">---&gt; 10^8Bit = 100Mb / 8 ---&gt; 12.5Mb</span></span><br><span class="line"><span class="meta">每个UserId严格对应bitMap的每一位，用一个Hash计算做对应选择，UserId来了之后求HahsCode，对应的offset，一个bitMap对应</span> <span class="string">一个数组</span></span><br><span class="line"><span class="attr">不同UserId，HashCode出现HashCode碰撞，稍微出现一点散列，就会出现</span></span><br><span class="line"><span class="attr">扩充bitMap，处理一亿的数据，相当于全部分散开</span></span><br><span class="line"><span class="attr">原则：HashFunction选取，BitMap的扩充，碰撞概率无限趋向于零</span></span><br><span class="line"><span class="attr">布隆过滤器是一个概率性的算法。</span></span><br><span class="line"><span class="attr">主要问题：hash碰撞</span></span><br><span class="line">    <span class="meta">特点重要重要的一点：Google</span> <span class="string">Grave算法，现成的，传入一个所容忍的碰撞概率，默认是0.03。。。</span></span><br><span class="line">    <span class="attr">不要做Process，定义一个计算规则，每来个计算触发一个计算，连接Redis，中间判断</span></span><br><span class="line">    <span class="attr">以前做一个增量聚合函数也使用过这种思想，但是使用Redis来实现就会有点复杂</span></span><br><span class="line"></span><br><span class="line"><span class="attr">作为扩展：</span></span><br><span class="line">    <span class="attr">🍙自定义窗口触发器</span></span><br><span class="line">    <span class="attr">🍙Flink自带的布隆过滤器</span></span><br><span class="line">    <span class="attr">🍙MurmurHash</span></span><br><span class="line"></span><br><span class="line"><span class="attr">如何去计算布隆过滤器的大小：</span></span><br><span class="line">    <span class="attr">一亿数据去重</span></span><br><span class="line">    <span class="attr">2的整数倍大小Mb</span></span><br><span class="line">    <span class="attr">64Mb</span> <span class="string">---&gt; 多少bit</span></span><br><span class="line">    <span class="meta">2^6</span> <span class="string">2^20 2^3 ---&gt; 2^29</span></span><br><span class="line"></span><br><span class="line"><span class="attr">如何去测试这个布隆过滤器：</span></span><br><span class="line">    <span class="attr">启动./bin/redis.server</span></span><br><span class="line">    <span class="meta">redis-cli</span> <span class="string">-h 192.168.22.140</span></span><br><span class="line">    <span class="attr">然后启动RedisDesktop来进行查看</span></span><br><span class="line">    <span class="meta">启动UvWithBloomFilter</span>	<span class="string"></span></span><br></pre></td></tr></tbody></table></figure>



<h2 id="市场营销分析-APP-市场推广统计"><a href="#市场营销分析-APP-市场推广统计" class="headerlink" title="市场营销分析 - APP 市场推广统计"></a>市场营销分析 - APP 市场推广统计</h2><h3 id="基本需求-2"><a href="#基本需求-2" class="headerlink" title="基本需求"></a>基本需求</h3><ul>
<li>从埋点日志中，统计 APP 市场推广的数据指标</li>
<li>按照不同的推广渠道，分别统计数据</li>
</ul>
<h3 id="解决思路-2"><a href="#解决思路-2" class="headerlink" title="解决思路"></a>解决思路</h3><ul>
<li>通过过滤日志中的用户行为，按照不同的渠道进行统计</li>
<li>可以用 process function 处理，得到自定义的输出数据信息</li>
</ul>
<h3 id="分渠道统计"><a href="#分渠道统计" class="headerlink" title="分渠道统计"></a>分渠道统计</h3><h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wmy.market_analysis.process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wmy.market_analysis.beans.ChannelPromotionCount;</span><br><span class="line"><span class="keyword">import</span> com.wmy.market_analysis.beans.MarketingUserBehavior;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.AggregateFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.TimeCharacteristic;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.AscendingTimestampExtractor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.SourceFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.windowing.ProcessWindowFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.Time;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.TimeWindow;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Timestamp;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ClassName:AppMarketingByChannel</span></span><br><span class="line"><span class="comment"> * Package:com.wmy.market_analysis.process</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:2021/6/25 9:42</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:数仓开发工程师</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span>:2647716549@qq.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 按照不同的渠道做的一个市场的推广的统计</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppMarketingByChannel</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>{</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 从自定义数据源中读取数据</span></span><br><span class="line">        DataStream&lt;MarketingUserBehavior&gt; dataStream = env.addSource( <span class="keyword">new</span> SimulatedMarketingUserBehaviorSource() )</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> AscendingTimestampExtractor&lt;MarketingUserBehavior&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractAscendingTimestamp</span><span class="params">(MarketingUserBehavior element)</span> </span>{</span><br><span class="line">                        <span class="keyword">return</span> element.getTimestamp();</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 分渠道开窗统计</span></span><br><span class="line">        SingleOutputStreamOperator&lt;ChannelPromotionCount&gt; resultStream = dataStream</span><br><span class="line">                .filter(data -&gt; !<span class="string">"UNINSTALL"</span>.equals(data.getBehavior()))</span><br><span class="line">                .keyBy(<span class="string">"channel"</span>, <span class="string">"behavior"</span>)</span><br><span class="line">                .timeWindow(Time.hours(<span class="number">1</span>), Time.seconds(<span class="number">5</span>))    <span class="comment">// 定义滑窗</span></span><br><span class="line">                .aggregate(<span class="keyword">new</span> MarketingCountAgg(), <span class="keyword">new</span> MarketingCountResult());</span><br><span class="line"></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">"app marketing by channel job"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的模拟市场用户行为数据源</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimulatedMarketingUserBehaviorSource</span> <span class="keyword">implements</span> <span class="title">SourceFunction</span>&lt;<span class="title">MarketingUserBehavior</span>&gt;</span>{</span><br><span class="line">        <span class="comment">// 控制是否正常运行的标识位</span></span><br><span class="line">        Boolean running = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义用户行为和渠道的范围</span></span><br><span class="line">        List&lt;String&gt; behaviorList = Arrays.asList(<span class="string">"CLICK"</span>, <span class="string">"DOWNLOAD"</span>, <span class="string">"INSTALL"</span>, <span class="string">"UNINSTALL"</span>);</span><br><span class="line">        List&lt;String&gt; channelList = Arrays.asList(<span class="string">"app store"</span>, <span class="string">"wechat"</span>, <span class="string">"weibo"</span>);</span><br><span class="line"></span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(SourceContext&lt;MarketingUserBehavior&gt; ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="keyword">while</span>(running){</span><br><span class="line">                <span class="comment">// 随机生成所有字段</span></span><br><span class="line">                Long id = random.nextLong();</span><br><span class="line">                String behavior = behaviorList.get( random.nextInt(behaviorList.size()) );</span><br><span class="line">                String channel = channelList.get( random.nextInt(channelList.size()) );</span><br><span class="line">                Long timestamp = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 发出数据</span></span><br><span class="line">                ctx.collect(<span class="keyword">new</span> MarketingUserBehavior(id, behavior, channel, timestamp));</span><br><span class="line"></span><br><span class="line">                Thread.sleep(<span class="number">100L</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>{</span><br><span class="line">            running = <span class="keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的增量聚合函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MarketingCountAgg</span> <span class="keyword">implements</span> <span class="title">AggregateFunction</span>&lt;<span class="title">MarketingUserBehavior</span>, <span class="title">Long</span>, <span class="title">Long</span>&gt;</span>{</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">createAccumulator</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">add</span><span class="params">(MarketingUserBehavior value, Long accumulator)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> accumulator + <span class="number">1</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">getResult</span><span class="params">(Long accumulator)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> accumulator;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">merge</span><span class="params">(Long a, Long b)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> a + b;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的全窗口函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MarketingCountResult</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>&lt;<span class="title">Long</span>, <span class="title">ChannelPromotionCount</span>, <span class="title">Tuple</span>, <span class="title">TimeWindow</span>&gt;</span>{</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Tuple tuple, Context context, Iterable&lt;Long&gt; elements, Collector&lt;ChannelPromotionCount&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            String channel = tuple.getField(<span class="number">0</span>);</span><br><span class="line">            String behavior = tuple.getField(<span class="number">1</span>);</span><br><span class="line">            String windowEnd = <span class="keyword">new</span> Timestamp(context.window().getEnd()).toString();</span><br><span class="line">            Long count = elements.iterator().next();</span><br><span class="line"></span><br><span class="line">            out.collect(<span class="keyword">new</span> ChannelPromotionCount(channel, behavior, windowEnd, count));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h4 id="展示结果"><a href="#展示结果" class="headerlink" title="展示结果"></a>展示结果</h4><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210625102346786.png" alt="展示结果"></p>
<h3 id="全量统计"><a href="#全量统计" class="headerlink" title="全量统计"></a>全量统计</h3><h4 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wmy.market_analysis.process;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wmy.market_analysis.beans.ChannelPromotionCount;</span><br><span class="line"><span class="keyword">import</span> com.wmy.market_analysis.beans.MarketingUserBehavior;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.AggregateFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.MapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.TimeCharacteristic;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.AscendingTimestampExtractor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.windowing.WindowFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.Time;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.TimeWindow;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Timestamp;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ClassName:AppMarketingStatistics</span></span><br><span class="line"><span class="comment"> * Package:com.wmy.market_analysis.process</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:2021/6/25 10:19</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:数仓开发工程师</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span>:2647716549@qq.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 不分市场的全量统计</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppMarketingStatistics</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>{</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 从自定义数据源中读取数据</span></span><br><span class="line">        DataStream&lt;MarketingUserBehavior&gt; dataStream = env.addSource( <span class="keyword">new</span> AppMarketingByChannel.SimulatedMarketingUserBehaviorSource() )</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> AscendingTimestampExtractor&lt;MarketingUserBehavior&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractAscendingTimestamp</span><span class="params">(MarketingUserBehavior element)</span> </span>{</span><br><span class="line">                        <span class="keyword">return</span> element.getTimestamp();</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 开窗统计总量</span></span><br><span class="line">        SingleOutputStreamOperator&lt;ChannelPromotionCount&gt; resultStream = dataStream</span><br><span class="line">                .filter(data -&gt; !<span class="string">"UNINSTALL"</span>.equals(data.getBehavior()))</span><br><span class="line">                .map(<span class="keyword">new</span> MapFunction&lt;MarketingUserBehavior, Tuple2&lt;String, Long&gt;&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Long&gt; <span class="title">map</span><span class="params">(MarketingUserBehavior value)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(<span class="string">"total"</span>, <span class="number">1L</span>);</span><br><span class="line">                    }</span><br><span class="line">                })</span><br><span class="line">                .keyBy(<span class="number">0</span>)</span><br><span class="line">                .timeWindow(Time.hours(<span class="number">1</span>), Time.seconds(<span class="number">5</span>))    <span class="comment">// 定义滑窗</span></span><br><span class="line">                .aggregate( <span class="keyword">new</span> MarketingStatisticsAgg(), <span class="keyword">new</span> MarketingStatisticsResult() );</span><br><span class="line"></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">"app marketing by channel job"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MarketingStatisticsAgg</span> <span class="keyword">implements</span> <span class="title">AggregateFunction</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Long</span>&gt;, <span class="title">Long</span>, <span class="title">Long</span>&gt;</span>{</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">createAccumulator</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">add</span><span class="params">(Tuple2&lt;String, Long&gt; value, Long accumulator)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> accumulator + <span class="number">1</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">getResult</span><span class="params">(Long accumulator)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> accumulator;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">merge</span><span class="params">(Long a, Long b)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> a + b;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MarketingStatisticsResult</span> <span class="keyword">implements</span> <span class="title">WindowFunction</span>&lt;<span class="title">Long</span>, <span class="title">ChannelPromotionCount</span>, <span class="title">Tuple</span>, <span class="title">TimeWindow</span>&gt;</span>{</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(Tuple tuple, TimeWindow window, Iterable&lt;Long&gt; input, Collector&lt;ChannelPromotionCount&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            String windowEnd = <span class="keyword">new</span> Timestamp( window.getEnd() ).toString();</span><br><span class="line">            Long count = input.iterator().next();</span><br><span class="line"></span><br><span class="line">            out.collect(<span class="keyword">new</span> ChannelPromotionCount(<span class="string">"total"</span>, <span class="string">"total"</span>, windowEnd, count));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="展示结果-1"><a href="#展示结果-1" class="headerlink" title="展示结果"></a>展示结果</h4><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210625102242431.png" alt="结果展示"></p>
<h3 id="广告点击-黑名单过滤"><a href="#广告点击-黑名单过滤" class="headerlink" title="广告点击|黑名单过滤"></a>广告点击|黑名单过滤</h3><h4 id="触发器时间设置分析"><a href="#触发器时间设置分析" class="headerlink" title="触发器时间设置分析"></a>触发器时间设置分析</h4><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210625113849784.png" alt="时间设置分析"></p>
<h4 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h4><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">package</span> <span class="string">com.wmy.market_analysis.process;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">import</span> <span class="string">com.wmy.market_analysis.beans.AdClickEvent;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">com.wmy.market_analysis.beans.AdCountViewByProvince;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">com.wmy.market_analysis.beans.BlackListUserWarning;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.api.common.functions.AggregateFunction;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.api.common.state.ValueState;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.api.common.state.ValueStateDescriptor;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.api.java.tuple.Tuple;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.configuration.Configuration;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.streaming.api.TimeCharacteristic;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.streaming.api.datastream.DataStream;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.streaming.api.functions.KeyedProcessFunction;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.streaming.api.functions.timestamps.AscendingTimestampExtractor;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.streaming.api.functions.windowing.WindowFunction;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.streaming.api.windowing.time.Time;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.streaming.api.windowing.windows.TimeWindow;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.util.Collector;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">org.apache.flink.util.OutputTag;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">import</span> <span class="string">java.net.URL;</span></span><br><span class="line"><span class="attr">import</span> <span class="string">java.sql.Timestamp;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">/**</span></span><br><span class="line"> <span class="meta">*</span> <span class="string">ClassName:AdStatisticsByProvince</span></span><br><span class="line"> <span class="meta">*</span> <span class="string">Package:com.wmy.market_analysis.process</span></span><br><span class="line"> <span class="attr">*</span></span><br><span class="line"> <span class="meta">*</span> <span class="string">@date:2021/6/25 10:33</span></span><br><span class="line"> <span class="meta">*</span> <span class="string">@author:数仓开发工程师</span></span><br><span class="line"> <span class="meta">*</span> <span class="string">@email:2647716549@qq.com</span></span><br><span class="line"> <span class="meta">*</span> <span class="string">@Description: 通过省份来分析统计广告投放 --- 测数据 AdClickLog.csv</span></span><br><span class="line"> <span class="attr">*/</span></span><br><span class="line"><span class="attr">public</span> <span class="string">class AdStatisticsByProvince {</span></span><br><span class="line">    <span class="attr">public</span> <span class="string">static void main(String[] args) throws Exception{</span></span><br><span class="line">        <span class="attr">StreamExecutionEnvironment</span> <span class="string">env = StreamExecutionEnvironment.getExecutionEnvironment();</span></span><br><span class="line">        <span class="attr">env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span></span><br><span class="line">        <span class="attr">env.setParallelism(1);</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">//</span> <span class="string">1. 从文件中读取数据</span></span><br><span class="line">        <span class="meta">DataStream&lt;AdClickEvent&gt;</span> <span class="string">adClickEventStream = env.readTextFile("E:\\bigdata\\bigdata-github-code\\UserBehaviorAnalysis\\MarketAnalysis\\src\\main\\resources\\AdClickLog.csv")</span></span><br><span class="line">                <span class="meta">.map(</span> <span class="string">line -&gt; {</span></span><br><span class="line">                    <span class="meta">String[]</span> <span class="string">fields = line.split(",");</span></span><br><span class="line">                    <span class="attr">return</span> <span class="string">new AdClickEvent(new Long(fields[0]), new Long(fields[1]), fields[2], fields[3], new Long(fields[4]));</span></span><br><span class="line">                <span class="meta">}</span> <span class="string">)</span></span><br><span class="line">                <span class="meta">.assignTimestampsAndWatermarks(new</span> <span class="string">AscendingTimestampExtractor&lt;AdClickEvent&gt;() {</span></span><br><span class="line">                    <span class="attr">@Override</span></span><br><span class="line">                    <span class="attr">public</span> <span class="string">long extractAscendingTimestamp(AdClickEvent element) {</span></span><br><span class="line">                        <span class="attr">return</span> <span class="string">element.getTimestamp() * 1000L;</span></span><br><span class="line">                    <span class="attr">}</span></span><br><span class="line">                <span class="attr">});</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">//</span> <span class="string">2. 对同一个用户点击同一个广告的行为进行检测报警</span></span><br><span class="line">        <span class="meta">SingleOutputStreamOperator&lt;AdClickEvent&gt;</span> <span class="string">filterAdClickStream = adClickEventStream</span></span><br><span class="line">                <span class="meta">.keyBy("userId",</span> <span class="string">"adId")    // 基于用户id和广告id做分组</span></span><br><span class="line">                <span class="meta">.process(new</span> <span class="string">FilterBlackListUser(100));</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">//</span> <span class="string">3. 基于省份分组，开窗聚合</span></span><br><span class="line">        <span class="meta">SingleOutputStreamOperator&lt;AdCountViewByProvince&gt;</span> <span class="string">adCountResultStream = filterAdClickStream</span></span><br><span class="line">                <span class="meta">.keyBy(AdClickEvent</span>:<span class="string">:getProvince)</span></span><br><span class="line">                <span class="meta">.timeWindow(Time.hours(1),</span> <span class="string">Time.minutes(5))     // 定义滑窗，5分钟输出一次</span></span><br><span class="line">                <span class="meta">.aggregate(new</span> <span class="string">AdCountAgg(), new AdCountResult());</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">adCountResultStream.print();</span></span><br><span class="line">        <span class="meta">filterAdClickStream.getSideOutput(new</span> <span class="string">OutputTag&lt;BlackListUserWarning&gt;("blacklist"){}).print("blacklist-user");</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">env.execute("ad</span> <span class="string">count by province job");</span></span><br><span class="line">    <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">public</span> <span class="string">static class AdCountAgg implements AggregateFunction&lt;AdClickEvent, Long, Long&gt;{</span></span><br><span class="line">        <span class="attr">@Override</span></span><br><span class="line">        <span class="attr">public</span> <span class="string">Long createAccumulator() {</span></span><br><span class="line">            <span class="attr">return</span> <span class="string">0L;</span></span><br><span class="line">        <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">@Override</span></span><br><span class="line">        <span class="attr">public</span> <span class="string">Long add(AdClickEvent value, Long accumulator) {</span></span><br><span class="line">            <span class="attr">return</span> <span class="string">accumulator + 1;</span></span><br><span class="line">        <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">@Override</span></span><br><span class="line">        <span class="attr">public</span> <span class="string">Long getResult(Long accumulator) {</span></span><br><span class="line">            <span class="attr">return</span> <span class="string">accumulator;</span></span><br><span class="line">        <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">@Override</span></span><br><span class="line">        <span class="attr">public</span> <span class="string">Long merge(Long a, Long b) {</span></span><br><span class="line">            <span class="attr">return</span> <span class="string">a + b;</span></span><br><span class="line">        <span class="attr">}</span></span><br><span class="line">    <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">public</span> <span class="string">static class AdCountResult implements WindowFunction&lt;Long, AdCountViewByProvince, String, TimeWindow&gt;{</span></span><br><span class="line">        <span class="attr">@Override</span></span><br><span class="line">        <span class="attr">public</span> <span class="string">void apply(String province, TimeWindow window, Iterable&lt;Long&gt; input, Collector&lt;AdCountViewByProvince&gt; out) throws Exception {</span></span><br><span class="line">            <span class="attr">String</span> <span class="string">windowEnd = new Timestamp( window.getEnd() ).toString();</span></span><br><span class="line">            <span class="attr">Long</span> <span class="string">count = input.iterator().next();</span></span><br><span class="line">            <span class="meta">out.collect(</span> <span class="string">new AdCountViewByProvince(province, windowEnd, count) );</span></span><br><span class="line">        <span class="attr">}</span></span><br><span class="line">    <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">//</span> <span class="string">实现自定义处理函数</span></span><br><span class="line">    <span class="attr">public</span> <span class="string">static class FilterBlackListUser extends KeyedProcessFunction&lt;Tuple, AdClickEvent, AdClickEvent&gt;{</span></span><br><span class="line">        <span class="meta">//</span> <span class="string">定义属性：点击次数上限</span></span><br><span class="line">        <span class="attr">private</span> <span class="string">Integer countUpperBound;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">public</span> <span class="string">FilterBlackListUser(Integer countUpperBound) {</span></span><br><span class="line">            <span class="meta">this.countUpperBound</span> = <span class="string">countUpperBound;</span></span><br><span class="line">        <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">//</span> <span class="string">定义状态，保存当前用户对某一广告的点击次数</span></span><br><span class="line">        <span class="meta">ValueState&lt;Long&gt;</span> <span class="string">countState;</span></span><br><span class="line">        <span class="meta">//</span> <span class="string">定义一个标志状态，保存当前用户是否已经被发送到了黑名单里</span></span><br><span class="line">        <span class="meta">ValueState&lt;Boolean&gt;</span> <span class="string">isSentState;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">@Override</span></span><br><span class="line">        <span class="attr">public</span> <span class="string">void open(Configuration parameters) throws Exception {</span></span><br><span class="line">            <span class="attr">countState</span> = <span class="string">getRuntimeContext().getState(new ValueStateDescriptor&lt;Long&gt;("ad-count", Long.class, 0L));</span></span><br><span class="line">            <span class="attr">isSentState</span> = <span class="string">getRuntimeContext().getState(new ValueStateDescriptor&lt;Boolean&gt;("is-sent", Boolean.class, false));</span></span><br><span class="line">        <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">@Override</span></span><br><span class="line">        <span class="attr">public</span> <span class="string">void processElement(AdClickEvent value, Context ctx, Collector&lt;AdClickEvent&gt; out) throws Exception {</span></span><br><span class="line">            <span class="meta">//</span> <span class="string">判断当前用户对同一广告的点击次数，如果不够上限，就count加1正常输出；如果达到上限，直接过滤掉，并侧输出流输出黑名单报警</span></span><br><span class="line">            <span class="meta">//</span> <span class="string">首先获取当前的count值</span></span><br><span class="line">            <span class="attr">Long</span> <span class="string">curCount = countState.value();</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">//</span> <span class="string">1. 判断是否是第一个数据，如果是的话，注册一个第二天0点的定时器</span></span><br><span class="line">            <span class="meta">if(</span> <span class="string">curCount == 0 ){</span></span><br><span class="line">                <span class="attr">Long</span> <span class="string">ts = (ctx.timerService().currentProcessingTime() / (24*60*60*1000) + 1) * (24*60*60*1000) - 8*60*60*1000;</span></span><br><span class="line"><span class="meta">//</span>                <span class="string">System.out.println(new Timestamp(ts));</span></span><br><span class="line">                <span class="attr">ctx.timerService().registerProcessingTimeTimer(ts);</span></span><br><span class="line">            <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">//</span> <span class="string">2. 判断是否报警</span></span><br><span class="line">            <span class="meta">if(</span> <span class="string">curCount &gt;= countUpperBound ){</span></span><br><span class="line">                <span class="meta">//</span> <span class="string">判断是否输出到黑名单过，如果没有的话就输出到侧输出流</span></span><br><span class="line">                <span class="meta">if(</span> <span class="string">!isSentState.value() ){</span></span><br><span class="line">                    <span class="meta">isSentState.update(true);</span>    <span class="string">// 更新状态</span></span><br><span class="line">                    <span class="meta">ctx.output(</span> <span class="string">new OutputTag&lt;BlackListUserWarning&gt;("blacklist"){},</span></span><br><span class="line">                            <span class="attr">new</span> <span class="string">BlackListUserWarning(value.getUserId(), value.getAdId(), "click over " + countUpperBound + "times."));</span></span><br><span class="line">                <span class="attr">}</span></span><br><span class="line">                <span class="meta">return;</span>    <span class="string">// 不再执行下面操作</span></span><br><span class="line">            <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">//</span> <span class="string">如果没有返回，点击次数加1，更新状态，正常输出当前数据到主流</span></span><br><span class="line">            <span class="meta">countState.update(curCount</span> <span class="string">+ 1);</span></span><br><span class="line">            <span class="attr">out.collect(value);</span></span><br><span class="line">        <span class="attr">}</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">@Override</span></span><br><span class="line">        <span class="attr">public</span> <span class="string">void onTimer(long timestamp, OnTimerContext ctx, Collector&lt;AdClickEvent&gt; out) throws Exception {</span></span><br><span class="line">            <span class="meta">//</span> <span class="string">清空所有状态</span></span><br><span class="line">            <span class="attr">countState.clear();</span></span><br><span class="line">            <span class="attr">isSentState.clear();</span></span><br><span class="line">        <span class="attr">}</span></span><br><span class="line">    <span class="attr">}</span></span><br><span class="line"><span class="attr">}</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h4 id="展示结果-2"><a href="#展示结果-2" class="headerlink" title="展示结果"></a>展示结果</h4><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210625114049350.png" alt="展示结果"></p>
<p>可以看出是有问题，说明这个过滤是很有效果的</p>
<h2 id="恶意登录监控"><a href="#恶意登录监控" class="headerlink" title="恶意登录监控"></a>恶意登录监控</h2><h3 id="基本需求-3"><a href="#基本需求-3" class="headerlink" title="基本需求"></a>基本需求</h3><ul>
<li>用户在短时间内频繁登录失败，有程序恶意攻击的可能</li>
<li>同一用户（可以是不同IP）在2秒内连续两次登录失败，需要报警</li>
</ul>
<h3 id="解决思路-3"><a href="#解决思路-3" class="headerlink" title="解决思路"></a>解决思路</h3><ul>
<li>将用户的登录失败行为存入 ListState，设定定时器2秒后触发，查看 ListState 中有几次失败登录</li>
<li>更加精确的检测，可以使用 CEP 库实现事件流的模式匹配</li>
</ul>
<h3 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wmy.loginfailDetect.proccess;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wmy.loginfailDetect.beans.LoginEvent;</span><br><span class="line"><span class="keyword">import</span> com.wmy.loginfailDetect.beans.LoginFailWarning;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.ListState;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.ListStateDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.ValueState;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.ValueStateDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.shaded.guava18.com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.TimeCharacteristic;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.KeyedProcessFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.BoundedOutOfOrdernessTimestampExtractor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.Time;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ClassName:LoginFail</span></span><br><span class="line"><span class="comment"> * Package:com.wmy.loginfailDetect.proccess</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:2021/6/25 11:46</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:数仓开发工程师</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span>:2647716549@qq.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 恶意登录事件的处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginFail</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>{</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 从文件中读取数据</span></span><br><span class="line">        URL resource = LoginFail.class.getResource(<span class="string">"/LoginLog.csv"</span>);</span><br><span class="line">        DataStream&lt;LoginEvent&gt; loginEventStream = env.readTextFile(resource.getPath())</span><br><span class="line">                .map(line -&gt; {</span><br><span class="line">                    String[] fields = line.split(<span class="string">","</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> LoginEvent(<span class="keyword">new</span> Long(fields[<span class="number">0</span>]), fields[<span class="number">1</span>], fields[<span class="number">2</span>], <span class="keyword">new</span> Long(fields[<span class="number">3</span>]));</span><br><span class="line">                })</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> BoundedOutOfOrdernessTimestampExtractor&lt;LoginEvent&gt;(Time.seconds(<span class="number">3</span>)) {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(LoginEvent element)</span> </span>{</span><br><span class="line">                        <span class="keyword">return</span> element.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自定义处理函数检测连续登录失败事件</span></span><br><span class="line">        SingleOutputStreamOperator&lt;LoginFailWarning&gt; warningStream = loginEventStream</span><br><span class="line">                .keyBy(LoginEvent::getUserId)</span><br><span class="line">                .process(<span class="keyword">new</span> LoginFailDetectWarning(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        warningStream.print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">"login fail detect job"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义KeyedProcessFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginFailDetectWarning</span> <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>&lt;<span class="title">Long</span>, <span class="title">LoginEvent</span>, <span class="title">LoginFailWarning</span>&gt; </span>{</span><br><span class="line">        <span class="comment">// 定义属性，最大连续登录失败次数</span></span><br><span class="line">        <span class="keyword">private</span> Integer maxFailTimes;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LoginFailDetectWarning</span><span class="params">(Integer maxFailTimes)</span> </span>{</span><br><span class="line">            <span class="keyword">this</span>.maxFailTimes = maxFailTimes;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义状态：保存2秒内所有的登录失败事件</span></span><br><span class="line">        ListState&lt;LoginEvent&gt; loginFailEventListState;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            loginFailEventListState = getRuntimeContext().getListState(<span class="keyword">new</span> ListStateDescriptor&lt;LoginEvent&gt;(<span class="string">"login-fail-list"</span>, LoginEvent.class));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 以登录事件作为判断报警的触发条件，不再注册定时器</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(LoginEvent value, Context ctx, Collector&lt;LoginFailWarning&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="comment">// 判断当前事件登录状态</span></span><br><span class="line">            <span class="keyword">if</span>( <span class="string">"fail"</span>.equals(value.getLoginState()) ){</span><br><span class="line">                <span class="comment">// 1. 如果是登录失败，获取状态中之前的登录失败事件，继续判断是否已有失败事件</span></span><br><span class="line">                Iterator&lt;LoginEvent&gt; iterator = loginFailEventListState.get().iterator();</span><br><span class="line">                <span class="keyword">if</span>( iterator.hasNext() ){</span><br><span class="line">                    <span class="comment">// 1.1 如果已经有登录失败事件，继续判断时间戳是否在2秒之内</span></span><br><span class="line">                    <span class="comment">// 获取已有的登录失败事件</span></span><br><span class="line">                    LoginEvent firstFailEvent = iterator.next();</span><br><span class="line">                    <span class="keyword">if</span>( value.getTimestamp() - firstFailEvent.getTimestamp() &lt;= <span class="number">2</span> ){</span><br><span class="line">                        <span class="comment">// 1.1.1 如果在2秒之内，输出报警</span></span><br><span class="line">                        out.collect( <span class="keyword">new</span> LoginFailWarning(value.getUserId(), firstFailEvent.getTimestamp(), value.getTimestamp(), <span class="string">"login fail 2 times in 2s"</span>) );</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 不管报不报警，这次都已处理完毕，直接更新状态</span></span><br><span class="line">                    loginFailEventListState.clear();</span><br><span class="line">                    loginFailEventListState.add(value);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// 1.2 如果没有登录失败，直接将当前事件存入ListState</span></span><br><span class="line">                    loginFailEventListState.add(value);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 2. 如果是登录成功，直接清空状态</span></span><br><span class="line">                loginFailEventListState.clear();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="展示结果-3"><a href="#展示结果-3" class="headerlink" title="展示结果"></a>展示结果</h3><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210625141906357.png" alt="展示结果"></p>
<h3 id="使用CEP来进行监测"><a href="#使用CEP来进行监测" class="headerlink" title="使用CEP来进行监测"></a>使用CEP来进行监测</h3><h4 id="代码-4"><a href="#代码-4" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wmy.loginfailDetect.proccess;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wmy.loginfailDetect.beans.LoginEvent;</span><br><span class="line"><span class="keyword">import</span> com.wmy.loginfailDetect.beans.LoginFailWarning;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.CEP;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.PatternSelectFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.PatternStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.pattern.Pattern;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.pattern.conditions.SimpleCondition;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.TimeCharacteristic;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.BoundedOutOfOrdernessTimestampExtractor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.Time;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ClassName:LoginFailWithCep</span></span><br><span class="line"><span class="comment"> * Package:com.wmy.loginfailDetect.proccess</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:2021/6/25 14:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:数仓开发工程师</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span>:2647716549@qq.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginFailWithCep</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 从文件中读取数据</span></span><br><span class="line">        URL resource = LoginFailWithCep.class.getResource(<span class="string">"/LoginLog.csv"</span>);</span><br><span class="line">        DataStream&lt;LoginEvent&gt; loginEventStream = env.readTextFile(resource.getPath())</span><br><span class="line">                .map(line -&gt; {</span><br><span class="line">                    String[] fields = line.split(<span class="string">","</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> LoginEvent(<span class="keyword">new</span> Long(fields[<span class="number">0</span>]), fields[<span class="number">1</span>], fields[<span class="number">2</span>], <span class="keyword">new</span> Long(fields[<span class="number">3</span>]));</span><br><span class="line">                })</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> BoundedOutOfOrdernessTimestampExtractor&lt;LoginEvent&gt;(Time.seconds(<span class="number">3</span>)) {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(LoginEvent element)</span> </span>{</span><br><span class="line">                        <span class="keyword">return</span> element.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义一个匹配模式 --- 登录失败的模式</span></span><br><span class="line">        <span class="comment">// firstFail -&gt; SecondFail, within 2 seconds</span></span><br><span class="line">        Pattern&lt;LoginEvent, LoginEvent&gt; loginFailPattern = Pattern</span><br><span class="line">                .&lt;LoginEvent&gt;begin(<span class="string">"firstFail"</span>) <span class="comment">// 只是给定一个名称而已</span></span><br><span class="line">                .where(<span class="keyword">new</span> SimpleCondition&lt;LoginEvent&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(LoginEvent value)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">"fail"</span>.equals(value.getLoginState()); <span class="comment">// 筛选登录状态等于fail，和filter类似</span></span><br><span class="line">                    }</span><br><span class="line">                })</span><br><span class="line">                <span class="comment">// 因为中间，不能有成功的事件</span></span><br><span class="line">                .next(<span class="string">"secondFail"</span>)</span><br><span class="line">                .where(<span class="keyword">new</span> SimpleCondition&lt;LoginEvent&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(LoginEvent value)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">"fail"</span>.equals(value.getLoginState());</span><br><span class="line">                    }</span><br><span class="line">                })</span><br><span class="line">                <span class="comment">// 事件限制，类似于手动开一个窗口</span></span><br><span class="line">                .within(Time.seconds(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将匹配模式应用导数据流上，得到一个pattern stream</span></span><br><span class="line">        <span class="comment">// 不是针对所有的数据进行检测，类似于两条流做连接的操作</span></span><br><span class="line">        PatternStream&lt;LoginEvent&gt; patternStream = CEP.pattern(</span><br><span class="line">                loginEventStream</span><br><span class="line">                        .keyBy(LoginEvent::getUserId),</span><br><span class="line">                loginFailPattern);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检出符合条件的复杂时间，进行转换处理，得到报警信息map CoMap</span></span><br><span class="line">        <span class="comment">// 检测到的是一组事件，select 提取出来的都是LoginEvent，保存到Map数据结构中，key --- firstFail secondFail</span></span><br><span class="line">        <span class="comment">// 每组都有很多个事件，最后返回的是</span></span><br><span class="line">        SingleOutputStreamOperator&lt;LoginFailWarning&gt; warningStream = patternStream</span><br><span class="line">                .select(<span class="keyword">new</span> LoginFailMatchDetectWarning());</span><br><span class="line"></span><br><span class="line">        warningStream.print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">"login fail detect with cep job"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的PatternSelectFunction接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginFailMatchDetectWarning</span> <span class="keyword">implements</span> <span class="title">PatternSelectFunction</span>&lt;<span class="title">LoginEvent</span>,<span class="title">LoginFailWarning</span>&gt; </span>{</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> LoginFailWarning <span class="title">select</span><span class="params">(Map&lt;String, List&lt;LoginEvent&gt;&gt; pattern)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            LoginEvent firstFailEvent = pattern.get(<span class="string">"firstFail"</span>).get(<span class="number">0</span>); <span class="comment">// 就是之前定义的模式匹配的内容，也可以当成一个迭代器的内容</span></span><br><span class="line">            LoginEvent secondFailEvent = pattern.get(<span class="string">"secondFail"</span>).get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LoginFailWarning(firstFailEvent.getUserId(), firstFailEvent.getTimestamp(), secondFailEvent.getTimestamp(), <span class="string">"login fail 2 times"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="展示结果-4"><a href="#展示结果-4" class="headerlink" title="展示结果"></a>展示结果</h4><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210625163056366.png" alt="展示结果"></p>
<h2 id="订单支付监控"><a href="#订单支付监控" class="headerlink" title="订单支付监控"></a>订单支付监控</h2><h3 id="基本需求-4"><a href="#基本需求-4" class="headerlink" title="基本需求"></a>基本需求</h3><ul>
<li>用户下单之后，应设置订单失效时间，以提高用户支付的意愿，并降 低系统风险</li>
<li>用户下单后15分钟未支付，则输出监控信息</li>
</ul>
<h3 id="解决思路-4"><a href="#解决思路-4" class="headerlink" title="解决思路"></a>解决思路</h3><ul>
<li>利用 CEP 库进行事件流的模式匹配，并设定匹配的时间间隔</li>
<li>也可以利用状态编程，用 process function 实现处理逻辑</li>
</ul>
<h3 id="匹配订单支付超时-CEP"><a href="#匹配订单支付超时-CEP" class="headerlink" title="匹配订单支付超时 - CEP"></a>匹配订单支付超时 - CEP</h3><h4 id="代码-5"><a href="#代码-5" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wmy.orderPay.process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wmy.orderPay.beans.OrderEvent;</span><br><span class="line"><span class="keyword">import</span> com.wmy.orderPay.beans.OrderResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.CEP;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.PatternSelectFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.PatternStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.PatternTimeoutFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.pattern.Pattern;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.pattern.conditions.SimpleCondition;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.TimeCharacteristic;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.AscendingTimestampExtractor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.Time;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.OutputTag;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ClassName:OrderPayTimeOut</span></span><br><span class="line"><span class="comment"> * Package:com.wmy.orderPay.process</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:2021/6/25 17:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:数仓开发工程师</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span>:2647716549@qq.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 订单超时事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderPayTimeOut</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 创建环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取数据并转换为POJO类型</span></span><br><span class="line">        URL resource = OrderPayTimeOut.class.getResource(<span class="string">"/OrderLog.csv"</span>);</span><br><span class="line">        DataStream&lt;OrderEvent&gt; orderEventStream = env.readTextFile(resource.getPath())</span><br><span class="line">                .map(line -&gt; {</span><br><span class="line">                    String[] fields = line.split(<span class="string">","</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> OrderEvent(<span class="keyword">new</span> Long(fields[<span class="number">0</span>]), fields[<span class="number">1</span>], fields[<span class="number">2</span>], <span class="keyword">new</span> Long(fields[<span class="number">3</span>]));</span><br><span class="line">                })</span><br><span class="line">                <span class="comment">// 升序的方式</span></span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> AscendingTimestampExtractor&lt;OrderEvent&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractAscendingTimestamp</span><span class="params">(OrderEvent element)</span> </span>{</span><br><span class="line">                        <span class="keyword">return</span> element.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义一个带时间限制的模式</span></span><br><span class="line">        <span class="comment">// 检测的是15分钟之内必须支付，这个是成功之后的结果</span></span><br><span class="line">        Pattern&lt;OrderEvent, OrderEvent&gt; orderPayPattern = Pattern.&lt;OrderEvent&gt;begin(<span class="string">"create"</span>).where(<span class="keyword">new</span> SimpleCondition&lt;OrderEvent&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(OrderEvent value)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"create"</span>.equals(value.getEventType());</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">                <span class="comment">// 宽松近邻：支付相关</span></span><br><span class="line">                .followedBy(<span class="string">"pay"</span>).where(<span class="keyword">new</span> SimpleCondition&lt;OrderEvent&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(OrderEvent value)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">"pay"</span>.equals(value.getEventType());</span><br><span class="line">                    }</span><br><span class="line">                })</span><br><span class="line">                <span class="comment">// 订单在15分钟之内完成</span></span><br><span class="line">                .within(Time.seconds(<span class="number">15</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义侧输出流标签，用来表示超时事件</span></span><br><span class="line">        OutputTag&lt;OrderResult&gt; orderTimeoutTag = <span class="keyword">new</span> OutputTag&lt;OrderResult&gt;(<span class="string">"order-timeout"</span>){}; <span class="comment">// 记住这个一定要{}，否则会报错</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将pattern应用到输入数据流上，得到pattern stream</span></span><br><span class="line">        <span class="comment">// 并没有指定每一订单，首先先分组</span></span><br><span class="line">        PatternStream&lt;OrderEvent&gt; patternStream = CEP.pattern(orderEventStream.keyBy(OrderEvent::getOrderId), orderPayPattern);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用select方法实现对匹配复杂事件和超时复杂事件的提取和处理</span></span><br><span class="line">        SingleOutputStreamOperator&lt;OrderResult&gt; resultStream = patternStream.select(</span><br><span class="line">                orderTimeoutTag,</span><br><span class="line">                <span class="keyword">new</span> OrderTimeoutSelect(),</span><br><span class="line">                <span class="keyword">new</span> OrderPaySelect());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 正常支付的结果流</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 超时的事件流</span></span><br><span class="line">        resultStream.getSideOutput(orderTimeoutTag).print(<span class="string">"timeout"</span>);</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">"order timeout detect job"</span>);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的超时事件处理函数</span></span><br><span class="line">    <span class="comment">// 多了一个处理超时事件的处理</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderTimeoutSelect</span> <span class="keyword">implements</span> <span class="title">PatternTimeoutFunction</span>&lt;<span class="title">OrderEvent</span>,<span class="title">OrderResult</span>&gt; </span>{</span><br><span class="line">        <span class="comment">// 拿到订单的ID就可以，获取一个长整型的订单ID</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> OrderResult <span class="title">timeout</span><span class="params">(Map&lt;String, List&lt;OrderEvent&gt;&gt; pattern, <span class="keyword">long</span> timeoutTimestamp)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            Long timeoutOrderId = pattern.get(<span class="string">"create"</span>).iterator().next().getOrderId(); <span class="comment">// 单列模式</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> OrderResult(timeoutOrderId, <span class="string">"timeout ---&gt; "</span> + timeoutTimestamp);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的正常匹配事件处理函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderPaySelect</span> <span class="keyword">implements</span> <span class="title">PatternSelectFunction</span>&lt;<span class="title">OrderEvent</span>, <span class="title">OrderResult</span>&gt; </span>{</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> OrderResult <span class="title">select</span><span class="params">(Map&lt;String, List&lt;OrderEvent&gt;&gt; pattern)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            Long payedOrderId = pattern.get(<span class="string">"pay"</span>).iterator().next().getOrderId(); <span class="comment">// 单列模式</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> OrderResult(payedOrderId, <span class="string">"payed ---&gt; "</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="展示结果-5"><a href="#展示结果-5" class="headerlink" title="展示结果"></a>展示结果</h4><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210625175816466.png" alt="展示结果"></p>
<h3 id="匹配订单支付超时-ProcessFunction"><a href="#匹配订单支付超时-ProcessFunction" class="headerlink" title="匹配订单支付超时 - ProcessFunction"></a>匹配订单支付超时 - ProcessFunction</h3><h4 id="代码-6"><a href="#代码-6" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wmy.orderPay.process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wmy.orderPay.beans.OrderEvent;</span><br><span class="line"><span class="keyword">import</span> com.wmy.orderPay.beans.OrderResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.ValueState;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.ValueStateDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.TimeCharacteristic;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.AscendingTimestampExtractor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.KeyedProcessFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.OutputTag;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ClassName:OrderTimeOutOnProcess</span></span><br><span class="line"><span class="comment"> * Package:com.wmy.orderPay.process</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:2021/6/25 18:02</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:数仓开发工程师</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span>:2647716549@qq.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 判断订单超时事件，使用ProcessFuncton</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderTimeOutOnProcess</span> </span>{</span><br><span class="line">    <span class="comment">// 定义超时事件的侧输出流标签</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> OutputTag&lt;OrderResult&gt; orderTimeoutTag = <span class="keyword">new</span> OutputTag&lt;OrderResult&gt;(<span class="string">"order-timeout"</span>){};</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取数据并转换成POJO类型</span></span><br><span class="line">        URL resource = OrderTimeOutOnProcess.class.getResource(<span class="string">"/OrderLog.csv"</span>);</span><br><span class="line">        DataStream&lt;OrderEvent&gt; orderEventStream = env.readTextFile(resource.getPath())</span><br><span class="line">                .map(line -&gt; {</span><br><span class="line">                    String[] fields = line.split(<span class="string">","</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> OrderEvent(<span class="keyword">new</span> Long(fields[<span class="number">0</span>]), fields[<span class="number">1</span>], fields[<span class="number">2</span>], <span class="keyword">new</span> Long(fields[<span class="number">3</span>]));</span><br><span class="line">                })</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> AscendingTimestampExtractor&lt;OrderEvent&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractAscendingTimestamp</span><span class="params">(OrderEvent element)</span> </span>{</span><br><span class="line">                        <span class="keyword">return</span> element.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 统一就一步操作，如果到点Pay还没有来的话，状态，定时器，process</span></span><br><span class="line">        <span class="comment">// 自定义处理函数，定义主流输出正常匹配订单事件，侧输出流超时报警事件</span></span><br><span class="line">        SingleOutputStreamOperator&lt;OrderResult&gt; resultStream = orderEventStream</span><br><span class="line">                .keyBy(OrderEvent::getOrderId)</span><br><span class="line">                .process(<span class="keyword">new</span> OrderPayMatchDetect());</span><br><span class="line"></span><br><span class="line">        resultStream.print();</span><br><span class="line">        resultStream.getSideOutput(orderTimeoutTag).print();</span><br><span class="line">        env.execute(<span class="string">"order timeout without cep job"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的KeyedProcessFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderPayMatchDetect</span> <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>&lt;<span class="title">Long</span>, <span class="title">OrderEvent</span>, <span class="title">OrderResult</span>&gt; </span>{</span><br><span class="line">        <span class="comment">// 定义状态，保存之前订单是否已经来过create、pay的事件</span></span><br><span class="line">        ValueState&lt;Boolean&gt; isPayedState;</span><br><span class="line">        ValueState&lt;Boolean&gt; isCreateState;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义状态，保存定时器时间戳</span></span><br><span class="line">        ValueState&lt;Long&gt; timerTsState;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="comment">// 这个名称必须是不一样的</span></span><br><span class="line">            isPayedState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;Boolean&gt;(<span class="string">"is-payed"</span>, Boolean.class, <span class="keyword">false</span>));</span><br><span class="line">            isCreateState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;Boolean&gt;(<span class="string">"is-created"</span>, Boolean.class, <span class="keyword">false</span>));</span><br><span class="line">            timerTsState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;Long&gt;(<span class="string">"timer-ts"</span>, Long.class));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(OrderEvent value, Context ctx, Collector&lt;OrderResult&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="comment">// 先获取当前的状态</span></span><br><span class="line">            Boolean isPayed = isPayedState.value();</span><br><span class="line">            Boolean isCreated = isCreateState.value();</span><br><span class="line">            Long timerTs = timerTsState.value();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断当前事件类型</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"create"</span>.equals(value.getEventType())) {</span><br><span class="line">                <span class="comment">// 如果来的是create，要判断是否支付，乱序</span></span><br><span class="line">                <span class="keyword">if</span> (isPayed) {</span><br><span class="line">                    <span class="comment">// 如果已经正常支付，乱序，肯定离得很近，输出正常匹配结果</span></span><br><span class="line">                    out.collect(<span class="keyword">new</span> OrderResult(value.getOrderId(), <span class="string">"payed successfully 。。。"</span>));</span><br><span class="line">                    <span class="comment">// 清空状态，删除定时器</span></span><br><span class="line">                    isCreateState.clear(); <span class="comment">// 这个应该是没有得</span></span><br><span class="line">                    isPayedState.clear();</span><br><span class="line">                    timerTsState.clear();</span><br><span class="line">                    ctx.timerService().deleteEventTimeTimer(timerTs); <span class="comment">// pay事件来了要不要也要注册一个定时器，无限等下去</span></span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// 如果要是没有支付过，这个是正常得，注册15分钟得定时器，开始等待支付事件</span></span><br><span class="line">                    Long ts = (value.getTimestamp() + <span class="number">15</span> * <span class="number">60</span>) * <span class="number">1000L</span>;</span><br><span class="line">                    ctx.timerService().registerEventTimeTimer(ts);</span><br><span class="line">                    <span class="comment">// 更新状态</span></span><br><span class="line">                    timerTsState.update(ts);</span><br><span class="line">                    isCreateState.update(<span class="keyword">true</span>);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"pay"</span>.equals(value.getEventType())) {</span><br><span class="line">                <span class="comment">// 如果是pay事件，要判断是否 有下单事件来过</span></span><br><span class="line">                <span class="keyword">if</span> (isCreated) {</span><br><span class="line">                    <span class="comment">// 已经有过下单事件，继续判断当前得支付得时间戳，是否超过15分钟</span></span><br><span class="line">                    <span class="keyword">if</span> (value.getTimestamp() * <span class="number">1000L</span> &lt; timerTs) {</span><br><span class="line">                        <span class="comment">// 这个在15分钟内，没有超时，正常匹配</span></span><br><span class="line">                        out.collect(<span class="keyword">new</span> OrderResult(value.getOrderId(), <span class="string">"payed successfully 。。。"</span>));</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="comment">// 已经超时，输出侧输出流报警</span></span><br><span class="line">                        ctx.output(orderTimeoutTag, <span class="keyword">new</span> OrderResult(value.getOrderId(), <span class="string">"payed but already timeout 。。。"</span>));</span><br><span class="line">                    }</span><br><span class="line">                    <span class="comment">// 统一清空状态，删除定时器</span></span><br><span class="line">                    isCreateState.clear();</span><br><span class="line">                    isPayedState.clear();</span><br><span class="line">                    timerTsState.clear();</span><br><span class="line">                    ctx.timerService().deleteEventTimeTimer(timerTs);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// 没有下单事件，肯定是一个乱序，注册一个定时器，等待下单事件得到来</span></span><br><span class="line">                    ctx.timerService().registerEventTimeTimer(value.getTimestamp() * <span class="number">1000L</span>); <span class="comment">// 支付事件到来，肯定是下单事件，直接利用watermark得延迟，当前时间戳，不代表马上要触发</span></span><br><span class="line">                    timerTsState.update(value.getTimestamp() * <span class="number">1000L</span>);</span><br><span class="line">                    isPayedState.update(<span class="keyword">true</span>);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimer</span><span class="params">(<span class="keyword">long</span> timestamp, OnTimerContext ctx, Collector&lt;OrderResult&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="comment">// 定时器触发，说明有一个事件没有来，如果都没有来，不可能有事件</span></span><br><span class="line">            <span class="keyword">if</span> (isPayedState.value()) {</span><br><span class="line">                <span class="comment">// 如果pay来了，说明create没有来，直接做一个报警</span></span><br><span class="line">                ctx.output(orderTimeoutTag, <span class="keyword">new</span> OrderResult(ctx.getCurrentKey(), <span class="string">"payed but not fount create event 。。。"</span>));</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 如果pay没来</span></span><br><span class="line">                ctx.output(orderTimeoutTag, <span class="keyword">new</span> OrderResult(ctx.getCurrentKey(), <span class="string">"timout 。。。"</span>));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清空状态</span></span><br><span class="line">            isCreateState.clear();</span><br><span class="line">            isPayedState.clear();</span><br><span class="line">            timerTsState.clear();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h4 id="展示"><a href="#展示" class="headerlink" title="展示"></a>展示</h4><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210626062444634.png" alt="展示结果"></p>
<h2 id="订单支付实时对账"><a href="#订单支付实时对账" class="headerlink" title="订单支付实时对账"></a>订单支付实时对账</h2><h3 id="基本需求-5"><a href="#基本需求-5" class="headerlink" title="基本需求"></a>基本需求</h3><ul>
<li>用户下单并支付后，应查询到账信息，进行实时对账</li>
<li>如果有不匹配的支付信息或者到账信息，输出提示信息</li>
</ul>
<h3 id="解决思路-5"><a href="#解决思路-5" class="headerlink" title="解决思路"></a>解决思路</h3><ul>
<li>从两条流中分别读取订单支付信息和到账信息，合并处理</li>
<li>用 connect 连接合并两条流，用 coProcessFunction 做匹配处理</li>
</ul>
<h3 id="连接流"><a href="#连接流" class="headerlink" title="连接流"></a>连接流</h3><h4 id="代码-7"><a href="#代码-7" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wmy.orderPay.process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wmy.orderPay.beans.OrderEvent;</span><br><span class="line"><span class="keyword">import</span> com.wmy.orderPay.beans.ReceiptEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.ValueState;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.ValueStateDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.TimeCharacteristic;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.AscendingTimestampExtractor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.co.CoProcessFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.OutputTag;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ClassName:TxPayMatch</span></span><br><span class="line"><span class="comment"> * Package:com.wmy.orderPay.process</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:2021/6/26 6:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:数仓开发工程师</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span>:2647716549@qq.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 两条流对账的问题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxPayMatch</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义侧输出流标签</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> OutputTag&lt;OrderEvent&gt; unmatchedPays = <span class="keyword">new</span> OutputTag&lt;OrderEvent&gt;(<span class="string">"unmatched-pays"</span>){};</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> OutputTag&lt;ReceiptEvent&gt; unmatchedReceipts = <span class="keyword">new</span> OutputTag&lt;ReceiptEvent&gt;(<span class="string">"unmatched-receipts"</span>){};</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取数据并转换成POJO类型</span></span><br><span class="line">        <span class="comment">// 读取订单支付事件数据</span></span><br><span class="line">        URL orderResource = TxPayMatch.class.getResource(<span class="string">"/OrderLog.csv"</span>);</span><br><span class="line">        DataStream&lt;OrderEvent&gt; orderEventStream = env.readTextFile(orderResource.getPath())</span><br><span class="line">                .map( line -&gt; {</span><br><span class="line">                    String[] fields = line.split(<span class="string">","</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> OrderEvent(<span class="keyword">new</span> Long(fields[<span class="number">0</span>]), fields[<span class="number">1</span>], fields[<span class="number">2</span>], <span class="keyword">new</span> Long(fields[<span class="number">3</span>]));</span><br><span class="line">                } )</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> AscendingTimestampExtractor&lt;OrderEvent&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractAscendingTimestamp</span><span class="params">(OrderEvent element)</span> </span>{</span><br><span class="line">                        <span class="keyword">return</span> element.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    }</span><br><span class="line">                })</span><br><span class="line">                .filter( data -&gt; !<span class="string">""</span>.equals(data.getTxId()) );    <span class="comment">// 交易id不为空，必须是pay事件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取到账事件数据</span></span><br><span class="line">        URL receiptResource = TxPayMatch.class.getResource(<span class="string">"/ReceiptLog.csv"</span>);</span><br><span class="line">        SingleOutputStreamOperator&lt;ReceiptEvent&gt; receiptEventStream = env.readTextFile(<span class="string">"E:\\bigdata\\bigdata-github-code\\UserBehaviorAnalysis\\OrderPayDetect\\src\\main\\resources\\ReceiptLog.csv"</span>)</span><br><span class="line">                .map(line -&gt; {</span><br><span class="line">                    String[] fields = line.split(<span class="string">","</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ReceiptEvent(fields[<span class="number">0</span>], fields[<span class="number">1</span>], <span class="keyword">new</span> Long(fields[<span class="number">2</span>]));</span><br><span class="line">                })</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> AscendingTimestampExtractor&lt;ReceiptEvent&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractAscendingTimestamp</span><span class="params">(ReceiptEvent element)</span> </span>{</span><br><span class="line">                        <span class="keyword">return</span> element.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将两条流进行连接合并，进行匹配处理，不匹配的事件输出到侧输出流</span></span><br><span class="line">        SingleOutputStreamOperator&lt;Tuple2&lt;OrderEvent, ReceiptEvent&gt;&gt; resultStream = orderEventStream.keyBy(OrderEvent::getTxId)</span><br><span class="line">                .connect(receiptEventStream.keyBy(ReceiptEvent::getTxId))</span><br><span class="line">                .process(<span class="keyword">new</span> TxPayMatchDetect());</span><br><span class="line"></span><br><span class="line">        resultStream.print(<span class="string">"matched-pays"</span>);</span><br><span class="line">        resultStream.getSideOutput(unmatchedPays).print(<span class="string">"unmatched-pays"</span>);</span><br><span class="line">        resultStream.getSideOutput(unmatchedReceipts).print(<span class="string">"unmatched-receipts"</span>);</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">"tx match detect job"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 实现自定义CoProcessFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TxPayMatchDetect</span> <span class="keyword">extends</span> <span class="title">CoProcessFunction</span>&lt;<span class="title">OrderEvent</span>, <span class="title">ReceiptEvent</span>, <span class="title">Tuple2</span>&lt;<span class="title">OrderEvent</span>, <span class="title">ReceiptEvent</span>&gt;&gt; </span>{</span><br><span class="line">        <span class="comment">// 定义状态，保存当前已经到来的订单支付事件和到账时间</span></span><br><span class="line">        ValueState&lt;OrderEvent&gt; payState;</span><br><span class="line">        ValueState&lt;ReceiptEvent&gt; receiptState;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            payState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;OrderEvent&gt;(<span class="string">"pay"</span>, OrderEvent.class));</span><br><span class="line">            receiptState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;ReceiptEvent&gt;(<span class="string">"receipt"</span>, ReceiptEvent.class));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement1</span><span class="params">(OrderEvent pay, Context ctx, Collector&lt;Tuple2&lt;OrderEvent, ReceiptEvent&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="comment">// 订单支付事件来了，判断是否已经有对应的到账事件</span></span><br><span class="line">            ReceiptEvent receipt = receiptState.value();</span><br><span class="line">            <span class="keyword">if</span>( receipt != <span class="keyword">null</span> ){</span><br><span class="line">                <span class="comment">// 如果receipt不为空，说明到账事件已经来过，输出匹配事件，清空状态</span></span><br><span class="line">                out.collect( <span class="keyword">new</span> Tuple2&lt;&gt;(pay, receipt) );</span><br><span class="line">                payState.clear();</span><br><span class="line">                receiptState.clear();</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 如果receipt没来，注册一个定时器，开始等待</span></span><br><span class="line">                ctx.timerService().registerEventTimeTimer( (pay.getTimestamp() + <span class="number">5</span>) * <span class="number">1000L</span> );    <span class="comment">// 等待5秒钟，具体要看数据</span></span><br><span class="line">                <span class="comment">// 更新状态</span></span><br><span class="line">                payState.update(pay);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement2</span><span class="params">(ReceiptEvent receipt, Context ctx, Collector&lt;Tuple2&lt;OrderEvent, ReceiptEvent&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="comment">// 到账事件来了，判断是否已经有对应的支付事件</span></span><br><span class="line">            OrderEvent pay = payState.value();</span><br><span class="line">            <span class="keyword">if</span>( pay != <span class="keyword">null</span> ){</span><br><span class="line">                <span class="comment">// 如果pay不为空，说明支付事件已经来过，输出匹配事件，清空状态</span></span><br><span class="line">                out.collect( <span class="keyword">new</span> Tuple2&lt;&gt;(pay, receipt) );</span><br><span class="line">                payState.clear();</span><br><span class="line">                receiptState.clear();</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 如果pay没来，注册一个定时器，开始等待</span></span><br><span class="line">                ctx.timerService().registerEventTimeTimer( (receipt.getTimestamp() + <span class="number">3</span>) * <span class="number">1000L</span> );    <span class="comment">// 等待3秒钟，具体要看数据</span></span><br><span class="line">                <span class="comment">// 更新状态</span></span><br><span class="line">                receiptState.update(receipt);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimer</span><span class="params">(<span class="keyword">long</span> timestamp, OnTimerContext ctx, Collector&lt;Tuple2&lt;OrderEvent, ReceiptEvent&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="comment">// 定时器触发，有可能是有一个事件没来，不匹配，也有可能是都来过了，已经输出并清空状态</span></span><br><span class="line">            <span class="comment">// 判断哪个不为空，那么另一个就没来</span></span><br><span class="line">            <span class="keyword">if</span>( payState.value() != <span class="keyword">null</span> ){</span><br><span class="line">                ctx.output(unmatchedPays, payState.value());</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span>( receiptState.value() != <span class="keyword">null</span> ){</span><br><span class="line">                ctx.output(unmatchedReceipts, receiptState.value());</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 清空状态</span></span><br><span class="line">            payState.clear();</span><br><span class="line">            receiptState.clear();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="展示结果-6"><a href="#展示结果-6" class="headerlink" title="展示结果"></a>展示结果</h4><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210626063614034.png" alt="展示结果"></p>
<h3 id="join流"><a href="#join流" class="headerlink" title="join流"></a>join流</h3><h4 id="代码-8"><a href="#代码-8" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wmy.orderPay.process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wmy.orderPay.beans.OrderEvent;</span><br><span class="line"><span class="keyword">import</span> com.wmy.orderPay.beans.ReceiptEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.TimeCharacteristic;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.co.ProcessJoinFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.AscendingTimestampExtractor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.Time;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ClassName:TxPayMatchByJoin</span></span><br><span class="line"><span class="comment"> * Package:com.wmy.orderPay.process</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:2021/6/26 6:36</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:数仓开发工程师</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span>:2647716549@qq.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 两条流的join</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxPayMatchByJoin</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取数据并转换成POJO类型</span></span><br><span class="line">        <span class="comment">// 读取订单支付事件数据</span></span><br><span class="line">        URL orderResource = TxPayMatchByJoin.class.getResource(<span class="string">"/OrderLog.csv"</span>);</span><br><span class="line">        DataStream&lt;OrderEvent&gt; orderEventStream = env.readTextFile(orderResource.getPath())</span><br><span class="line">                .map(line -&gt; {</span><br><span class="line">                    String[] fields = line.split(<span class="string">","</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> OrderEvent(<span class="keyword">new</span> Long(fields[<span class="number">0</span>]), fields[<span class="number">1</span>], fields[<span class="number">2</span>], <span class="keyword">new</span> Long(fields[<span class="number">3</span>]));</span><br><span class="line">                })</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> AscendingTimestampExtractor&lt;OrderEvent&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractAscendingTimestamp</span><span class="params">(OrderEvent element)</span> </span>{</span><br><span class="line">                        <span class="keyword">return</span> element.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    }</span><br><span class="line">                })</span><br><span class="line">                .filter(data -&gt; !<span class="string">""</span>.equals(data.getTxId()));    <span class="comment">// 交易id不为空，必须是pay事件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取到账事件数据</span></span><br><span class="line">        <span class="comment">//URL receiptResource = TxPayMatchByJoin.class.getResource("/ReceiptLog.csv");</span></span><br><span class="line">        SingleOutputStreamOperator&lt;ReceiptEvent&gt; receiptEventStream = env.readTextFile(<span class="string">"E:\\bigdata\\bigdata-github-code\\UserBehaviorAnalysis\\OrderPayDetect\\src\\main\\resources\\ReceiptLog.csv"</span>)</span><br><span class="line">                .map(line -&gt; {</span><br><span class="line">                    String[] fields = line.split(<span class="string">","</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ReceiptEvent(fields[<span class="number">0</span>], fields[<span class="number">1</span>], <span class="keyword">new</span> Long(fields[<span class="number">2</span>]));</span><br><span class="line">                })</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> AscendingTimestampExtractor&lt;ReceiptEvent&gt;() {</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractAscendingTimestamp</span><span class="params">(ReceiptEvent element)</span> </span>{</span><br><span class="line">                        <span class="keyword">return</span> element.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 区间连接两条流，得到匹配的数据</span></span><br><span class="line">        SingleOutputStreamOperator&lt;Tuple2&lt;OrderEvent, ReceiptEvent&gt;&gt; resultStream = orderEventStream</span><br><span class="line">                .keyBy(OrderEvent::getTxId)</span><br><span class="line">                .intervalJoin(receiptEventStream.keyBy(ReceiptEvent::getTxId))</span><br><span class="line">                .between(Time.seconds(-<span class="number">3</span>), Time.seconds(<span class="number">5</span>))    <span class="comment">// -3，5 区间范围</span></span><br><span class="line">                .process(<span class="keyword">new</span> TxPayMatchDetectByJoin());</span><br><span class="line"></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">"tx pay match by join job"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义ProcessJoinFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TxPayMatchDetectByJoin</span> <span class="keyword">extends</span> <span class="title">ProcessJoinFunction</span>&lt;<span class="title">OrderEvent</span>, <span class="title">ReceiptEvent</span>, <span class="title">Tuple2</span>&lt;<span class="title">OrderEvent</span>, <span class="title">ReceiptEvent</span>&gt;&gt;</span>{</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(OrderEvent left, ReceiptEvent right, Context ctx, Collector&lt;Tuple2&lt;OrderEvent, ReceiptEvent&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(left, right));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="展示结果-7"><a href="#展示结果-7" class="headerlink" title="展示结果"></a>展示结果</h4><p><img src="/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/image-20210626063948647.png" alt="结果展示"></p>
<h2 id="CEP的介绍"><a href="#CEP的介绍" class="headerlink" title="CEP的介绍"></a>CEP的介绍</h2><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CEP</span> <span class="string">复杂事件</span></span><br><span class="line">	<span class="attr">一个或多个由简单构成的事件流通过规则匹配</span></span><br><span class="line">	<span class="attr">Pattern</span> <span class="string">API：</span></span><br><span class="line">		<span class="meta">模式</span> <span class="string">Pattern</span></span><br><span class="line">		<span class="attr">inputStream</span></span><br><span class="line">		<span class="attr">begin</span> <span class="string">next subtype where followBy 没有说必须是严格紧邻</span></span><br><span class="line">	<span class="meta">个体模式</span> <span class="string">组合模式 模式组</span></span><br><span class="line">	<span class="attr">组合模式由限制：必须是pattern.begin</span></span><br><span class="line">	<span class="attr">模式组，模式序列作为条件嵌套在个体模式里面，成为一组模式，整个很复杂，一般是用不到的</span></span><br><span class="line">	<span class="meta">个体模式：singleton</span> <span class="string">looping</span></span><br><span class="line">	<span class="attr">单列模式：当前的模式匹配的就是一个事件，可以检测到多个事件</span></span><br><span class="line">	<span class="attr">循环模式是可以接收多个事件。</span></span><br><span class="line">	<span class="meta">start.times(3).where(new</span> <span class="string">SimpleCondition&lt;Event&gt;)</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">量词：</span></span><br><span class="line">		<span class="meta">times(4)</span> <span class="string">当前模式匹配四次</span></span><br><span class="line">		<span class="meta">times(4).optional</span> <span class="string">可选，匹配出现零次或者四次</span></span><br><span class="line">		<span class="meta">start.times(2,4)</span> <span class="string">匹配2，4次</span></span><br><span class="line">		<span class="meta">start.times(2,4).gredy</span> <span class="string">贪婪模式，尽可能多的匹配</span></span><br><span class="line">		<span class="meta">start.oneOrMore.optional.gredy</span> <span class="string">并且尽可能多的匹配操作：0,2,*</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">CEP底层是NFA是一个状态机的概念或者是架构</span></span><br><span class="line">	</span><br><span class="line">	<span class="meta">简单的提取操作，好多过条件应该怎么办勒，&amp;</span> <span class="string">| ^ 在里面写的可读性比较差</span></span><br><span class="line">	<span class="meta">使用or</span> <span class="string">来 进行可读性的提高的，如果是and ---&gt; where.where</span></span><br><span class="line">	<span class="attr">终止条件</span></span><br><span class="line">		<span class="meta">.until()</span> <span class="string">oneOrMore 可以有多个，检测到一个匹配一个条件的，整个事件是没有完的，符合</span></span><br><span class="line">		<span class="attr">前面的条件就保存到Map事件中，</span></span><br><span class="line">		</span><br><span class="line">	<span class="attr">迭代条件IterCondition</span></span><br><span class="line">	<span class="attr">严格近邻</span></span><br><span class="line">	<span class="attr">宽松近邻</span></span><br><span class="line">	<span class="attr">非确定性宽松近邻</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="启动流程和问题总结"><a href="#启动流程和问题总结" class="headerlink" title="启动流程和问题总结"></a>启动流程和问题总结</h2><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hotItemsAnalysis</span> <span class="string">模块1</span></span><br><span class="line">	<span class="attr">数据量的话有48w条，但是在真实的场景中，是往往不够的。。。</span></span><br><span class="line">	<span class="attr">1、热门商品统计</span></span><br><span class="line">		=================== <span class="meta">第一种实现方式</span> =<span class="string">==================</span></span><br><span class="line">		<span class="attr">1、KafkaProducerUtil：</span></span><br><span class="line">			<span class="attr">模拟Kafka生产</span></span><br><span class="line">			</span><br><span class="line">		<span class="attr">2、HotItems：</span></span><br><span class="line">			<span class="attr">分配时间：assignTimestampsAndWatermarks</span></span><br><span class="line">			<span class="attr">增量聚合函数：AggregateFunction</span></span><br><span class="line">			<span class="attr">全窗口函数：WindowFunction</span></span><br><span class="line">			<span class="attr">状态管理：KeyedProcessFunction</span></span><br><span class="line">			<span class="attr">实现自定义输出</span></span><br><span class="line">			<span class="attr">换成Kafka消费</span></span><br><span class="line"></span><br><span class="line">		<span class="attr">先启动1、在启动2</span></span><br><span class="line">		</span><br><span class="line">		<span class="attr">模拟实时的场景一定要启动1，在启动2，才能更好的达到测试效果。。。。</span></span><br><span class="line">		=================== <span class="meta">第二种实现方式</span> =<span class="string">==================</span></span><br><span class="line">		<span class="attr">这个是采用读取文本的方式来进行测试的。。。</span></span><br><span class="line">		<span class="attr">也是可以采取Kafka的方式来进行数据流的获取。。。</span></span><br><span class="line">		</span><br><span class="line">		<span class="attr">Flink</span> <span class="string">SQL实现热门商品统计5分钟内统计最近一个小时的商品这样的话简单很多</span></span><br><span class="line">		<span class="attr">原因是我们不用写聚合函数</span></span><br><span class="line">		<span class="attr">但是我们在实现格式化输出的时候就不那么容易了。。。</span></span><br><span class="line">		<span class="meta">利用开窗函数，对count值进行排序并获取Row</span> <span class="string">number，得到Top N</span></span><br><span class="line">		<span class="attr">必须得使用SQL来进行实现了。</span></span><br><span class="line">		</span><br><span class="line">		<span class="attr">Table</span> <span class="string">API这样实现的话就有点局限了，所以我们使用SQL方式来进行实现</span></span><br><span class="line">		</span><br><span class="line">		<span class="attr">Table</span> <span class="string">API 和 SQL 来回转换的方式来对我们的需求进行不断的去开发和优化。。。</span></span><br><span class="line">		</span><br><span class="line">		<span class="attr">1、row_number</span></span><br><span class="line">		<span class="meta">2、order</span> <span class="string">by 全局排序</span></span><br><span class="line">		</span><br><span class="line">		<span class="attr">where</span> <span class="string">提前过滤，我们是排序之后 得到的结果，所以我们得做一个子查询。。。</span></span><br><span class="line">		<span class="attr">这样的格式就不是很好看，没有做格式化输出。。。</span></span><br><span class="line">		</span><br><span class="line">		<span class="attr">3、toRetractStream</span></span><br><span class="line">		<span class="attr">做聚合的时候，数据是会发生变化的额，窗口是会发生变化的，现在只有开窗函数了所以得进行定向</span></span><br><span class="line">		</span><br><span class="line">		<span class="meta">(false,-U[138964,</span> <span class="string">11, 2017-11-26T02:15, 5]) 更新之前</span></span><br><span class="line">		<span class="meta">(true,+U[3034696,</span> <span class="string">11, 2017-11-26T02:15, 5]) 更新之后</span></span><br><span class="line">		</span><br><span class="line">		<span class="attr">这个数据收集是非常麻烦得，可以写入MySQL里面，TopN来进行查看</span></span><br><span class="line">		</span><br><span class="line">		<span class="attr">4、能不能使用纯SQL的方式来实现这个需求勒。</span></span><br><span class="line">		<span class="attr">当然是可以的。。。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">NetworkFlowAnalysis</span> <span class="string">模块2</span></span><br><span class="line">	<span class="attr">首先进行所有页面的统计，然后对PV，UV单独进行分析的处理。。。</span></span><br><span class="line">	<span class="meta">热门页面</span> <span class="string">--- 只有一万条数据</span></span><br><span class="line">	<span class="attr">1、ApacheLogEvent</span></span><br><span class="line">	<span class="attr">2、PageViewCount</span></span><br><span class="line">	<span class="attr">3、UserBehavior</span></span><br><span class="line">	<span class="attr">4、HotPages</span></span><br><span class="line">	<span class="attr">5、AggregateFunction</span></span><br><span class="line">	<span class="attr">6、WindowFunction</span></span><br><span class="line">	<span class="meta">7、KeyedProcessFunction</span> <span class="string">---&gt; 状态编程和触发器的使用</span></span><br><span class="line">	<span class="attr">记住关于Flink中的key是String还是Tumble类型的，是看我们返回的类型是什么，所以这个在编程的时候一定要特别注意。</span></span><br><span class="line">	</span><br><span class="line">	<span class="meta">安装了redis，但是在启动的时候，要注意先启动./bin/redis-server</span> <span class="string">然后 在 ./bin/redis-cli -h 192.168.22.140</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">pv</span> <span class="string">页面统计：</span></span><br><span class="line">	<span class="attr">做一个状态编程和触发器</span></span><br><span class="line">	<span class="attr">open</span> <span class="string">---&gt; 做一个状态句柄，可以给定一个初始值，考虑刚开始就为null值的情况了</span></span><br><span class="line">	<span class="attr">processElement</span> <span class="string">---&gt; 更新状态值、和注册触发器</span></span><br><span class="line">	<span class="attr">onTimer</span>  <span class="string">---&gt; 定时器触发的时候，所有窗口的数据都是到齐了</span></span><br><span class="line">	<span class="attr">当前的TotalCount就是状态的值</span></span><br><span class="line">	<span class="meta">清空当前的状态</span> <span class="string">totalCounState.clear()</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="attr">问题：</span></span><br><span class="line">		<span class="attr">Redis安装：</span></span><br><span class="line">			<span class="attr">编译安装的时候，需要把src里面的东西拿过来，单独启动server，要不然就会出现客户端连接不上</span></span><br><span class="line">			</span><br><span class="line">		<span class="attr">求PV的时候，分组使用的是map给定一个固定的key</span></span><br><span class="line">		<span class="attr">并行测试：</span></span><br><span class="line">			<span class="attr">KeyBy，分组全部分到一个分区，避免用WindowAll分到同一个分区，这样就没有办法用到并行。。。</span></span><br><span class="line">		<span class="attr">解决办法：</span></span><br><span class="line">			<span class="attr">数据倾斜的问题？？？</span></span><br><span class="line">			<span class="attr">资源利用率较低，如何去解决，如何把key均匀分配到分区上，就会达到负载均衡的作用</span></span><br><span class="line">			<span class="meta">随机生成key，求HashCode</span> <span class="string">% 可能会分配到同一个分区中，一般都比分区数大一点</span></span><br><span class="line">			<span class="attr">如何将每个分区全聚合操作。。。</span></span><br><span class="line">			<span class="attr">如何直接分组，然后sum，这样就是每个元素都得走一遍，效率极差</span></span><br><span class="line">			<span class="attr">应该使用AGG然后全窗口来进行实现。。。</span></span><br><span class="line">			<span class="attr">来一个数据处理一次，得到得URL，当前得分区里面，一个URL就有一个count值</span></span><br><span class="line">			</span><br><span class="line">	<span class="attr">UV独立访问用户数</span></span><br><span class="line">		<span class="attr">timeWindowAll</span> <span class="string">---&gt; AllWindowFunction</span></span><br><span class="line">		<span class="attr">去重的话，我们第一种是采用的是全窗口的方式，就是采用的Set数据结构，对内存的压力比较大</span></span><br><span class="line">		<span class="attr">如果UserId比较多的话，采用这种方式的就不太好了。。。</span></span><br><span class="line">		<span class="attr">但是极端的场景下Redis，Redis可能也存不下</span></span><br><span class="line">		<span class="meta">上亿的数据量，UserId</span> <span class="string">几十个字节到几百个字节</span></span><br><span class="line">		<span class="attr">100Bit</span> <span class="string">10^8*100 = 10^10Bit </span></span><br><span class="line">		<span class="meta">10^3</span> = <span class="string">1K</span></span><br><span class="line">		<span class="meta">10^9</span> = <span class="string">1G</span></span><br><span class="line">		<span class="meta">10^10</span> = <span class="string">10GB</span></span><br><span class="line">		<span class="attr">这样的话太大了，一个窗口一个任务存了10个G，用来专门保存一个状态</span></span><br><span class="line">		<span class="attr">如何进行优化：不太适合用存储工具做考虑</span></span><br><span class="line">		<span class="meta">🍙采用存储结构</span> <span class="string">---&gt; 布隆过滤器，存储的是很大的位图，位图存放的bit，bitMap</span></span><br><span class="line">		<span class="attr">思想：</span></span><br><span class="line">			<span class="attr">01状态表示UserId是否存在，一个UserId，对应某一位，1表示存在，bitMap有多少1表示多少UserId存在</span></span><br><span class="line">			<span class="meta">压缩的对应，100Bit</span> <span class="string">---&gt; 1Bit</span></span><br><span class="line">			<span class="meta">一亿占用空间</span> <span class="string">---&gt; 10^8Bit = 100Mb / 8 ---&gt; 12.5Mb</span></span><br><span class="line">			<span class="meta">每个UserId严格对应bitMap的每一位，用一个Hash计算做对应选择，UserId来了之后求HahsCode，对应的offset，一个bitMap对应</span> <span class="string">一个数组</span></span><br><span class="line">			<span class="attr">不同UserId，HashCode出现HashCode碰撞，稍微出现一点散列，就会出现</span></span><br><span class="line">			<span class="attr">扩充bitMap，处理一亿的数据，相当于全部分散开</span></span><br><span class="line">			<span class="attr">原则：HashFunction选取，BitMap的扩充，碰撞概率无限趋向于零</span></span><br><span class="line">			<span class="attr">布隆过滤器是一个概率性的算法。</span></span><br><span class="line">			<span class="attr">主要问题：hash碰撞</span></span><br><span class="line">			<span class="meta">特点重要重要的一点：Google</span> <span class="string">Grave算法，现成的，传入一个所容忍的碰撞概率，默认是0.03。。。</span></span><br><span class="line">		<span class="attr">不要做Process，定义一个计算规则，每来个计算触发一个计算，连接Redis，中间判断</span></span><br><span class="line">		<span class="attr">以前做一个增量聚合函数也使用过这种思想，但是使用Redis来实现就会有点复杂</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">作为扩展：</span></span><br><span class="line">		<span class="attr">🍙自定义窗口触发器</span></span><br><span class="line">		<span class="attr">🍙Flink自带的布隆过滤器</span></span><br><span class="line">		<span class="attr">🍙MurmurHash</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">如何去计算布隆过滤器的大小：</span></span><br><span class="line">		<span class="attr">一亿数据去重</span></span><br><span class="line">		<span class="attr">2的整数倍大小Mb</span></span><br><span class="line">		<span class="attr">64Mb</span> <span class="string">---&gt; 多少bit</span></span><br><span class="line">		<span class="meta">2^6</span> <span class="string">2^20 2^3 ---&gt; 2^29</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">如何去测试这个布隆过滤器：</span></span><br><span class="line">		<span class="attr">启动./bin/redis.server</span></span><br><span class="line">		<span class="meta">redis-cli</span> <span class="string">-h 192.168.22.140</span></span><br><span class="line">		<span class="attr">然后启动RedisDesktop来进行查看</span></span><br><span class="line">		<span class="meta">启动UvWithBloomFilter</span>	<span class="string"></span></span><br><span class="line">		</span><br><span class="line"><span class="attr">market_analysis</span> <span class="string">模块3</span></span><br><span class="line">	<span class="attr">AppMarketingByChannel</span> <span class="string">按照不同的渠道做的一个市场的推广的统计</span></span><br><span class="line">	<span class="attr">AppMarketingStatistics</span> <span class="string">---&gt; </span></span><br><span class="line">		<span class="attr">keyby</span> <span class="string">---&gt; 不分渠道的市场推广，这个指定的是一个固定的key，就是全量聚合的一个操作</span></span><br><span class="line">		</span><br><span class="line">	<span class="attr">WindowFunction</span></span><br><span class="line">	<span class="attr">ProcessWindowFunction</span></span><br><span class="line">	<span class="meta">主要是有无生命周期</span> <span class="string">context,window ---&gt; 全集和子集的一个概率</span></span><br><span class="line">	<span class="attr">全量和增量的区别的重要性。。。。</span></span><br><span class="line">	</span><br><span class="line">	<span class="meta">市场推广：MarketingUserBehavior</span> <span class="string">| ChannelPromotionCount</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">页面广告投放：</span></span><br><span class="line">		<span class="attr">AdClickEvent</span> <span class="string">| AdCountViewByProvince</span></span><br><span class="line">		<span class="meta">直接统计当前页面的点击，count</span> <span class="string">+ 1</span></span><br><span class="line">		<span class="attr">精细化划分，按照用户的地理位置来进行划分，用户被点击的热门程度是否是和地理位置有关系</span></span><br><span class="line">		<span class="attr">南北差异还是比较大的</span></span><br><span class="line">		<span class="attr">AdStatisticsByProvince</span></span><br><span class="line">		<span class="attr">添加了报警机制，就是刷单的用户行为，定义一个标志状态，保存当前是否已经被发送到了黑名单里面</span></span><br><span class="line">		</span><br><span class="line">	<span class="attr">状态清空处理，注册一个定时器，注册一个第二天零点定时器</span></span><br><span class="line">	<span class="attr">如何去定义一个时间戳，既然是零点，先获取当前的处理时间</span></span><br><span class="line">	<span class="attr">如何拿到第二天零点的数据</span></span><br><span class="line">	<span class="meta">毫秒总数</span> <span class="string">/ </span></span><br><span class="line">	<span class="meta">(ctx.timerService().currentProcessingTime()</span> <span class="string">/ (24*60*60*1000) + 1) * (24*60*60*1000) - 8*60*60*1000;</span></span><br><span class="line">	</span><br><span class="line">	<span class="meta">ctx.timerService().currentProcessingTime()</span> <span class="string">从1970-01-01 到现在的所有毫秒数</span></span><br><span class="line">	<span class="meta">(24*60*60*1000)</span> <span class="string">一天当中的毫秒数</span></span><br><span class="line">	<span class="meta">(ctx.timerService().currentProcessingTime()</span> <span class="string">/ (24*60*60*1000) + 1) 这个是明天的天数</span></span><br><span class="line">	<span class="meta">(ctx.timerService().currentProcessingTime()</span> <span class="string">/ (24*60*60*1000) + 1) * (24*60*60*1000)</span></span><br><span class="line">	<span class="attr">这个是第二天零点的时间戳</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">有时差，伦敦时间的时区</span></span><br><span class="line">	<span class="attr">减去时区</span></span><br><span class="line">	</span><br><span class="line"><span class="attr">LoginFailDetect</span> <span class="string">模块4 </span></span><br><span class="line">	<span class="attr">恶意登录事件</span></span><br><span class="line">	<span class="attr">定义触发器</span></span><br><span class="line">		<span class="attr">等到两秒钟才判断失败次数，这样的话超过上次，两秒钟那种，黑客可以无限的攻击，尽可能快的</span></span><br><span class="line">		<span class="attr">监控到，不一定得要等到两秒钟检测到。。。</span></span><br><span class="line">		<span class="attr">从时效性上来说，需要改进。。。</span></span><br><span class="line">	<span class="attr">对这个实现自定义的监测事件需要继续取优化它。。。</span></span><br><span class="line">	<span class="attr">监控状态一般都是配合那个触发器来结合一起使用</span></span><br><span class="line">	<span class="attr">当前代码的缺陷：如果不是以两秒钟来进行代码监控的话，这样我们的代码逻辑也是需要更改的</span></span><br><span class="line">	<span class="attr">代码的灵活性就比较差，我们没有使用触发器，只是针对于次数来进行监控，这样的时效性要好得多。。。</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">问题就是：</span></span><br><span class="line">		<span class="attr">Flink和触发器的使用心得。。。</span></span><br><span class="line">		<span class="attr">触发器得使用和尽快得得到监测结果，这个一定要注意使用，否则可能会和我们的需求有违背。。。</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">使用CEP来进行风控处理</span></span><br><span class="line">		<span class="attr">乱序顺序的影响，可能会打算我们的影响</span></span><br><span class="line">		<span class="attr">如果使用定时器，也不能解决这个问题，之前做的两种清空，都没有办法处理这些报警</span></span><br><span class="line">		<span class="attr">事件触发的基础上，在去注册一个定时器，按照watermark，42的定时器，等到watermark到达42才能</span></span><br><span class="line">		<span class="attr">触发。处理之前的事件，这样的话就是延迟触发，等待它触发窗口执行。</span></span><br><span class="line">		<span class="attr">采用CEP来检测登录失败的方式要比上面的要简单一点，感受这种使用方式的话要比ProcessFunction要</span></span><br><span class="line">		<span class="attr">简单很多。。。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">CEP</span> <span class="string">复杂事件</span></span><br><span class="line">	<span class="attr">一个或多个由简单构成的事件流通过规则匹配</span></span><br><span class="line">	<span class="attr">Pattern</span> <span class="string">API：</span></span><br><span class="line">		<span class="meta">模式</span> <span class="string">Pattern</span></span><br><span class="line">		<span class="attr">inputStream</span></span><br><span class="line">		<span class="attr">begin</span> <span class="string">next subtype where followBy 没有说必须是严格紧邻</span></span><br><span class="line">	<span class="meta">个体模式</span> <span class="string">组合模式 模式组</span></span><br><span class="line">	<span class="attr">组合模式由限制：必须是pattern.begin</span></span><br><span class="line">	<span class="attr">模式组，模式序列作为条件嵌套在个体模式里面，成为一组模式，整个很复杂，一般是用不到的</span></span><br><span class="line">	<span class="meta">个体模式：singleton</span> <span class="string">looping</span></span><br><span class="line">	<span class="attr">单列模式：当前的模式匹配的就是一个事件，可以检测到多个事件</span></span><br><span class="line">	<span class="attr">循环模式是可以接收多个事件。</span></span><br><span class="line">	<span class="meta">start.times(3).where(new</span> <span class="string">SimpleCondition&lt;Event&gt;)</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">量词：</span></span><br><span class="line">		<span class="meta">times(4)</span> <span class="string">当前模式匹配四次</span></span><br><span class="line">		<span class="meta">times(4).optional</span> <span class="string">可选，匹配出现零次或者四次</span></span><br><span class="line">		<span class="meta">start.times(2,4)</span> <span class="string">匹配2，4次</span></span><br><span class="line">		<span class="meta">start.times(2,4).gredy</span> <span class="string">贪婪模式，尽可能多的匹配</span></span><br><span class="line">		<span class="meta">start.oneOrMore.optional.gredy</span> <span class="string">并且尽可能多的匹配操作：0,2,*</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">CEP底层是NFA是一个状态机的概念或者是架构</span></span><br><span class="line">	</span><br><span class="line">	<span class="meta">简单的提取操作，好多过条件应该怎么办勒，&amp;</span> <span class="string">| ^ 在里面写的可读性比较差</span></span><br><span class="line">	<span class="meta">使用or</span> <span class="string">来 进行可读性的提高的，如果是and ---&gt; where.where</span></span><br><span class="line">	<span class="attr">终止条件</span></span><br><span class="line">		<span class="meta">.until()</span> <span class="string">oneOrMore 可以有多个，检测到一个匹配一个条件的，整个事件是没有完的，符合</span></span><br><span class="line">		<span class="attr">前面的条件就保存到Map事件中，</span></span><br><span class="line">		</span><br><span class="line">	<span class="attr">迭代条件IterCondition</span></span><br><span class="line">	<span class="attr">严格近邻</span></span><br><span class="line">	<span class="attr">宽松近邻</span></span><br><span class="line">	<span class="attr">非确定性宽松近邻</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">订单支付</span> <span class="string">Model 5</span></span><br><span class="line">	<span class="meta">设置失效时间</span> <span class="string">---&gt; Redis 有失效时间，状态保存到Redis中</span></span><br><span class="line">	<span class="attr">查订单，直接去Redis中查看就行，返回订单不能失效的问题</span></span><br><span class="line">	<span class="attr">放到Redis业务系统中，时效性就不是很好，不能很好的展示，想要做到立刻生效，就得轮询</span></span><br><span class="line">	<span class="attr">整个过程在实际中有很多问题。</span></span><br><span class="line">	<span class="meta">解决方案</span> <span class="string">：</span></span><br><span class="line">		<span class="attr">离线处理，实时那边，订单就无法判断，就会出现订单异常</span></span><br><span class="line">		<span class="attr">实时处理，承接业务系统的功能</span></span><br><span class="line">	<span class="attr">订单失效的实时监控：</span></span><br><span class="line">		<span class="attr">1、导入CEP依赖信息</span></span><br><span class="line">		<span class="meta">2、模块处理</span> <span class="string">---&gt; 埋点数据，用户订单里面的信息UserBehavior信息，没有下单和支付</span></span><br><span class="line">		<span class="meta">单独找数据，34729,create,,1558430842</span> <span class="string">---&gt; OrderId,operation,transation_code,timestamp ---&gt;  ETL处理</span></span><br><span class="line">		<span class="attr">OrderEvent</span> <span class="string">---&gt; 设置延迟事件和定时器（15分钟）---&gt; 成功支付（支付超时）---&gt; 很容易实现检测</span></span><br><span class="line">		<span class="attr">orderId</span> <span class="string">当前整个Id失效，超时输出</span></span><br><span class="line">		<span class="attr">OrderEvent</span> <span class="string">---&gt; OrderResult ---&gt; OrderPayTimeOut</span></span><br><span class="line">		<span class="attr">CEP</span> <span class="string">---&gt; 中间就算有乱序是没有影响的，只要判断当前的create pay 只要弄清楚就行，if else</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">ProcessFunction</span> <span class="string">判断超时的检测</span></span><br><span class="line">	<span class="attr">没有CEP的处理方式</span></span><br><span class="line">	<span class="attr">现在开始做超时监测，明天在做。。。</span></span><br><span class="line">	<span class="meta">启动进程：redis</span> <span class="string">kafka flink</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">public</span> <span class="string">static class OrderPayMatchDetect extends KeyedProcessFunction</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">OrderTimeOutOnProcess</span> <span class="string">代码比CEP复杂了，但是可以更控制细粒度得事件。。。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">实时到账</span></span><br><span class="line">	<span class="attr">第三方支付平台，有可能订单的请求会出现数据丢失</span></span><br><span class="line">	<span class="meta">交易码</span>   <span class="string">，渠道 ，  时间</span></span><br><span class="line">	<span class="attr">ewr342as4,wechat,1558430845</span></span><br><span class="line">	<span class="attr">两种情况：</span></span><br><span class="line">		<span class="attr">TxPayMatch</span> <span class="string">对账</span></span><br></pre></td></tr></tbody></table></figure>


                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">情深骚明</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/">http://example.com/2021/06/24/Flink%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%B5%E5%95%86%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%BD%A8%E8%BF%B9%E5%88%86%E6%9E%90/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">情深骚明</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E9%A1%B9%E7%9B%AE/">
                                    <span class="chip bg-color">项目</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2021/06/25/Flink%E9%94%AE%E6%8E%A7%E7%8A%B6%E6%80%81%E5%92%8C%E8%A7%A6%E5%8F%91%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="Flink键控状态和触发器的使用心得">
                        
                        <span class="card-title">Flink键控状态和触发器的使用心得</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-06-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            情深骚明
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/06/24/Flink-sql-note/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Flink-sql-note">
                        
                        <span class="card-title">Flink-sql-note</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-06-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/flink/" class="post-category">
                                    flink
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/flink/">
                        <span class="chip bg-color">flink</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        font-size: 15px;
        color: #42b983;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="436514312"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='false'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">情深骚明</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wmyBigdata-1" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2647716549@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2647716549" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2647716549" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>

    <div class="progress-bar"></div>
          
        <span id="busuanzi_container_site_pv" style='display:none'></span>
            <i class="fa fa-heart-o"></i>
            本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>

    

    
        <span id="busuanzi_container_site_uv" style='display:none'></span>
            人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.

    

    
        <span id="busuanzi_container_site_pv" style='display:none'></span>
        <i class="fa fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
        <span id="busuanzi_value_page_pv" ></span>

    

    <span id="busuanzi_container_site_pv" style='display:none'></span>
    <span id="busuanzi_container_site_uv" style='display:none'></span>
</footer>



    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":0.7}});</script></body>

</html>
